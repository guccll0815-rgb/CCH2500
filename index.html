<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>佳里奇美醫院派車申請系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .disabled-input {
            background-color: #f1f5f9;
            color: #64748b;
            cursor: not-allowed;
        }
        .request-card {
            transition: all 0.2s ease-in-out;
        }
        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
            text-transform: uppercase;
        }
        /* Status Colors - Taiwanese (Mandarin) */
        .status-badge[data-status="待申請單位主管簽核"] { background-color: #e0e7ff; color: #3730a3; } /* Manager Approval Pending */
        .status-badge[data-status="主管退回"] { background-color: #FEF9C3; color: #713F12; } /* Manager Rejected */
        .status-badge[data-status="待管理單位處理"] { background-color: #fef3c7; color: #92400e; } /* Pending Dispatch */
        .status-badge[data-status="已派車"] { background-color: #d1fae5; color: #065f46; } /* Dispatched */
        .status-badge[data-status="案件取消"] { background-color: #fee2e2; color: #991b1b; } /* Cancelled */
        .status-badge[data-status="無法派車"] { background-color: #e5e7eb; color: #4b5563; } /* Rejected */
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes pulse-badge {
            50% { opacity: .6; }
        }
        .animate-pulse-badge {
            animation: pulse-badge 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .tab-btn {
            padding: 0.75rem 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }
        .tab-btn:hover {
            background-color: #f3f4f6;
        }
        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="w-full max-w-5xl mx-auto p-4 sm:p-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <img src="https://placehold.co/60x60/3b82f6/ffffff?text=C+H" alt="奇美醫院 Logo" class="h-12 sm:h-16 rounded-lg">
                <h1 class="text-xl sm:text-3xl font-bold text-gray-800">派車申請系統</h1>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex flex-wrap border-b border-gray-200 bg-white rounded-t-lg">
            <button data-tab="apply" class="tab-btn active text-sm sm:text-base font-medium">填寫申請</button>
            <button data-tab="search" class="tab-btn text-sm sm:text-base font-medium">查詢狀態</button>
            <button data-tab="admin" class="tab-btn flex items-center text-sm sm:text-base font-medium">
                管理後台
                <span id="pending-count" class="ml-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"></span>
            </button>
            <button data-tab="stats" class="tab-btn text-sm sm:text-base font-medium">統計分析</button>
        </nav>

        <main>
            <!-- Apply Tab -->
            <div id="tab-content-apply" class="tab-content bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <form id="dispatchForm" class="space-y-6">
                    <input type="hidden" id="request-id">
                    <!-- Form Fields Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-6 border-t border-b border-gray-200 py-6">
                        <div class="lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700">院區 <span class="text-red-500">*</span></label>
                            <div id="branch-options" class="mt-2 flex flex-wrap items-center gap-4 sm:gap-6 text-sm sm:text-base text-gray-700">
                                <label class="flex items-center space-x-2"><input type="checkbox" name="branch" value="永康院區" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span>永康院區</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" name="branch" value="柳營院區" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span>柳營院區</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" name="branch" value="佳里院區" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span>佳里院區</span></label>
                            </div>
                        </div>
                        <div><label for="reason" class="block text-sm font-medium text-gray-700">用車事由 <span class="text-red-500">*</span></label><input type="text" id="reason" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label class="block text-sm font-medium text-gray-700">車輛種類 <span class="text-red-500">*</span></label><div class="mt-2 flex items-center space-x-6 text-sm sm:text-base"><label class="flex items-center space-x-2"><input type="radio" name="vehicle_type" value="中巴" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><span>中巴</span></label><label class="flex items-center space-x-2"><input type="radio" name="vehicle_type" value="小客" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><span>小客</span></label><label class="flex items-center space-x-2"><input type="radio" name="vehicle_type" value="其他" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><span>其他</span></label></div></div>
                        <div><label for="destination" class="block text-sm font-medium text-gray-700">駛達地點 <span class="text-red-500">*</span></label><input type="text" id="destination" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="passengers" class="block text-sm font-medium text-gray-700">搭乘人數 <span class="text-red-500">*</span></label><input type="number" id="passengers" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="start_time" class="block text-sm font-medium text-gray-700">預定派車時間 (起) <span class="text-red-500">*</span></label><input type="datetime-local" id="start_time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                        <div><label for="end_time" class="block text-sm font-medium text-gray-700">預定派車時間 (迄) <span class="text-red-500">*</span></label><input type="datetime-local" id="end_time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                        <div><label for="applicant_unit" class="block text-sm font-medium text-gray-700">申請單位 <span class="text-red-500">*</span></label><input type="text" id="applicant_unit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="cost_code" class="block text-sm font-medium text-gray-700">費用部門代號</label><input type="text" id="cost_code" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="extension" class="block text-sm font-medium text-gray-700">聯絡分機 <span class="text-red-500">*</span></label><input type="text" id="extension" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="contact_group" class="block text-sm font-medium text-gray-700">聯絡群組</label><input type="text" id="contact_group" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div class="md:col-span-2"><label for="applicant_name" class="block text-sm font-medium text-gray-700">申請人姓名 <span class="text-red-500">*</span></label><input type="text" id="applicant_name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="請輸入姓名"></div>
                        <div class="lg:col-span-3">
                            <label for="remarks" class="block text-sm font-medium text-gray-700">備註</label>
                            <textarea id="remarks" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="若有特殊需求請在此說明..."></textarea>
                        </div>
                    </div>
                    
                    <div id="admin-section" class="hidden border-t border-gray-200 pt-6 mt-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">承辦單位處理狀況</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div>
                                <label for="display_request_id" class="block text-sm font-medium text-gray-700">申請單號</label>
                                <input type="text" id="display_request_id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input" readonly>
                            </div>
                            <div>
                                <label for="dispatch_status" class="block text-sm font-medium text-gray-700">處理狀況</label>
                                <select id="dispatch_status" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="待申請單位主管簽核">待申請單位主管簽核</option>
                                    <option value="主管退回">主管退回</option>
                                    <option value="待管理單位處理">待管理單位處理</option>
                                    <option value="已派車">已派車</option>
                                    <option value="案件取消">案件取消</option>
                                    <option value="無法派車">無法派車</option>
                                </select>
                            </div>
                            <div>
                                <label for="approving_manager" class="block text-sm font-medium text-gray-700">簽核主管</label>
                                <input type="text" id="approving_manager" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input" readonly>
                            </div>
                            <div>
                                <label for="dispatch_method" class="block text-sm font-medium text-gray-700">派車方式</label>
                                <input type="text" id="dispatch_method" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                             <div>
                                <label for="driver_name" class="block text-sm font-medium text-gray-700">司機姓名</label>
                                <input type="text" id="driver_name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                             <div>
                                <label for="driver_phone" class="block text-sm font-medium text-gray-700">司機電話</label>
                                <input type="text" id="driver_phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div class="md:col-span-2">
                                <label for="admin_remarks" class="block text-sm font-medium text-gray-700">承辦備註</label>
                                <textarea id="admin_remarks" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                            </div>
                        </div>
                    </div>

                    <div id="manager-action-btns" class="pt-6 text-center flex items-center justify-center space-x-4 hidden">
                        <button type="button" id="manager-cancel-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-8 border border-gray-300 shadow-sm text-base font-medium rounded-full text-gray-700 bg-white hover:bg-gray-50">申請人取消</button>
                        <button type="button" id="manager-reject-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-12 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">退回</button>
                        <button type="button" id="manager-approve-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-12 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">通過</button>
                    </div>
                    
                    <div id="applicant-action-btns" class="pt-6 text-center flex items-center justify-center space-x-4">
                        <button type="submit" id="submit-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-12 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">提交新申請</button>
                        <button type="button" id="clear-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-8 border border-gray-300 shadow-sm text-base font-medium rounded-full text-gray-700 bg-white hover:bg-gray-50">清空表單</button>
                    </div>
                </form>
            </div>

            <!-- Search Tab -->
            <div id="tab-content-search" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-6">查詢申請狀態</h2>
                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-2 mb-6">
                    <input type="text" id="search-input" placeholder="請輸入申請人姓名或申請單號進行查詢..." class="flex-grow block w-full px-4 py-2 bg-white border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <button id="search-btn" class="w-full sm:w-auto py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">查詢</button>
                </div>
                <div id="search-results" class="space-y-4">
                    <p class="text-center text-gray-500">請輸入姓名或單號以查詢您的申請記錄。</p>
                </div>
            </div>

            <!-- Admin Tab -->
            <div id="tab-content-admin" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <div id="admin-view" class="hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4 gap-4">
                        <div class="flex items-center gap-2">
                            <h2 class="text-xl font-bold text-gray-800">所有派車申請</h2>
                            <button id="refresh-admin-list-btn" title="重新整理" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="w-5 h-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.691V5.25a8.25 8.25 0 00-11.664 0v4.992m11.664 0l-3.181-3.183" />
                                </svg>
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                             <input type="text" id="admin-search-input" placeholder="依申請單號查詢..." class="w-full sm:w-auto px-4 py-2 bg-white border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button id="logout-btn" class="py-2 px-4 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">登出</button>
                    </div>
                    <div id="requests-list" class="space-y-4">
                        <!-- Requests will be injected here by Firestore -->
                    </div>
                </div>
                 <div id="admin-login-prompt" class="text-center py-10">
                    <p class="text-gray-600">此為管理員專區，請先登入。</p>
                    <button id="admin-login-prompt-btn" class="mt-4 py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">立即登入</button>
                </div>
            </div>

            <!-- Stats Tab -->
            <div id="tab-content-stats" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <div id="stats-view" class="hidden">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                         <h2 class="text-xl font-bold text-gray-800">數據統計分析</h2>
                         <button id="export-excel-btn" class="py-2 px-4 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">匯出 Excel</button>
                    </div>

                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 p-4 bg-gray-50 rounded-lg">
                         <div class="flex items-center gap-2">
                             <label for="stats-month-filter" class="text-sm font-medium text-gray-700">篩選月份:</label>
                             <input type="month" id="stats-month-filter" class="border-gray-300 rounded-md shadow-sm p-2">
                         </div>
                         <div class="flex gap-4 text-center">
                             <div class="p-2">
                                 <p class="text-2xl font-bold text-blue-600" id="stats-total-requests">0</p>
                                 <p class="text-sm font-medium text-gray-500">總申請筆數</p>
                             </div>
                         </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                         <div class="p-4 border rounded-lg lg:col-span-2">
                             <h3 class="text-center font-semibold mb-4 text-gray-700">各司機趟次統計</h3>
                             <canvas id="driver-chart"></canvas>
                         </div>
                         <div class="p-4 border rounded-lg"><h3 class="text-center font-semibold mb-4 text-gray-700">申請狀態分佈</h3><canvas id="status-chart"></canvas></div>
                         <div class="p-4 border rounded-lg"><h3 class="text-center font-semibold mb-4 text-gray-700">各院區申請量</h3><canvas id="branch-chart"></canvas></div>
                    </div>
                </div>
                 <div id="stats-login-prompt" class="text-center py-10">
                    <p class="text-gray-600">此為管理員專區，請先登入查看統計數據。</p>
                    <button id="stats-login-prompt-btn" class="mt-4 py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">立即登入</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Custom Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all">
            <h3 id="modal-title" class="text-lg font-medium text-gray-900">通知</h3>
            <div id="modal-content" class="mt-2 text-sm text-gray-600"></div>
            <div id="modal-buttons" class="mt-5 sm:mt-6 flex justify-end space-x-3"></div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, serverTimestamp, setLogLevel, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION AND INITIALIZATION ---
        // Global variables provided by the environment (using provided config)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            // NOTE: Using the user's hardcoded config for external deployment consistency.
            apiKey: "AIzaSyAs3v-BU5Hfh7HZitHdL5yI2FKZrI_Q4zI",
            authDomain: "cch2500-5bbb6.firebaseapp.com",
            projectId: "cch2500-5bbb6",
            storageBucket: "cch2500-5bbb6.firebasestorage.app",
            messagingSenderId: "223711217941",
            appId: "1:223711217941:web:f14461ad89c0f9ca01c11c",
            measurementId: "G-59DEQT7HT0"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug');
        
        // Firestore Collection Path (Public Data)
        const REQUESTS_COLLECTION = `/artifacts/${appId}/public/data/dispatch_requests`;

        // Hardcoded Admin Credentials (For Demonstration/Testing ONLY)
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'password';

        // --- AUTHENTICATION LOGIC ---
        async function authenticateUser() {
            try {
                // Check if the custom token exists and is not null/empty
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Authenticated with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Authenticated anonymously.");
                }
            } catch (error) {
                // If custom token fails (e.g., project mismatch), try to sign in anonymously as fallback
                console.error("Firebase Authentication failed (Custom Token Mismatch expected in external host):", error);
                try {
                    await signInAnonymously(auth);
                    console.log("Falling back to anonymous authentication.");
                } catch (anonError) {
                    console.error("Anonymous authentication also failed:", anonError);
                }
            }
        }
        
        // --- UTILITY FUNCTIONS ---
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(window.location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }

        // --- MODAL ELEMENTS & FUNCTIONS (COMPLETED) ---
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalButtons = document.getElementById('modal-buttons');

        function hideModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }
        
        function showAlert(message, title = '通知') { 
            modalTitle.textContent = title;
            modalContent.innerHTML = `<p>${message}</p>`;
            modalButtons.innerHTML = `<button id="modal-ok-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">確定</button>`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            const okBtn = document.getElementById('modal-ok-btn');
            okBtn.onclick = hideModal;
            okBtn.focus();
        }
        
        function showSuccessWithLink(message, link) {
            modalTitle.textContent = '申請成功';
            modalContent.innerHTML = `
                <p>${message}</p>
                <div class="mt-4">
                    <label for="approval-link" class="block text-sm font-medium text-gray-700 text-left">專屬簽核連結</label>
                    <input type="text" id="approval-link" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" value="${link}">
                </div>
            `;
            modalButtons.innerHTML = `
                <button id="modal-copy-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">複製連結</button>
                <button id="modal-close-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">關閉</button>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            const copyBtn = document.getElementById('modal-copy-btn');
            const closeBtn = document.getElementById('modal-close-btn');
            const linkInput = document.getElementById('approval-link');

            copyBtn.onclick = () => {
                linkInput.select();
                document.execCommand('copy');
                showAlert('連結已複製到剪貼簿！', '複製成功');
                linkInput.blur(); // Remove focus after copying
            };
            closeBtn.onclick = hideModal;
        }

        function showConfirm(message, callback, title = '確認操作') {
            modalTitle.textContent = title;
            modalContent.innerHTML = `<p>${message}</p>`;
            modalButtons.innerHTML = `
                <button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">取消</button>
                <button id="modal-confirm-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none">確定</button>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            confirmBtn.onclick = () => { hideModal(); if (callback) callback(true); };
            cancelBtn.onclick = () => { hideModal(); if (callback) callback(false); };
            confirmBtn.focus();
        }
        
        // *** COMPLETED MISSING CODE FOR promptLogin ***
        function promptLogin() {
            modalTitle.textContent = '管理員登入';
            modalContent.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label for="modal-username" class="block text-sm font-medium text-gray-700 text-left">帳號</label>
                        <input type="text" id="modal-username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="modal-password" class="block text-sm font-medium text-gray-700 text-left">密碼</label>
                        <input type="password" id="modal-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            `;
            modalButtons.innerHTML = `
                <button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">取消</button>
                <button id="modal-login-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">登入</button>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            const loginBtn = document.getElementById('modal-login-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const usernameInput = document.getElementById('modal-username');
            const passwordInput = document.getElementById('modal-password');

            const handleLogin = () => {
                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();
                if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                    hideModal();
                    state.isLoggedIn = true;
                    updateAdminUI();
                    showAlert('管理員登入成功！');
                    // Force the Admin tab to be active after login
                    setActiveTab('admin'); 
                } else {
                    showAlert('帳號或密碼錯誤。', '登入失敗');
                    usernameInput.classList.add('animate-shake');
                    setTimeout(() => usernameInput.classList.remove('animate-shake'), 500);
                }
            };

            loginBtn.onclick = handleLogin;
            cancelBtn.onclick = hideModal;
            passwordInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleLogin(); });
            usernameInput.focus();
        }


        // --- CACHE ELEMENTS ---
        const form = document.getElementById('dispatchForm');
        const logoutBtn = document.getElementById('logout-btn');
        const submitBtn = document.getElementById('submit-btn');
        const clearBtn = document.getElementById('clear-btn');
        const requestIdInput = document.getElementById('request-id');
        const adminSection = document.getElementById('admin-section');
        const displayRequestId = document.getElementById('display_request_id');
        const dispatchStatusSelect = document.getElementById('dispatch_status');
        const approvingManagerInput = document.getElementById('approving_manager');
        const adminFields = ['dispatch_method', 'driver_name', 'driver_phone', 'admin_remarks'].map(id => document.getElementById(id));
        
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        const adminView = document.getElementById('admin-view');
        const adminLoginPrompt = document.getElementById('admin-login-prompt');
        const adminLoginPromptBtn = document.getElementById('admin-login-prompt-btn');
        const requestsList = document.getElementById('requests-list');
        const pendingCountBadge = document.getElementById('pending-count');
        
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchResults = document.getElementById('search-results');
        const adminSearchInput = document.getElementById('admin-search-input');
        const refreshAdminListBtn = document.getElementById('refresh-admin-list-btn');

        const statsView = document.getElementById('stats-view');
        const statsLoginPrompt = document.getElementById('stats-login-prompt');
        const managerActionBtns = document.getElementById('manager-action-btns');
        const applicantActionBtns = document.getElementById('applicant-action-btns');

        // --- STATE ---
        const state = {
            isAuthReady: false,
            isLoggedIn: false, // Tracks hardcoded 'admin' login for UI access
            requests: [], // All requests from Firestore
            editingRequestId: null,
            activeTab: 'apply',
            db: db, // Firestore instance
            auth: auth, // Auth instance
            userId: null, 
            deepLinkedRequestId: getUrlParameter('requestId'), // Get ID from URL
        };

        let statusChartInstance, branchChartInstance, driverChartInstance;
        
        // --- UI & TAB MANAGEMENT ---
        function setActiveTab(tabName) {
            state.activeTab = tabName;
            tabButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            tabContents.forEach(content => {
                content.classList.toggle('hidden', content.id !== `tab-content-${tabName}`);
            });
            
            // Special logic for admin/stats tabs
            if (tabName === 'admin' || tabName === 'stats') {
                updateAdminUI();
            }
            if (tabName === 'stats' && state.isLoggedIn) {
                renderStats();
            }
            if (tabName === 'search') {
                searchResults.innerHTML = '<p class="text-center text-gray-500">請輸入姓名或單號以查詢您的申請記錄。</p>';
            }
        }
        
        function updateAdminUI() {
            // Admin Tab UI
            if (state.activeTab === 'admin') {
                adminView.classList.toggle('hidden', !state.isLoggedIn);
                adminLoginPrompt.classList.toggle('hidden', state.isLoggedIn);
            }
            // Stats Tab UI
            if (state.activeTab === 'stats') {
                statsView.classList.toggle('hidden', !state.isLoggedIn);
                statsLoginPrompt.classList.toggle('hidden', state.isLoggedIn);
            }
            // If logged in, the tab is visible, otherwise it prompts login
            if (state.isLoggedIn && state.requests.length > 0) {
                 const pendingCount = state.requests.filter(r => r.status === '待申請單位主管簽核' || r.status === '待管理單位處理').length;
                 pendingCountBadge.textContent = pendingCount;
                 pendingCountBadge.classList.toggle('hidden', pendingCount === 0);
                 pendingCountBadge.classList.add('animate-pulse-badge');
            } else {
                 pendingCountBadge.classList.add('hidden');
                 pendingCountBadge.classList.remove('animate-pulse-badge');
            }
        }

        function toggleFormMode(mode) {
            // mode: 'apply', 'view', 'manager', 'admin'
            if (mode === 'apply') {
                adminSection.classList.add('hidden');
                managerActionBtns.classList.add('hidden');
                applicantActionBtns.classList.remove('hidden');
                submitBtn.textContent = '提交新申請';
                // Enable all standard input fields
                document.querySelectorAll('#dispatchForm input, #dispatchForm select, #dispatchForm textarea').forEach(el => {
                    if (el.id !== 'request-id' && el.id !== 'display_request_id') {
                        el.disabled = false;
                        el.classList.remove('disabled-input');
                    }
                });
            } else if (mode === 'view' || mode === 'manager' || mode === 'admin') {
                // Disable standard fields for viewing/approval
                document.querySelectorAll('#dispatchForm input, #dispatchForm select, #dispatchForm textarea').forEach(el => {
                    if (el.id !== 'request-id' && el.id !== 'display_request_id') {
                        el.disabled = true;
                        el.classList.add('disabled-input');
                    }
                });
                
                // Show relevant action buttons
                applicantActionBtns.classList.add('hidden');
                adminSection.classList.toggle('hidden', mode !== 'admin');
                managerActionBtns.classList.toggle('hidden', mode !== 'manager' && mode !== 'admin');

                // Enable admin/manager-specific fields if needed
                if (mode === 'manager') {
                     // Manager can only approve/reject, no input fields enabled
                     adminSection.classList.add('hidden');
                } else if (mode === 'admin') {
                    adminSection.classList.remove('hidden');
                    dispatchStatusSelect.disabled = false;
                    dispatchStatusSelect.classList.remove('disabled-input');
                    adminFields.forEach(el => {
                         el.disabled = false;
                         el.classList.remove('disabled-input');
                    });
                    submitBtn.textContent = '更新派車狀態'; // Change button text for admin mode
                    applicantActionBtns.classList.remove('hidden');
                } else { // view mode
                    adminSection.classList.add('hidden');
                    managerActionBtns.classList.add('hidden');
                }
            }
        }

        // --- DATA BINDING & HANDLERS ---
        
        function populateForm(request) {
            clearForm();
            if (!request) {
                showAlert('查無此申請單或單號無效。', '錯誤');
                toggleFormMode('apply');
                return;
            }
            
            requestIdInput.value = request.id;
            displayRequestId.value = request.id;
            state.editingRequestId = request.id;

            // Basic Fields
            document.getElementById('reason').value = request.reason || '';
            document.getElementById('destination').value = request.destination || '';
            document.getElementById('passengers').value = request.passengers || '';
            document.getElementById('applicant_unit').value = request.applicant_unit || '';
            document.getElementById('cost_code').value = request.cost_code || '';
            document.getElementById('extension').value = request.extension || '';
            document.getElementById('contact_group').value = request.contact_group || '';
            document.getElementById('applicant_name').value = request.applicant_name || '';
            document.getElementById('remarks').value = request.remarks || '';

            // Datetime Fields (format for datetime-local input)
            const formatForInput = (timestamp) => {
                 if (!timestamp) return '';
                 const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                 const Y = date.getFullYear();
                 const M = String(date.getMonth() + 1).padStart(2, '0');
                 const D = String(date.getDate()).padStart(2, '0');
                 const h = String(date.getHours()).padStart(2, '0');
                 const m = String(date.getMinutes()).padStart(2, '0');
                 return `${Y}-${M}-${D}T${h}:${m}`;
            }
            document.getElementById('start_time').value = formatForInput(request.start_time);
            document.getElementById('end_time').value = formatForInput(request.end_time);

            // Checkbox/Radio Fields
            document.querySelectorAll('input[name="branch"]').forEach(el => {
                el.checked = request.branch && request.branch.includes(el.value);
            });
            document.querySelectorAll('input[name="vehicle_type"]').forEach(el => {
                el.checked = el.value === request.vehicle_type;
            });
            
            // Admin/Dispatch Fields
            dispatchStatusSelect.value = request.status || '待申請單位主管簽核';
            approvingManagerInput.value = request.approving_manager || 'N/A';
            document.getElementById('dispatch_method').value = request.dispatch_method || '';
            document.getElementById('driver_name').value = request.driver_name || '';
            document.getElementById('driver_phone').value = request.driver_phone || '';
            document.getElementById('admin_remarks').value = request.admin_remarks || '';
            
            // Determine the form mode
            if (state.activeTab === 'admin' && state.isLoggedIn) {
                toggleFormMode('admin');
            } else if (request.status === '待申請單位主管簽核' && state.deepLinkedRequestId === request.id) {
                // If it's a deep link and pending approval, enter manager mode
                toggleFormMode('manager');
            } else {
                toggleFormMode('view'); // Otherwise, it's just read-only view
            }

            // Scroll to the top of the form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function clearForm() {
            form.reset();
            requestIdInput.value = '';
            displayRequestId.value = '';
            approvingManagerInput.value = '';
            state.editingRequestId = null;
            toggleFormMode('apply');
        }

        async function submitForm(e) {
            e.preventDefault();

            // Validation (same as your original)
            const requiredFields = ['reason', 'destination', 'passengers', 'start_time', 'end_time', 'applicant_unit', 'extension', 'applicant_name'];
            let isValid = true;
            requiredFields.forEach(id => {
                const input = document.getElementById(id);
                if (!input.value) {
                    input.classList.add('border-red-500', 'animate-shake');
                    setTimeout(() => input.classList.remove('border-red-500', 'animate-shake'), 500);
                    isValid = false;
                }
            });
            
            const selectedBranches = Array.from(document.querySelectorAll('input[name="branch"]:checked')).map(el => el.value);
            if (selectedBranches.length === 0) {
                document.getElementById('branch-options').classList.add('border', 'border-red-500', 'rounded-md', 'p-2', 'animate-shake');
                setTimeout(() => document.getElementById('branch-options').classList.remove('border', 'border-red-500', 'rounded-md', 'p-2', 'animate-shake'), 500);
                isValid = false;
            }

            const selectedVehicleType = document.querySelector('input[name="vehicle_type"]:checked');
            if (!selectedVehicleType) {
                 // No easy way to shake radio buttons, just show alert
                 isValid = false;
                 showAlert('請選擇車輛種類。', '欄位未填寫');
            }
            
            if (!isValid) {
                showAlert('請填寫所有必填欄位。', '欄位未填寫');
                return;
            }

            // Collect data
            const formData = {
                reason: document.getElementById('reason').value,
                vehicle_type: selectedVehicleType.value,
                destination: document.getElementById('destination').value,
                passengers: parseInt(document.getElementById('passengers').value, 10),
                start_time: new Date(document.getElementById('start_time').value),
                end_time: new Date(document.getElementById('end_time').value),
                applicant_unit: document.getElementById('applicant_unit').value,
                cost_code: document.getElementById('cost_code').value,
                extension: document.getElementById('extension').value,
                contact_group: document.getElementById('contact_group').value,
                applicant_name: document.getElementById('applicant_name').value,
                remarks: document.getElementById('remarks').value,
                branch: selectedBranches,
                applicant_id: state.userId,
            };

            const isUpdate = state.editingRequestId !== null;

            if (isUpdate && state.isLoggedIn) {
                // Admin Update Mode
                 const updateData = {
                    ...formData,
                    dispatch_status: dispatchStatusSelect.value, // Note: your schema uses 'status' not 'dispatch_status' for the main status field
                    status: dispatchStatusSelect.value, // Using 'status' for consistency with filtering
                    dispatch_method: document.getElementById('dispatch_method').value,
                    driver_name: document.getElementById('driver_name').value,
                    driver_phone: document.getElementById('driver_phone').value,
                    admin_remarks: document.getElementById('admin_remarks').value,
                    updated_at: serverTimestamp(),
                 };
                await updateRequest(state.editingRequestId, updateData);
                showAlert('申請單 (單號: ' + state.editingRequestId + ') 狀態已更新！', '更新成功');
                clearForm();
                setActiveTab('admin');
                
            } else if (isUpdate) {
                // Only applicants can update if it's not admin mode
                 showAlert('您無法修改這張已提交的申請單。', '權限不足');
                 return;

            } else {
                // New Request Submission
                const requestData = {
                    ...formData,
                    status: '待申請單位主管簽核', // Initial status
                    approving_manager: '', // Manager name placeholder
                    dispatch_method: '',
                    driver_name: '',
                    driver_phone: '',
                    admin_remarks: '',
                    created_at: serverTimestamp(),
                };

                try {
                    const docRef = await addDoc(collection(db, REQUESTS_COLLECTION), requestData);
                    const approvalLink = window.location.origin + window.location.pathname + '?requestId=' + docRef.id;
                    showSuccessWithLink('您的派車申請已成功提交，請將以下簽核連結傳送給您的主管進行簽核。', approvalLink);
                    clearForm();
                } catch (error) {
                    console.error("Error adding document: ", error);
                    showAlert(`提交申請失敗：${error.message}`, '錯誤');
                }
            }
        }
        
        // --- DEEP LINK HANDLER ---
        async function loadRequestForEditing(requestId) {
            try {
                const docRef = doc(db, REQUESTS_COLLECTION, requestId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const request = { id: docSnap.id, ...docSnap.data() };
                    setActiveTab('apply');
                    populateForm(request);
                } else {
                    showAlert('找不到指定的申請單。請檢查單號是否正確。', '查詢錯誤');
                }
            } catch (error) {
                console.error("Error loading deep-linked document:", error);
                showAlert(`載入申請單時發生錯誤：${error.message}`, '系統錯誤');
            }
        }

        // --- FIREBASE CRUD & LISTENERS ---

        /** Updates the request with new data. */
        async function updateRequest(id, data) {
             if (!state.isAuthReady) {
                 showAlert('Firebase 驗證尚未完成，請稍候再試。', '系統忙碌');
                 return;
             }
             try {
                 const docRef = doc(db, REQUESTS_COLLECTION, id);
                 await updateDoc(docRef, data);
                 console.log(`Request ${id} updated.`);
                 // Clear the deep link after action to revert to default state
                 state.deepLinkedRequestId = null;
             } catch (error) {
                 console.error("Error updating document: ", error);
                 showAlert(`更新申請單失敗：${error.message}`, '錯誤');
             }
        }

        /** Handles manager approval action */
        document.getElementById('manager-approve-btn').onclick = () => {
             if (!state.editingRequestId) return;
             showConfirm('確定要通過這筆申請單嗎？', async (confirmed) => {
                 if (confirmed) {
                     const managerName = document.getElementById('applicant_name').value + ' (主管)'; // Use applicant name for placeholder
                     await updateRequest(state.editingRequestId, {
                         status: '待管理單位處理',
                         approving_manager: managerName,
                         updated_at: serverTimestamp(),
                     });
                     showAlert(`申請單 (單號: ${state.editingRequestId}) 已成功核准，請等待管理單位處理。`, '核准成功');
                     clearForm();
                 }
             }, '主管簽核');
        };
        
        /** Handles manager reject action */
        document.getElementById('manager-reject-btn').onclick = () => {
             if (!state.editingRequestId) return;
             showConfirm('確定要退回這筆申請單嗎？', async (confirmed) => {
                 if (confirmed) {
                     const managerName = document.getElementById('applicant_name').value + ' (主管)'; 
                     await updateRequest(state.editingRequestId, {
                         status: '主管退回',
                         approving_manager: managerName,
                         updated_at: serverTimestamp(),
                     });
                     showAlert(`申請單 (單號: ${state.editingRequestId}) 已被退回。`, '退回成功');
                     clearForm();
                 }
             }, '主管退回');
        };
        
        /** Handles applicant cancel action (for both manager view and general view if pending) */
        document.getElementById('manager-cancel-btn').onclick = () => {
            if (!state.editingRequestId) return;
            const currentRequest = state.requests.find(r => r.id === state.editingRequestId);
            
            if (currentRequest && currentRequest.status !== '待申請單位主管簽核') {
                 // In admin/view mode, cancel is only allowed if status is pending manager
                 if (state.activeTab !== 'admin') {
                      showAlert(`此申請單目前狀態為【${currentRequest.status}】，無法由申請人取消。`, '取消失敗');
                      return;
                 }
            }
            
            showConfirm('確定要取消這筆派車申請嗎？', async (confirmed) => {
                if (confirmed) {
                    await updateRequest(state.editingRequestId, {
                        status: '案件取消',
                        updated_at: serverTimestamp(),
                    });
                    showAlert(`申請單 (單號: ${state.editingRequestId}) 已取消。`, '取消成功');
                    clearForm();
                }
            }, '取消確認');
        };

        // Real-time listener for ALL requests (Admin/Stats usage)
        function setupRealtimeListener() {
            const q = query(collection(db, REQUESTS_COLLECTION));
            
            onSnapshot(q, (snapshot) => {
                const updatedRequests = [];
                snapshot.forEach((doc) => {
                    updatedRequests.push({ id: doc.id, ...doc.data() });
                });
                state.requests = updatedRequests;
                renderRequestsList(state.requests);
                updateAdminUI(); // Update badges/login views

                // After receiving updates, if we have a deep-linked ID, try to load it again
                if (state.deepLinkedRequestId) {
                    const linkedRequest = state.requests.find(r => r.id === state.deepLinkedRequestId);
                    if (linkedRequest) {
                        populateForm(linkedRequest);
                    } else {
                        // If it fails to load after initial snapshot, try a specific fetch.
                        loadRequestForEditing(state.deepLinkedRequestId); 
                    }
                }
            }, (error) => {
                console.error("Error fetching requests: ", error);
                showAlert(`無法載入申請列表：${error.message}`, '資料庫錯誤');
            });
        }
        
        // Render functions for Admin/Search Tabs
        function renderRequestsList(requests) {
             const filterText = adminSearchInput.value.trim().toLowerCase();
             const filteredRequests = requests.filter(r => 
                 !filterText || r.id.toLowerCase().includes(filterText) || 
                 r.applicant_name.toLowerCase().includes(filterText) ||
                 r.applicant_unit.toLowerCase().includes(filterText)
             );

             requestsList.innerHTML = filteredRequests.length === 0 
                ? '<p class="text-center text-gray-500 py-10">查無任何申請記錄。</p>' 
                : filteredRequests.map(request => createRequestCard(request, true)).join('');
        }
        
        function renderSearchResults(requests) {
             if (requests.length === 0) {
                 searchResults.innerHTML = '<p class="text-center text-gray-500 py-4">找不到符合條件的申請記錄。</p>';
                 return;
             }
             searchResults.innerHTML = requests.map(request => createRequestCard(request, false)).join('');
        }

        function createRequestCard(request, isAdminView) {
            const displayId = request.id.substring(0, 8);
            const statusBadge = `<span class="status-badge" data-status="${request.status}">${request.status}</span>`;
            const dateStr = formatTimestamp(request.created_at);
            const timeRange = `${formatTimestamp(request.start_time).split(' ')[1]} - ${formatTimestamp(request.end_time).split(' ')[1]}`;
            
            const actionButton = isAdminView 
                ? `<button data-id="${request.id}" class="view-admin-btn mt-2 sm:mt-0 w-full sm:w-auto py-2 px-4 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">處理/檢視</button>`
                : `<button data-id="${request.id}" class="view-applicant-btn mt-2 sm:mt-0 w-full sm:w-auto py-2 px-4 bg-gray-600 text-white rounded-lg text-sm font-medium hover:bg-gray-700">查看詳情</button>`;

            return `
                <div class="request-card bg-white p-4 border border-gray-200 rounded-xl shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div class="space-y-1 sm:space-y-0 w-full sm:w-auto">
                        <div class="flex items-center space-x-2">
                             <span class="text-xs font-semibold text-gray-400">#${displayId}</span>
                            ${statusBadge}
                        </div>
                        <p class="text-lg font-semibold text-gray-800">${request.reason} <span class="text-sm font-normal text-gray-500">(${request.applicant_name})</span></p>
                        <p class="text-sm text-gray-600"><strong>單位:</strong> ${request.applicant_unit} | <strong>時間:</strong> ${dateStr.split(' ')[0]} ${timeRange}</p>
                    </div>
                    ${actionButton}
                </div>
            `;
        }

        // --- STATS LOGIC ---
        function renderStats() {
            if (!state.isLoggedIn || state.requests.length === 0) return;
            
            const currentMonth = statsMonthFilter.value || new Date().toISOString().substring(0, 7);
            
            const monthlyRequests = state.requests.filter(r => {
                 if (!r.created_at) return false;
                 const date = r.created_at.toDate ? r.created_at.toDate() : new Date(r.created_at);
                 return date.toISOString().startsWith(currentMonth);
            });
            
            statsTotalRequests.textContent = monthlyRequests.length;
            
            // 1. Status Chart
            const statusCounts = monthlyRequests.reduce((acc, r) => {
                 acc[r.status] = (acc[r.status] || 0) + 1;
                 return acc;
            }, {});
            const statusLabels = Object.keys(statusCounts);
            const statusData = Object.values(statusCounts);
            
            if (statusChartInstance) statusChartInstance.destroy();
            statusChartInstance = new Chart(document.getElementById('status-chart'), {
                 type: 'doughnut',
                 data: {
                     labels: statusLabels,
                     datasets: [{
                         data: statusData,
                         backgroundColor: ['#e0e7ff', '#FEF9C3', '#fef3c7', '#d1fae5', '#fee2e2', '#e5e7eb'],
                     }]
                 },
                 options: { responsive: true, maintainAspectRatio: false }
            });

            // 2. Branch Chart
            const branchCounts = monthlyRequests.flatMap(r => r.branch || []).reduce((acc, b) => {
                 acc[b] = (acc[b] || 0) + 1;
                 return acc;
            }, {});
            const branchLabels = Object.keys(branchCounts);
            const branchData = Object.values(branchCounts);

            if (branchChartInstance) branchChartInstance.destroy();
            branchChartInstance = new Chart(document.getElementById('branch-chart'), {
                 type: 'bar',
                 data: {
                     labels: branchLabels,
                     datasets: [{
                         label: '申請量',
                         data: branchData,
                         backgroundColor: '#3b82f6',
                     }]
                 },
                 options: { 
                     responsive: true, 
                     maintainAspectRatio: false,
                     scales: { y: { beginAtZero: true } }
                 }
            });

            // 3. Driver Chart (Filtered by '已派車')
            const dispatchedRequests = monthlyRequests.filter(r => r.status === '已派車');
            const driverCounts = dispatchedRequests.reduce((acc, r) => {
                 const driver = r.driver_name || '未指定';
                 acc[driver] = (acc[driver] || 0) + 1;
                 return acc;
            }, {});
            const driverLabels = Object.keys(driverCounts);
            const driverData = Object.values(driverCounts);
            
            if (driverChartInstance) driverChartInstance.destroy();
            driverChartInstance = new Chart(document.getElementById('driver-chart'), {
                 type: 'bar',
                 data: {
                     labels: driverLabels,
                     datasets: [{
                         label: '派車趟次',
                         data: driverData,
                         backgroundColor: '#10b981',
                     }]
                 },
                 options: { 
                     responsive: true, 
                     maintainAspectRatio: false,
                     indexAxis: 'y', // Horizontal bars
                     scales: { x: { beginAtZero: true } }
                 }
            });
        }


        // --- EVENT LISTENERS SETUP ---
        
        // Tab Clicks
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
        });

        // Form Actions
        form.addEventListener('submit', submitForm);
        clearBtn.addEventListener('click', clearForm);
        
        // Admin/Stats Login
        adminLoginPromptBtn.addEventListener('click', promptLogin);
        document.getElementById('stats-login-prompt-btn').addEventListener('click', promptLogin);
        logoutBtn.addEventListener('click', () => {
             showConfirm('確定要登出管理員身分嗎？', (confirmed) => {
                 if (confirmed) {
                     state.isLoggedIn = false;
                     updateAdminUI();
                     setActiveTab('apply');
                     showAlert('已登出。', '登出成功');
                 }
             }, '登出確認');
        });
        
        // Admin List Refresh/Search
        refreshAdminListBtn.addEventListener('click', () => renderRequestsList(state.requests));
        adminSearchInput.addEventListener('input', () => renderRequestsList(state.requests));
        
        // Admin/Applicant View Clicks (Delegation)
        document.getElementById('tab-content-admin').addEventListener('click', (e) => {
             const btn = e.target.closest('.view-admin-btn');
             if (btn) {
                 state.deepLinkedRequestId = btn.dataset.id;
                 setActiveTab('apply');
                 loadRequestForEditing(btn.dataset.id);
             }
        });
        document.getElementById('tab-content-search').addEventListener('click', (e) => {
             const btn = e.target.closest('.view-applicant-btn');
             if (btn) {
                 state.deepLinkedRequestId = btn.dataset.id;
                 setActiveTab('apply');
                 loadRequestForEditing(btn.dataset.id);
             }
        });
        
        // Stats Filter
        document.getElementById('stats-month-filter').addEventListener('change', renderStats);
        document.getElementById('stats-month-filter').value = new Date().toISOString().substring(0, 7); // Set default month to current

        // Search Tab Button
        searchBtn.addEventListener('click', () => {
             const queryText = searchInput.value.trim().toLowerCase();
             if (!queryText) {
                 renderSearchResults([]);
                 return;
             }
             
             const results = state.requests.filter(r => 
                 r.id.toLowerCase().includes(queryText) || 
                 r.applicant_name.toLowerCase().includes(queryText)
             );
             renderSearchResults(results);
        });

        // Excel Export
        document.getElementById('export-excel-btn').addEventListener('click', () => {
             const dataToExport = state.requests.map(r => ({
                 '申請單號': r.id,
                 '狀態': r.status,
                 '用車事由': r.reason,
                 '院區': r.branch ? r.branch.join(', ') : '',
                 '車輛種類': r.vehicle_type,
                 '駛達地點': r.destination,
                 '搭乘人數': r.passengers,
                 '預定起始時間': formatTimestamp(r.start_time),
                 '預定結束時間': formatTimestamp(r.end_time),
                 '申請單位': r.applicant_unit,
                 '申請人姓名': r.applicant_name,
                 '聯絡分機': r.extension,
                 '費用部門代號': r.cost_code,
                 '聯絡群組': r.contact_group,
                 '申請備註': r.remarks,
                 '簽核主管': r.approving_manager || 'N/A',
                 '派車方式': r.dispatch_method || '',
                 '司機姓名': r.driver_name || '',
                 '司機電話': r.driver_phone || '',
                 '承辦備註': r.admin_remarks || '',
                 '建立時間': formatTimestamp(r.created_at)
             }));

             const ws = XLSX.utils.json_to_sheet(dataToExport);
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "派車申請資料");
             const filename = `派車申請紀錄_${new Date().toISOString().substring(0, 10)}.xlsx`;
             XLSX.writeFile(wb, filename);
             showAlert('數據已成功匯出為 Excel 檔案！', '匯出完成');
        });


        // --- INITIALIZATION ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                 state.userId = user.uid;
                 state.isAuthReady = true;
                 console.log("Auth state ready. User ID:", user.uid);
                 
                 // 1. Setup real-time listener for all data
                 setupRealtimeListener();

                 // 2. Check for deep link
                 if (state.deepLinkedRequestId) {
                    console.log("Deep link detected:", state.deepLinkedRequestId);
                    loadRequestForEditing(state.deepLinkedRequestId);
                 }
            } else {
                 console.log("User is signed out or unavailable.");
                 state.isAuthReady = true; // Still mark as ready even if anonymous
            }
        });
        
        // Initial call to start auth process
        // authenticateUser() is now called on window load, which is appropriate for Firebase JS SDK.
        
        // Final window load tasks
        window.addEventListener('load', async () => {
             // ensure authentication is attempted once the DOM is ready
             await authenticateUser();
             
             // Set default tab if no deep link is processed
             if (!state.deepLinkedRequestId) {
                setActiveTab('apply');
             }
        });
        
    </script>
</body>
</html>

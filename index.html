<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>佳里奇美醫院派車申請系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .disabled-input {
            background-color: #f1f5f9;
            color: #64748b;
            cursor: not-allowed;
        }
        .request-card {
            transition: all 0.2s ease-in-out;
        }
        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
            text-transform: uppercase;
        }
        .status-manager-approval { background-color: #e0e7ff; color: #3730a3; }
        .status-manager-rejected { background-color: #FEF9C3; color: #713F12; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-dispatched { background-color: #d1fae5; color: #065f46; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }
        .status-rejected { background-color: #e5e7eb; color: #4b5563; }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes pulse-badge {
            50% { opacity: .6; }
        }
        .animate-pulse-badge {
            animation: pulse-badge 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .tab-btn {
            padding: 0.75rem 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }
        .tab-btn:hover {
            background-color: #f3f4f6;
        }
        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="w-full max-w-5xl mx-auto p-4 sm:p-6">
        <header class="flex justify-start items-center mb-6">
            <div class="flex items-center gap-4">
                <img src="chimei.png" alt="奇美醫院 Logo" class="h-12 sm:h-16">
                <h1 class="text-xl sm:text-3xl font-bold text-gray-800">派車申請系統</h1>
            </div>
            <a https://guccll0815-rgb.github.io/CCH2500/="https://intranet.chimei.org.tw/tcp/32500/index.html" target="_self"
                </a>
            </header>

        <nav class="flex flex-wrap border-b border-gray-200 bg-white rounded-t-lg">
            <button data-tab="apply" class="tab-btn active text-sm sm:text-base font-medium">填寫申請</button>
            <button data-tab="search" class="tab-btn text-sm sm:text-base font-medium">查詢狀態</button>
            <button data-tab="admin" class="tab-btn flex items-center text-sm sm:text-base font-medium">
                管理後台
                <span id="pending-count" class="ml-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"></span>
            </button>
            <button data-tab="stats" class="tab-btn hidden text-sm sm:text-base font-medium">統計分析</button>
        </nav>

        <main>
            <div id="tab-content-apply" class="tab-content bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <form id="dispatchForm" class="space-y-6">
                    <input type="hidden" id="request-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-6 border-t border-b border-gray-200 py-6">
                        <div class="lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700">院區</label>
                            <div id="branch-options" class="mt-2 flex flex-wrap items-center gap-4 sm:gap-6 text-sm sm:text-base text-gray-700">
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="branch" value="總院" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span>總院</span></label>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="branch" value="柳營院區" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span>柳營院區</span></label>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="branch" value="佳里院區" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span>佳里院區</span></label>
                            </div>
                        </div>
                        <div><label for="reason" class="block text-sm font-medium text-gray-700">用車事由</label><input type="text" id="reason" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label class="block text-sm font-medium text-gray-700">車輛種類</label><div class="mt-2 flex items-center space-x-6 text-sm sm:text-base"><label class="flex items-center space-x-2"><input type="radio" name="vehicle_type" value="中巴" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><span>中巴</span></label><label class="flex items-center space-x-2"><input type="radio" name="vehicle_type" value="小客" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><span>小客</span></label><label class="flex items-center space-x-2"><input type="radio" name="vehicle_type" value="其他" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><span>其他</span></label></div></div>
                        <div><label for="destination" class="block text-sm font-medium text-gray-700">駛達地點</label><input type="text" id="destination" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="passengers" class="block text-sm font-medium text-gray-700">搭乘人數</label><input type="number" id="passengers" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="start_time" class="block text-sm font-medium text-gray-700">預定派車時間 (起)</label><input type="datetime-local" id="start_time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                        <div><label for="end_time" class="block text-sm font-medium text-gray-700">預定派車時間 (迄)</label><input type="datetime-local" id="end_time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                        <div><label for="applicant_unit" class="block text-sm font-medium text-gray-700">申請單位</label><input type="text" id="applicant_unit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="cost_code" class="block text-sm font-medium text-gray-700">費用部門代號</label><input type="text" id="cost_code" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="extension" class="block text-sm font-medium text-gray-700">聯絡分機</label><input type="text" id="extension" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="contact_group" class="block text-sm font-medium text-gray-700">聯絡群組</label><input type="text" id="contact_group" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div class="md:col-span-2"><label for="applicant_name" class="block text-sm font-medium text-gray-700">申請人姓名</label><input type="text" id="applicant_name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="請輸入姓名"></div>
                        <div class="lg:col-span-3">
                            <label for="remarks" class="block text-sm font-medium text-gray-700">備註</label>
                            <textarea id="remarks" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="若有特殊需求請在此說明..."></textarea>
                        </div>
                    </div>
                    
                    <div id="admin-section" class="hidden border-t border-gray-200 pt-6 mt-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">承辦單位處理狀況</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div>
                                <label for="display_request_id" class="block text-sm font-medium text-gray-700">申請單號</label>
                                <input type="text" id="display_request_id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                            <div>
                                <label for="dispatch_status" class="block text-sm font-medium text-gray-700">處理狀況</label>
                                <select id="dispatch_status" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                                    <option value="待申請單位主管簽核">待申請單位主管簽核</option>
                                    <option value="主管退回">主管退回</option>
                                    <option value="待管理單位處理">待管理單位處理</option>
                                    <option value="已派車">已派車</option>
                                    <option value="案件取消">案件取消</option>
                                    <option value="無法派車">無法派車</option>
                                </select>
                            </div>
                            <div>
                                <label for="approving_manager" class="block text-sm font-medium text-gray-700">簽核主管</label>
                                <input type="text" id="approving_manager" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                            <div>
                                <label for="dispatch_method" class="block text-sm font-medium text-gray-700">派車方式</label>
                                <input type="text" id="dispatch_method" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                             <div>
                                <label for="driver_name" class="block text-sm font-medium text-gray-700">司機姓名</label>
                                <input type="text" id="driver_name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                             <div>
                                <label for="driver_phone" class="block text-sm font-medium text-gray-700">司機電話</label>
                                <input type="text" id="driver_phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                            <div class="md:col-span-2">
                                <label for="admin_remarks" class="block text-sm font-medium text-gray-700">承辦備註</label>
                                <textarea id="admin_remarks" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="pt-6 text-center flex items-center justify-center space-x-4">
                        <button type="submit" id="submit-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-12 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">提交新申請</button>
                        <button type="button" id="clear-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-8 border border-gray-300 shadow-sm text-base font-medium rounded-full text-gray-700 bg-white hover:bg-gray-50">清空表單</button>
                    </div>
                </form>
            </div>

            <div id="tab-content-search" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-6">查詢申請狀態</h2>
                <div class="flex items-center space-x-2 mb-6">
                    <input type="text" id="search-input" placeholder="請輸入申請人姓名或申請單號進行查詢..." class="flex-grow block w-full px-4 py-2 bg-white border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <button id="search-btn" class="py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">查詢</button>
                </div>
                <div id="search-results" class="space-y-4">
                    <p class="text-center text-gray-500">請輸入姓名或單號以查詢您的申請記錄。</p>
                </div>
            </div>

            <div id="tab-content-admin" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <div id="admin-view">
                      <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4 gap-4">
                        <div class="flex items-center gap-2">
                            <h2 class="text-xl font-bold text-gray-800">所有派車申請</h2>
                            <button id="refresh-admin-list-btn" title="重新整理" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="w-5 h-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.691V5.25a8.25 8.25 0 00-11.664 0v4.992m11.664 0l-3.181-3.183" />
                                </svg>
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                             <input type="text" id="admin-search-input" placeholder="依申請單號查詢..." class="w-full sm:w-auto px-4 py-2 bg-white border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button id="logout-btn" class="hidden py-2 px-4 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">登出</button>
                    </div>
                    <div id="requests-list" class="space-y-4">
                        </div>
                </div>
                 <div id="admin-login-prompt" class="text-center py-10">
                    <p class="text-gray-600">此為管理員專區，請先登入。</p>
                    <button id="admin-login-prompt-btn" class="mt-4 py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">立即登入</button>
                </div>
            </div>

            <div id="tab-content-stats" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                    <div id="stats-view" class="hidden">
                        <div class="flex justify-between items-center mb-6 border-b pb-4">
                            <h2 class="text-xl font-bold text-gray-800">數據統計分析</h2>
                            <button id="export-excel-btn" class="py-2 px-4 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">匯出 Excel</button>
                        </div>

                        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-2">
                                <label for="stats-month-filter" class="text-sm font-medium text-gray-700">篩選月份:</label>
                                <input type="month" id="stats-month-filter" class="border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div class="flex gap-4 text-center">
                                <div>
                                    <p class="text-2xl font-bold text-blue-600" id="stats-total-requests">0</p>
                                    <p class="text-sm font-medium text-gray-500">總申請筆數</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="p-4 border rounded-lg lg:col-span-2">
                                <h3 class="text-center font-semibold mb-4 text-gray-700">各司機趟次統計</h3>
                                <canvas id="driver-chart"></canvas>
                            </div>
                             <div class="p-4 border rounded-lg"><h3 class="text-center font-semibold mb-4 text-gray-700">申請狀態分佈</h3><canvas id="status-chart"></canvas></div>
                             <div class="p-4 border rounded-lg"><h3 class="text-center font-semibold mb-4 text-gray-700">各院區申請量</h3><canvas id="branch-chart"></canvas></div>
                        </div>
                    </div>
                    <div id="stats-login-prompt" class="text-center py-10">
                        <p class="text-gray-600">此為管理員專區，請先登入查看統計數據。</p>
                        <button id="stats-login-prompt-btn" class="mt-4 py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">立即登入</button>
                    </div>
            </div>
        </main>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all">
            <h3 id="modal-title" class="text-lg font-medium text-gray-900">通知</h3>
            <div id="modal-content" class="mt-2 text-sm text-gray-600"></div>
            <div id="modal-buttons" class="mt-5 sm:mt-6 flex justify-end space-x-3"></div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, setLogLevel, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        window.addEventListener('load', () => {
            const state = {
                isLoggedIn: false,
                requests: [],
                editingRequestId: null,
                activeTab: 'apply',
                db: null, // Firestore instance
                auth: null, // Auth instance
                deepLinkedRequestId: null,
            };
            
            let statusChartInstance, branchChartInstance, driverChartInstance;

            // --- CACHE ELEMENTS ---
            const form = document.getElementById('dispatchForm');
            const logoutBtn = document.getElementById('logout-btn');
            const submitBtn = document.getElementById('submit-btn');
            const clearBtn = document.getElementById('clear-btn');
            const requestIdInput = document.getElementById('request-id');
            const adminSection = document.getElementById('admin-section');
            const adminFields = ['dispatch_status', 'dispatch_method', 'driver_name', 'driver_phone', 'admin_remarks'].map(id => document.getElementById(id));
            
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            const adminView = document.getElementById('admin-view');
            const adminLoginPrompt = document.getElementById('admin-login-prompt');
            const adminLoginPromptBtn = document.getElementById('admin-login-prompt-btn');
            const requestsList = document.getElementById('requests-list');
            const pendingCountBadge = document.getElementById('pending-count');
            
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const searchResults = document.getElementById('search-results');
            const adminSearchInput = document.getElementById('admin-search-input');
            const refreshAdminListBtn = document.getElementById('refresh-admin-list-btn');

            const statsTabBtn = document.querySelector('button[data-tab="stats"]');
            const statsView = document.getElementById('stats-view');
            const statsLoginPrompt = document.getElementById('stats-login-prompt');
            const statsLoginPromptBtn = document.getElementById('stats-login-prompt-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const statsMonthFilter = document.getElementById('stats-month-filter');
            const statsTotalRequests = document.getElementById('stats-total-requests');

            // --- MODAL ELEMENTS & FUNCTIONS ---
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalButtons = document.getElementById('modal-buttons');

            function hideModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }
            function showAlert(message, title = '通知') { 
                modalTitle.textContent = title;
                modalContent.innerHTML = `<p>${message}</p>`;
                modalButtons.innerHTML = `<button id="modal-ok-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">確定</button>`;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                const okBtn = document.getElementById('modal-ok-btn');
                okBtn.onclick = hideModal;
                okBtn.focus();
            }
           function showSuccessWithLink(message, link) {
                modalTitle.textContent = '申請成功';
                modalContent.innerHTML = `
                    <p>${message}</p>
                    <div class="mt-4">
                        <label for="approval-link" class="block text-sm font-medium text-gray-700 text-left">專屬簽核連結</label>
                        <input type="text" id="approval-link" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" value="${link}">
                    </div>
                `;
                modalButtons.innerHTML = `
                    <button id="modal-copy-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">複製連結</button>
                    <button id="modal-close-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">關閉</button>
                `;
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                const copyBtn = document.getElementById('modal-copy-btn');
                const closeBtn = document.getElementById('modal-close-btn');
                const linkInput = document.getElementById('approval-link');

                copyBtn.onclick = () => {
                    linkInput.select();
                    document.execCommand('copy');
                    copyBtn.textContent = '已複製！';
                    setTimeout(() => { copyBtn.textContent = '複製連結'; }, 2000);
                };
                closeBtn.onclick = hideModal;
            }

            function showConfirm(message, callback, title = '確認操作') {
                modalTitle.textContent = title;
                modalContent.innerHTML = `<p>${message}</p>`;
                modalButtons.innerHTML = `
                    <button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">取消</button>
                    <button id="modal-confirm-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none">確定</button>
                `;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                const confirmBtn = document.getElementById('modal-confirm-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');
                confirmBtn.onclick = () => { hideModal(); if (callback) callback(true); };
                cancelBtn.onclick = () => { hideModal(); if (callback) callback(false); };
                confirmBtn.focus();
            }
            function promptLogin() {
                modalTitle.textContent = '管理員登入';
                modalContent.innerHTML = `<div class="space-y-4"><div><label for="modal-username" class="block text-sm font-medium text-gray-700 text-left">帳號</label><input type="text" id="modal-username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="modal-password" class="block text-sm font-medium text-gray-700 text-left">密碼</label><input type="password" id="modal-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><p id="modal-error" class="text-sm text-red-600 h-4"></p></div>`;
                modalButtons.innerHTML = `<button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">取消</button><button id="modal-login-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">登入</button>`;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                const loginBtn = document.getElementById('modal-login-btn'), cancelBtn = document.getElementById('modal-cancel-btn'), usernameInput = document.getElementById('modal-username'), passwordInput = document.getElementById('modal-password'), errorEl = document.getElementById('modal-error');
                usernameInput.focus();
                const handleLogin = () => {
                    if (usernameInput.value === 'admin' && passwordInput.value === 'cch2500') {
                        hideModal(); state.isLoggedIn = true; showAlert('登入成功！'); updateUI(); setActiveTab('admin');
                    } else {
                        errorEl.textContent = '帳號或密碼錯誤！'; const modalBox = modal.querySelector('div'); modalBox.classList.add('animate-shake'); setTimeout(() => { modalBox.classList.remove('animate-shake'); }, 500);
                    }
                };
                loginBtn.onclick = handleLogin;
                passwordInput.onkeydown = (e) => { if (e.key === 'Enter') handleLogin(); };
                usernameInput.onkeydown = (e) => { if (e.key === 'Enter') passwordInput.focus(); };
                cancelBtn.onclick = hideModal;
            }

            function promptManagerAction(callback) {
                modalTitle.textContent = '主管簽核';
                modalContent.innerHTML = `
                    <p class="mb-4">請輸入您的姓名並提供備註 (非必填)。</p>
                    <div class="space-y-4">
                        <div>
                            <label for="modal-manager-name" class="block text-sm font-medium text-gray-700 text-left">主管姓名</label>
                            <input type="text" id="modal-manager-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="modal-manager-remarks" class="block text-sm font-medium text-gray-700 text-left">備註</label>
                            <textarea id="modal-manager-remarks" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="若退回申請，請說明原因..."></textarea>
                        </div>
                        <p id="modal-error" class="text-sm text-red-600 h-4 mt-1"></p>
                    </div>`;
                modalButtons.innerHTML = `
                    <button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">取消</button>
                    <button id="modal-reject-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-yellow-600 text-base font-medium text-white hover:bg-yellow-700 focus:outline-none">退回</button>
                    <button id="modal-approve-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none">核准</button>
                `;
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                const approveBtn = document.getElementById('modal-approve-btn'), rejectBtn = document.getElementById('modal-reject-btn'), cancelBtn = document.getElementById('modal-cancel-btn');
                const managerNameInput = document.getElementById('modal-manager-name'), managerRemarksInput = document.getElementById('modal-manager-remarks'), errorEl = document.getElementById('modal-error');
                
                managerNameInput.focus();

                const handleAction = (status) => {
                    const managerName = managerNameInput.value.trim();
                    const managerRemarks = managerRemarksInput.value.trim();
                    if (!managerName) {
                        errorEl.textContent = '主管姓名為必填！';
                        const modalBox = modal.querySelector('div'); modalBox.classList.add('animate-shake'); setTimeout(() => { modalBox.classList.remove('animate-shake'); }, 500);
                        return;
                    }
                    hideModal();
                    callback(status, managerName, managerRemarks);
                };

                approveBtn.onclick = () => handleAction('待管理單位處理'); // Manager approved
                rejectBtn.onclick = () => handleAction('主管退回'); // Manager rejected
                cancelBtn.onclick = hideModal;
            }

            // --- CORE LOGIC (Keeping the rest of your original JS) ---
            
            // [Firebase App Configuration]
            const firebaseConfig = {
                // Your Firebase configuration object goes here
                // **請在此處填入您的 Firebase 設定**
            };

            try {
                const app = initializeApp(firebaseConfig);
                state.db = getFirestore(app);
                state.auth = getAuth(app);
                // Optional: Disable noisy Firebase warnings
                setLogLevel('error');

                signInAnonymously(state.auth)
                    .then(() => { console.log("Anonymous sign-in successful."); startRealtimeListener(); })
                    .catch((error) => { console.error("Anonymous sign-in failed:", error); showAlert("無法連線至資料庫，請檢查網路或系統設定。", "錯誤"); });

            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                showAlert("系統初始化失敗，請檢查瀏覽器控制台是否有錯誤。", "系統錯誤");
            }

            /** UTILS **/
            function formatTimestamp(timestamp) {
                if (!timestamp) return 'N/A';
                if (timestamp.toDate) { // Firebase Timestamp
                    return new Date(timestamp.toDate()).toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
                }
                if (timestamp instanceof Date) { // Standard Date
                    return timestamp.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
                }
                return timestamp; // Assume it's already a string
            }

            function getStatusClass(status) {
                switch (status) {
                    case '待申請單位主管簽核': return 'status-manager-approval animate-pulse-badge';
                    case '主管退回': return 'status-manager-rejected';
                    case '待管理單位處理': return 'status-pending animate-pulse-badge';
                    case '已派車': return 'status-dispatched';
                    case '案件取消': return 'status-cancelled';
                    case '無法派車': return 'status-rejected';
                    default: return 'bg-gray-200 text-gray-800';
                }
            }

            function generateRequestId(date) {
                const d = date || new Date();
                const year = d.getFullYear().toString().slice(2);
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                return `${year}${month}-`;
            }

            // ** CRUD Handlers **

            // READ - Realtime Listener
            function startRealtimeListener() {
                if (!state.db) return;
                const q = query(collection(state.db, "dispatchRequests"));
                
                onSnapshot(q, (snapshot) => {
                    const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    requests.sort((a, b) => b.request_id.localeCompare(a.request_id)); // Sort by ID descending
                    state.requests = requests;

                    updateAdminList(requests);
                    if (state.activeTab === 'stats') {
                        updateStatsCharts();
                    }
                    
                    // Handle deep link editing immediately after data is loaded
                    if (state.deepLinkedRequestId) {
                        const targetRequest = requests.find(r => r.id === state.deepLinkedRequestId);
                        if (targetRequest) {
                            loadRequestForEdit(targetRequest);
                            setActiveTab('apply');
                        } else {
                            showAlert(`找不到單號為 ${state.deepLinkedRequestId} 的申請單。`, '錯誤');
                            setActiveTab('apply');
                        }
                        state.deepLinkedRequestId = null;
                    }
                }, (error) => {
                    console.error("Firestore real-time listener failed:", error);
                    showAlert("即時資料更新失敗，請重新整理頁面。", "連線錯誤");
                });
            }

            // CREATE / UPDATE - Form Submission
            async function handleSubmit(e) {
                e.preventDefault();
                submitBtn.disabled = true;
                submitBtn.textContent = state.editingRequestId ? '儲存中...' : '提交中...';

                const data = {
                    request_id: document.getElementById('request-id').value || '',
                    reason: document.getElementById('reason').value.trim(),
                    vehicle_type: document.querySelector('input[name="vehicle_type"]:checked')?.value || '',
                    destination: document.getElementById('destination').value.trim(),
                    passengers: parseInt(document.getElementById('passengers').value) || 0,
                    start_time: document.getElementById('start_time').value ? new Date(document.getElementById('start_time').value) : null,
                    end_time: document.getElementById('end_time').value ? new Date(document.getElementById('end_time').value) : null,
                    applicant_unit: document.getElementById('applicant_unit').value.trim(),
                    cost_code: document.getElementById('cost_code').value.trim(),
                    extension: document.getElementById('extension').value.trim(),
                    contact_group: document.getElementById('contact_group').value.trim(),
                    applicant_name: document.getElementById('applicant_name').value.trim(),
                    remarks: document.getElementById('remarks').value.trim(),
                    
                    // Admin fields (only editable in admin mode/admin section)
                    dispatch_status: document.getElementById('dispatch_status').value || '待申請單位主管簽核',
                    approving_manager: document.getElementById('approving_manager').value || '',
                    dispatch_method: document.getElementById('dispatch_method').value || '',
                    driver_name: document.getElementById('driver_name').value || '',
                    driver_phone: document.getElementById('driver_phone').value || '',
                    admin_remarks: document.getElementById('admin_remarks').value || '',
                };
                
                // Get selected branches
                const branchCheckboxes = document.querySelectorAll('input[name="branch"]:checked');
                data.branch = Array.from(branchCheckboxes).map(cb => cb.value).join(', ');

                // Simple Validation
                if (!data.reason || !data.vehicle_type || !data.destination || data.passengers <= 0 || !data.start_time || !data.end_time || !data.applicant_unit || !data.applicant_name) {
                    showAlert('請填寫所有標記為必填的欄位 (用車事由、車輛種類、駛達地點、搭乘人數、時間、申請單位、申請人姓名)。', '表單驗證失敗');
                    submitBtn.disabled = false;
                    submitBtn.textContent = state.editingRequestId ? '儲存修改' : '提交新申請';
                    return;
                }

                try {
                    if (state.editingRequestId) {
                        // UPDATE mode
                        await updateDoc(doc(state.db, "dispatchRequests", state.editingRequestId), {
                            ...data,
                            updated_at: serverTimestamp()
                        });
                        showAlert(`申請單 ${data.request_id} 已成功更新！`, '更新成功');
                        clearForm();
                        setActiveTab('admin'); // Go back to admin list after update
                    } else {
                        // CREATE mode
                        
                        // Generate new request_id (needs Firestore to find next index)
                        const prefix = generateRequestId();
                        const q = query(collection(state.db, "dispatchRequests"), where("request_id", ">=", prefix), where("request_id", "<", prefix + '999'));
                        const snapshot = await getDocs(q);
                        const existingIds = snapshot.docs.map(d => d.data().request_id).filter(id => id.startsWith(prefix));
                        
                        let maxNum = 0;
                        if (existingIds.length > 0) {
                            maxNum = existingIds.reduce((max, id) => {
                                const num = parseInt(id.slice(-3));
                                return num > max ? num : max;
                            }, 0);
                        }
                        const nextNum = maxNum + 1;
                        data.request_id = `${prefix}${nextNum.toString().padStart(3, '0')}`;
                        data.created_at = serverTimestamp();
                        data.initial_status_time = serverTimestamp();

                        const docRef = await addDoc(collection(state.db, "dispatchRequests"), data);
                        
                        // Generate manager approval link
                        const approvalLink = `${window.location.origin}${window.location.pathname}?id=${docRef.id}`;

                        showSuccessWithLink(`您的派車申請已成功提交！單號為：${data.request_id}。請將此單號和簽核連結提供給您的直屬主管。`, approvalLink);
                        clearForm();
                    }
                } catch (error) {
                    console.error("Error writing document: ", error);
                    showAlert("提交申請時發生錯誤，請稍後再試。", "錯誤");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '提交新申請';
                }
            }

            // READ - Search Query
            function handleSearch() {
                const queryStr = searchInput.value.trim().toLowerCase();
                searchResults.innerHTML = '';
                
                if (!queryStr) {
                    searchResults.innerHTML = `<p class="text-center text-gray-500">請輸入姓名或單號以查詢您的申請記錄。</p>`;
                    return;
                }
                
                const filtered = state.requests.filter(req => 
                    req.applicant_name?.toLowerCase().includes(queryStr) || 
                    req.request_id?.toLowerCase().includes(queryStr)
                );
                
                if (filtered.length === 0) {
                    searchResults.innerHTML = `<p class="text-center text-red-500">找不到符合 "${queryStr}" 的申請記錄。</p>`;
                    return;
                }
                
                filtered.forEach(req => {
                    searchResults.appendChild(buildRequestCard(req, false)); // false = not in admin view
                });
            }

            // UPDATE - Manager Action
            async function handleManagerAction(request, status, managerName, managerRemarks) {
                try {
                    let updateData = {
                        dispatch_status: status,
                        approving_manager: managerName,
                        updated_at: serverTimestamp()
                    };

                    if (status === '主管退回') {
                        updateData.admin_remarks = (request.admin_remarks || '') + ` [主管退回 - ${managerName} 備註: ${managerRemarks}]`;
                    }
                    
                    await updateDoc(doc(state.db, "dispatchRequests", request.id), updateData);
                    showAlert(`申請單 ${request.request_id} 已由主管 ${status === '待管理單位處理' ? '核准' : '退回'}！`, '操作成功');
                } catch (error) {
                    console.error("Manager action failed: ", error);
                    showAlert("主管簽核操作失敗，請稍後再試。", "錯誤");
                }
            }

            // UPDATE - Admin Action (Save button in Apply form)
            async function handleAdminUpdate(e) {
                e.preventDefault();
                if (!state.editingRequestId) return;
                
                submitBtn.disabled = true;
                submitBtn.textContent = '儲存中...';

                // Collect all fields, admin and user
                const data = {};
                form.querySelectorAll('input, textarea, select').forEach(el => {
                    if (el.id === 'request-id' || el.id === 'display_request_id' || el.id === 'modal-manager-name' || el.id === 'modal-manager-remarks') return;
                    if (el.type === 'radio' && !el.checked) return;
                    if (el.type === 'checkbox') return;
                    
                    if (el.type === 'datetime-local' && el.value) {
                         data[el.id] = new Date(el.value);
                    } else if (el.type === 'number') {
                         data[el.id] = parseInt(el.value) || 0;
                    } else if (el.type === 'radio') {
                         data[el.name] = el.value;
                    } else {
                         data[el.id] = el.value.trim();
                    }
                });
                
                const branchCheckboxes = document.querySelectorAll('input[name="branch"]:checked');
                data.branch = Array.from(branchCheckboxes).map(cb => cb.value).join(', ');

                // Rename keys to match Firestore fields
                data.vehicle_type = data.vehicle_type || document.querySelector('input[name="vehicle_type"]:checked')?.value || '';
                data.dispatch_status = document.getElementById('dispatch_status').value;
                data.admin_remarks = document.getElementById('admin_remarks').value;
                data.approving_manager = document.getElementById('approving_manager').value;
                data.dispatch_method = document.getElementById('dispatch_method').value;
                data.driver_name = document.getElementById('driver_name').value;
                data.driver_phone = document.getElementById('driver_phone').value;
                
                delete data['display_request_id']; // This is just a display field
                
                try {
                    await updateDoc(doc(state.db, "dispatchRequests", state.editingRequestId), {
                        ...data,
                        updated_at: serverTimestamp()
                    });
                    showAlert(`申請單 ${data.request_id} 已成功更新！`, '承辦處理成功');
                    clearForm();
                    setActiveTab('admin');
                } catch (error) {
                    console.error("Admin update failed: ", error);
                    showAlert("承辦更新申請單時發生錯誤。", "錯誤");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '儲存修改';
                }
            }
            
            // DELETE
            async function handleDelete(id, requestId) {
                showConfirm(`您確定要永久刪除單號為 ${requestId} 的申請單嗎？此操作無法復原。`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            await deleteDoc(doc(state.db, "dispatchRequests", id));
                            showAlert(`申請單 ${requestId} 已成功刪除！`, '刪除成功');
                        } catch (error) {
                            console.error("Error removing document: ", error);
                            showAlert("刪除申請單時發生錯誤，請稍後再試。", "錯誤");
                        }
                    }
                }, '刪除確認');
            }
            
            // CANCEL (for applicants)
            async function handleCancel(id, requestId) {
                const request = state.requests.find(r => r.id === id);
                if (!request) return showAlert('找不到該申請單。', '錯誤');
                
                if (request.dispatch_status === '已派車') {
                    return showAlert('此申請單已派車，無法自行取消。請聯繫承辦單位處理。', '操作限制');
                }
                
                showConfirm(`您確定要取消單號為 ${requestId} 的派車申請嗎？`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            await updateDoc(doc(state.db, "dispatchRequests", id), {
                                dispatch_status: '案件取消',
                                admin_remarks: (request.admin_remarks || '') + ' [申請人自行取消]',
                                updated_at: serverTimestamp()
                            });
                            showAlert(`申請單 ${requestId} 已成功取消！`, '取消成功');
                            // Refresh search results to reflect change
                            handleSearch();
                        } catch (error) {
                            console.error("Error cancelling document: ", error);
                            showAlert("取消申請單時發生錯誤，請稍後再試。", "錯誤");
                        }
                    }
                }, '取消確認');
            }


            /** UI Management **/

            function buildRequestCard(request, isAdmin = false) {
                const card = document.createElement('div');
                const statusClass = getStatusClass(request.dispatch_status);
                
                const managerActionLink = `${window.location.origin}${window.location.pathname}?id=${request.id}`;
                
                card.className = `request-card bg-white p-4 sm:p-6 rounded-xl shadow-md border-l-4 border-blue-500 transition duration-300`;
                
                let adminControls = '';
                if (isAdmin) {
                    adminControls = `
                        <div class="flex flex-col sm:flex-row items-end sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 mt-4 sm:mt-0">
                            <button data-id="${request.id}" class="admin-edit-btn text-sm text-blue-600 hover:text-blue-800 font-medium whitespace-nowrap">
                                檢視/編輯
                            </button>
                            ${request.dispatch_status !== '已派車' ? `<button data-id="${request.id}" data-reqid="${request.request_id}" class="admin-delete-btn text-sm text-red-600 hover:text-red-800 font-medium">刪除</button>` : ''}
                        </div>
                    `;
                } else {
                    // Non-admin (Applicant view) controls
                    let actionButton = '';
                    if (request.dispatch_status === '待申請單位主管簽核') {
                        // Applicant should manage the approval link
                        actionButton = `
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-4 sm:mt-0">
                                <button data-id="${request.id}" data-reqid="${request.request_id}" class="applicant-cancel-btn text-sm text-red-600 hover:text-red-800 font-medium whitespace-nowrap">
                                    取消申請
                                </button>
                                <button onclick="showSuccessWithLink('請將此連結提供給您的直屬主管進行簽核。', '${managerActionLink}')" class="text-sm text-green-600 hover:text-green-800 font-medium whitespace-nowrap">
                                    複製簽核連結
                                </button>
                            </div>
                        `;
                    } else if (request.dispatch_status !== '案件取消' && request.dispatch_status !== '無法派車' && request.dispatch_status !== '已派車') {
                         actionButton = `
                            <button onclick="showAlert('您的申請已轉交給管理單位處理，請靜候通知。','處理中')" class="text-sm text-gray-600 hover:text-gray-800 font-medium whitespace-nowrap mt-4 sm:mt-0">
                                處理中
                            </button>
                        `;
                    }
                    adminControls = actionButton;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-lg font-semibold text-gray-800">${request.applicant_unit} - ${request.applicant_name}</p>
                            <p class="text-sm text-gray-600">單號: ${request.request_id}</p>
                            <p class="text-sm text-gray-500">申請時間: ${formatTimestamp(request.created_at)}</p>
                        </div>
                        <span class="status-badge ${statusClass}">${request.dispatch_status}</span>
                    </div>
                    
                    <div class="mt-4 text-sm text-gray-700 space-y-1 border-t border-gray-100 pt-3">
                        <p><strong>事由:</strong> ${request.reason || 'N/A'} (${request.vehicle_type || 'N/A'})</p>
                        <p><strong>時間:</strong> ${formatTimestamp(request.start_time).slice(0, 10)} ${formatTimestamp(request.start_time).slice(11)} ~ ${formatTimestamp(request.end_time).slice(11)}</p>
                        <p><strong>地點:</strong> ${request.destination || 'N/A'}</p>
                        <p><strong>院區:</strong> ${request.branch || 'N/A'}</p>
                    </div>
                    ${adminControls}
                `;
                
                // Attach event listeners for admin controls dynamically
                if (isAdmin) {
                    card.querySelector('.admin-edit-btn')?.addEventListener('click', () => loadRequestForEdit(request));
                    card.querySelector('.admin-delete-btn')?.addEventListener('click', (e) => {
                        handleDelete(e.target.dataset.id, e.target.dataset.reqid);
                    });
                } else {
                    card.querySelector('.applicant-cancel-btn')?.addEventListener('click', (e) => {
                        handleCancel(e.target.dataset.id, e.target.dataset.reqid);
                    });
                }
                
                return card;
            }

            function updateAdminList(requests) {
                requestsList.innerHTML = '';
                let pendingCount = 0;
                let filteredRequests = requests;

                const searchVal = adminSearchInput.value.trim();
                if (searchVal) {
                    filteredRequests = requests.filter(req => req.request_id?.includes(searchVal) || req.applicant_name?.includes(searchVal));
                }
                
                if (filteredRequests.length === 0) {
                     requestsList.innerHTML = `<p class="text-center text-gray-500 py-8">目前沒有申請記錄。</p>`;
                     pendingCountBadge.classList.add('hidden');
                     return;
                }

                filteredRequests.forEach(req => {
                    requestsList.appendChild(buildRequestCard(req, true)); // true = admin view
                    if (req.dispatch_status === '待管理單位處理' || req.dispatch_status === '待申請單位主管簽核') {
                        pendingCount++;
                    }
                });
                
                if (pendingCount > 0) {
                    pendingCountBadge.textContent = pendingCount;
                    pendingCountBadge.classList.remove('hidden');
                } else {
                    pendingCountBadge.classList.add('hidden');
                }
            }

            function loadRequestForEdit(request) {
                clearForm();
                state.editingRequestId = request.id;
                
                // Set form fields
                requestIdInput.value = request.id;
                document.getElementById('display_request_id').value = request.request_id;
                document.getElementById('reason').value = request.reason || '';
                document.getElementById('destination').value = request.destination || '';
                document.getElementById('passengers').value = request.passengers || 0;
                document.getElementById('applicant_unit').value = request.applicant_unit || '';
                document.getElementById('cost_code').value = request.cost_code || '';
                document.getElementById('extension').value = request.extension || '';
                document.getElementById('contact_group').value = request.contact_group || '';
                document.getElementById('applicant_name').value = request.applicant_name || '';
                document.getElementById('remarks').value = request.remarks || '';
                
                // Admin fields
                document.getElementById('dispatch_status').value = request.dispatch_status || '待申請單位主管簽核';
                document.getElementById('approving_manager').value = request.approving_manager || '';
                document.getElementById('dispatch_method').value = request.dispatch_method || '';
                document.getElementById('driver_name').value = request.driver_name || '';
                document.getElementById('driver_phone').value = request.driver_phone || '';
                document.getElementById('admin_remarks').value = request.admin_remarks || '';


                // Dates
                const startTime = request.start_time?.toDate ? request.start_time.toDate() : (request.start_time || null);
                const endTime = request.end_time?.toDate ? request.end_time.toDate() : (request.end_time || null);
                document.getElementById('start_time').value = startTime ? new Date(startTime.getTime() - (startTime.getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : '';
                document.getElementById('end_time').value = endTime ? new Date(endTime.getTime() - (endTime.getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : '';
                
                // Radio buttons (vehicle_type)
                const vehicleRadio = document.querySelector(`input[name="vehicle_type"][value="${request.vehicle_type}"]`);
                if (vehicleRadio) vehicleRadio.checked = true;

                // Checkboxes (branch)
                document.querySelectorAll('input[name="branch"]').forEach(cb => cb.checked = false);
                if (request.branch) {
                    request.branch.split(',').map(b => b.trim()).forEach(branch => {
                        const branchCheckbox = document.querySelector(`input[name="branch"][value="${branch}"]`);
                        if (branchCheckbox) branchCheckbox.checked = true;
                    });
                }
                
                // Show admin fields in the form
                adminSection.classList.remove('hidden');
                submitBtn.textContent = '儲存修改';
                submitBtn.removeEventListener('click', handleSubmit);
                submitBtn.addEventListener('click', handleAdminUpdate);
                
                // Enable/disable fields based on login state
                const userFields = form.querySelectorAll('input:not(#display_request_id), textarea, select');
                const adminOnlyFields = [...adminFields, document.getElementById('dispatch_status'), document.getElementById('approving_manager')];

                userFields.forEach(field => {
                    field.disabled = !state.isLoggedIn;
                    if (state.isLoggedIn) {
                        field.classList.remove('disabled-input');
                    } else {
                        field.classList.add('disabled-input');
                    }
                });

                adminOnlyFields.forEach(field => {
                    if (state.isLoggedIn) {
                        field.disabled = false;
                        field.classList.remove('disabled-input');
                    }
                });

                // Override for manager deep link (can only approve/reject, not edit details)
                if (window.location.search.includes('id=') && !state.isLoggedIn) {
                    userFields.forEach(field => {
                        field.disabled = true;
                        field.classList.add('disabled-input');
                    });
                    
                    if (request.dispatch_status === '待申請單位主管簽核') {
                        promptManagerAction((status, managerName, managerRemarks) => {
                            handleManagerAction(request, status, managerName, managerRemarks);
                            clearForm();
                        });
                    } else {
                        showAlert(`此單號 ${request.request_id} 的申請狀態為「${request.dispatch_status}」，無需主管再次簽核。`, '狀態已更新');
                        clearForm();
                    }
                }
            }

            function clearForm() {
                form.reset();
                state.editingRequestId = null;
                requestIdInput.value = '';
                adminSection.classList.add('hidden');
                submitBtn.textContent = '提交新申請';
                submitBtn.removeEventListener('click', handleAdminUpdate);
                submitBtn.addEventListener('click', handleSubmit);
                
                // Ensure all fields are enabled for new applications
                form.querySelectorAll('input, textarea, select').forEach(field => {
                    field.disabled = false;
                    field.classList.remove('disabled-input');
                });
            }


            // STATS functions
            function updateStatsCharts(filteredRequests = state.requests) {
                if (!statsView.classList.contains('hidden')) {
                    const monthFilter = statsMonthFilter.value;
                    let displayRequests = filteredRequests;

                    if (monthFilter) {
                        const [year, month] = monthFilter.split('-');
                        displayRequests = filteredRequests.filter(req => {
                            const date = req.start_time?.toDate ? req.start_time.toDate() : new Date();
                            return date.getFullYear() == year && (date.getMonth() + 1) == month;
                        });
                    }
                    
                    statsTotalRequests.textContent = displayRequests.length;

                    const successfulRequests = displayRequests.filter(req => req.dispatch_status === '已派車');
                    
                    // 1. Driver Chart (Bar Chart)
                    const driverCounts = successfulRequests.reduce((acc, req) => {
                        if (req.driver_name) {
                            acc[req.driver_name] = (acc[req.driver_name] || 0) + 1;
                        }
                        return acc;
                    }, {});
                    driverChartInstance = renderBarChart(driverChartInstance, 'driver-chart', Object.keys(driverCounts), Object.values(driverCounts), '趟次');

                    // 2. Status Chart (Pie Chart)
                    const statusCounts = displayRequests.reduce((acc, req) => {
                        acc[req.dispatch_status] = (acc[req.dispatch_status] || 0) + 1;
                        return acc;
                    }, {});
                    statusChartInstance = renderPieChart(statusChartInstance, 'status-chart', Object.keys(statusCounts), Object.values(statusCounts));

                    // 3. Branch Chart (Doughnut Chart)
                    const branchCounts = displayRequests.reduce((acc, req) => {
                        if (req.branch) {
                            req.branch.split(',').map(b => b.trim()).forEach(branch => {
                                acc[branch] = (acc[branch] || 0) + 1;
                            });
                        }
                        return acc;
                    }, {});
                    branchChartInstance = renderDoughnutChart(branchChartInstance, 'branch-chart', Object.keys(branchCounts), Object.values(branchCounts));
                }
            }
            
            function renderBarChart(chart, canvasId, labels, data, label) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                if (chart) chart.destroy();
                
                return new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            function renderPieChart(chart, canvasId, labels, data) {
                 const ctx = document.getElementById(canvasId).getContext('2d');
                 if (chart) chart.destroy();
                 
                 const backgroundColors = labels.map(label => {
                    switch (label) {
                        case '待申請單位主管簽核': return '#e0e7ff';
                        case '主管退回': return '#FEF9C3';
                        case '待管理單位處理': return '#fef3c7';
                        case '已派車': return '#d1fae5';
                        case '案件取消': return '#fee2e2';
                        case '無法派車': return '#e5e7eb';
                        default: return '#cccccc';
                    }
                });

                 return new Chart(ctx, {
                     type: 'pie',
                     data: {
                         labels: labels,
                         datasets: [{
                             data: data,
                             backgroundColor: backgroundColors,
                             hoverOffset: 4
                         }]
                     },
                     options: { responsive: true, plugins: { legend: { position: 'right' } } }
                 });
            }

            function renderDoughnutChart(chart, canvasId, labels, data) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                if (chart) chart.destroy();
                
                const backgroundColors = labels.map((_, i) => [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444'
                ][i % 4]);

                return new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            hoverOffset: 4
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'right' } } }
                });
            }


            function exportToExcel() {
                const dataToExport = state.requests.map(req => ({
                    '申請單號': req.request_id,
                    '申請人': req.applicant_name,
                    '申請單位': req.applicant_unit,
                    '院區': req.branch,
                    '用車事由': req.reason,
                    '車輛種類': req.vehicle_type,
                    '駛達地點': req.destination,
                    '搭乘人數': req.passengers,
                    '開始時間': formatTimestamp(req.start_time),
                    '結束時間': formatTimestamp(req.end_time),
                    '聯絡分機': req.extension,
                    '費用部門代號': req.cost_code,
                    '狀態': req.dispatch_status,
                    '簽核主管': req.approving_manager,
                    '派車方式': req.dispatch_method,
                    '司機姓名': req.driver_name,
                    '司機電話': req.driver_phone,
                    '申請人備註': req.remarks,
                    '承辦備註': req.admin_remarks,
                    '建立時間': formatTimestamp(req.created_at)
                }));

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "派車申請記錄");

                const today = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(workbook, `派車申請記錄_${today}.xlsx`);
                showAlert('申請記錄已匯出為 Excel 檔案！', '匯出成功');
            }


            // ** UI Update and Tab Switching **
            function updateUI() {
                if (state.isLoggedIn) {
                    adminView.classList.remove('hidden');
                    adminLoginPrompt.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    statsView.classList.remove('hidden');
                    statsLoginPrompt.classList.add('hidden');
                    statsTabBtn.classList.remove('hidden'); // Show Stats tab
                } else {
                    adminView.classList.add('hidden');
                    adminLoginPrompt.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    statsView.classList.add('hidden');
                    statsLoginPrompt.classList.remove('hidden');
                    // statsTabBtn.classList.add('hidden'); // Optional: hide stats tab for non-admin
                }
            }
            
            function setActiveTab(tabName) {
                state.activeTab = tabName;
                tabContents.forEach(content => {
                    if (content.id === `tab-content-${tabName}`) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });
                tabButtons.forEach(btn => {
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // Special actions for tabs
                if (tabName === 'admin' && state.isLoggedIn) {
                    updateAdminList(state.requests);
                } else if (tabName === 'stats' && state.isLoggedIn) {
                     updateStatsCharts(state.requests);
                }
                clearForm(); // Always clear the form when switching away from apply/edit
            }
            
            // Check for deep link on load
            const urlParams = new URLSearchParams(window.location.search);
            const requestId = urlParams.get('id');
            if (requestId) {
                state.deepLinkedRequestId = requestId;
                // Will be handled in startRealtimeListener once data is fetched
            } else {
                setActiveTab('apply');
            }

            // ** Event Listeners **

            form.addEventListener('submit', handleSubmit);
            clearBtn.addEventListener('click', clearForm);
            
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.dataset.tab;
                    if ((tabName === 'admin' || tabName === 'stats') && !state.isLoggedIn) {
                        promptLogin();
                    } else {
                        setActiveTab(tabName);
                    }
                });
            });

            adminLoginPromptBtn.addEventListener('click', promptLogin);
            statsLoginPromptBtn.addEventListener('click', promptLogin);
            
            logoutBtn.addEventListener('click', () => {
                showConfirm('確定要登出管理員身分嗎？', (confirmed) => {
                    if (confirmed) {
                        state.isLoggedIn = false;
                        updateUI();
                        setActiveTab('apply');
                        showAlert('您已成功登出。', '登出');
                    }
                }, '登出確認');
            });
            
            // Search Tab functionality
            searchBtn.addEventListener('click', handleSearch);
            searchInput.addEventListener('keydown', (e) => {
                 if (e.key === 'Enter') handleSearch();
            });
            
            // Admin Search functionality
            adminSearchInput.addEventListener('input', () => {
                if (state.isLoggedIn) {
                    updateAdminList(state.requests);
                }
            });
            refreshAdminListBtn.addEventListener('click', () => {
                 if (state.isLoggedIn) {
                    updateAdminList(state.requests);
                    showAlert('申請列表已重新整理。', '重新整理');
                 }
            });

            // Stats functionality
            statsMonthFilter.addEventListener('change', () => {
                if (state.isLoggedIn) {
                    updateStatsCharts(state.requests);
                }
            });
            exportExcelBtn.addEventListener('click', exportToExcel);

        });
    </script>
</body>
</html>

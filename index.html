<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½³é‡Œå¥‡ç¾é†«é™¢æ´¾è»Šç”³è«‹ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .disabled-input {
            background-color: #f1f5f9;
            color: #64748b;
            cursor: not-allowed;
        }
        .request-card {
            transition: all 0.2s ease-in-out;
        }
        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
            text-transform: uppercase;
        }
        .status-manager-approval { background-color: #e0e7ff; color: #3730a3; }
        .status-manager-rejected { background-color: #FEF9C3; color: #713F12; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-dispatched { background-color: #d1fae5; color: #065f46; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }
        .status-rejected { background-color: #e5e7eb; color: #4b5563; }
        
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .animate-shake {
          animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes pulse-badge {
          50% { opacity: .6; }
        }
        .animate-pulse-badge {
          animation: pulse-badge 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .tab-btn {
            padding: 0.75rem 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }
        .tab-btn:hover {
            background-color: #f3f4f6;
        }
        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="w-full max-w-5xl mx-auto p-4 sm:p-6">
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <img src="chimei.png" alt="å¥‡ç¾é†«é™¢ Logo" class="h-12 sm:h-16">
                <h1 class="text-xl sm:text-3xl font-bold text-gray-800">æ´¾è»Šç”³è«‹ç³»çµ±</h1>
            </div>
        </header>

        <nav class="flex flex-wrap border-b border-gray-200 bg-white rounded-t-lg">
            <button data-tab="apply" class="tab-btn active text-sm sm:text-base font-medium">å¡«å¯«ç”³è«‹</button>
            <button data-tab="search" class="tab-btn text-sm sm:text-base font-medium">æŸ¥è©¢ç‹€æ…‹</button>
            <button data-tab="admin" class="tab-btn flex items-center text-sm sm:text-base font-medium">
                ç®¡ç†å¾Œå°
                <span id="pending-count" class="ml-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"></span>
            </button>
            <button data-tab="stats" class="tab-btn hidden text-sm sm:text-base font-medium">çµ±è¨ˆåˆ†æ</button>
        </nav>

        <main>
            <div id="tab-content-apply" class="tab-content bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <form id="dispatchForm" class="space-y-6">
                    <input type="hidden" id="request-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-6 border-t border-b border-gray-200 py-6">
                        <div class="lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700">é™¢å€</label>
                            <div id="branch-options" class="mt-2 flex flex-wrap items-center gap-4 sm:gap-6 text-sm sm:text-base text-gray-700">
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="branch" value="æ°¸åº·é™¢å€" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span>æ°¸åº·é™¢å€</span></label>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="branch" value="æŸ³ç‡Ÿé™¢å€" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span>æŸ³ç‡Ÿé™¢å€</span></label>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="branch" value="ä½³é‡Œé™¢å€" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span>ä½³é‡Œé™¢å€</span></label>
                            </div>
                        </div>
                        <div><label for="reason" class="block text-sm font-medium text-gray-700">ç”¨è»Šäº‹ç”±</label><input type="text" id="reason" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label class="block text-sm font-medium text-gray-700">è»Šè¼›ç¨®é¡</label><div class="mt-2 flex items-center space-x-6 text-sm sm:text-base"><label class="flex items-center space-x-2"><input type="radio" name="vehicle_type" value="ä¸­å·´" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><span>ä¸­å·´</span></label><label class="flex items-center space-x-2"><input type="radio" name="vehicle_type" value="å°å®¢" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><span>å°å®¢</span></label><label class="flex items-center space-x-2"><input type="radio" name="vehicle_type" value="å…¶ä»–" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><span>å…¶ä»–</span></label></div></div>
                        <div><label for="destination" class="block text-sm font-medium text-gray-700">é§›é”åœ°é»</label><input type="text" id="destination" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="passengers" class="block text-sm font-medium text-gray-700">æ­ä¹˜äººæ•¸</label><input type="number" id="passengers" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="start_time" class="block text-sm font-medium text-gray-700">é å®šæ´¾è»Šæ™‚é–“ (èµ·)</label><input type="datetime-local" id="start_time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                        <div><label for="end_time" class="block text-sm font-medium text-gray-700">é å®šæ´¾è»Šæ™‚é–“ (è¿„)</label><input type="datetime-local" id="end_time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                        <div><label for="applicant_unit" class="block text-sm font-medium text-gray-700">ç”³è«‹å–®ä½</label><input type="text" id="applicant_unit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="cost_code" class="block text-sm font-medium text-gray-700">è²»ç”¨éƒ¨é–€ä»£è™Ÿ</label><input type="text" id="cost_code" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="extension" class="block text-sm font-medium text-gray-700">è¯çµ¡åˆ†æ©Ÿ</label><input type="text" id="extension" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div><label for="contact_group" class="block text-sm font-medium text-gray-700">è¯çµ¡ç¾¤çµ„</label><input type="text" id="contact_group" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value=""></div>
                        <div class="md:col-span-2"><label for="applicant_name" class="block text-sm font-medium text-gray-700">ç”³è«‹äººå§“å</label><input type="text" id="applicant_name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="è«‹è¼¸å…¥å§“å"></div>
                        <div class="lg:col-span-3">
                            <label for="remarks" class="block text-sm font-medium text-gray-700">å‚™è¨»</label>
                            <textarea id="remarks" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="è‹¥æœ‰ç‰¹æ®Šéœ€æ±‚è«‹åœ¨æ­¤èªªæ˜..."></textarea>
                        </div>
                    </div>
                    
                    <div id="admin-section" class="hidden border-t border-gray-200 pt-6 mt-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">æ‰¿è¾¦å–®ä½è™•ç†ç‹€æ³</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div>
                                <label for="display_request_id" class="block text-sm font-medium text-gray-700">ç”³è«‹å–®è™Ÿ</label>
                                <input type="text" id="display_request_id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                            <div>
                                <label for="dispatch_status" class="block text-sm font-medium text-gray-700">è™•ç†ç‹€æ³</label>
                                <select id="dispatch_status" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                                    <option value="å¾…ç”³è«‹å–®ä½ä¸»ç®¡ç°½æ ¸">å¾…ç”³è«‹å–®ä½ä¸»ç®¡ç°½æ ¸</option>
                                    <option value="ä¸»ç®¡é€€å›">ä¸»ç®¡é€€å›</option>
                                    <option value="å¾…ç®¡ç†å–®ä½è™•ç†">å¾…ç®¡ç†å–®ä½è™•ç†</option>
                                    <option value="å·²æ´¾è»Š">å·²æ´¾è»Š</option>
                                    <option value="æ¡ˆä»¶å–æ¶ˆ">æ¡ˆä»¶å–æ¶ˆ</option>
                                    <option value="ç„¡æ³•æ´¾è»Š">ç„¡æ³•æ´¾è»Š</option>
                                </select>
                            </div>
                            <div>
                                <label for="approving_manager" class="block text-sm font-medium text-gray-700">ç°½æ ¸ä¸»ç®¡</label>
                                <input type="text" id="approving_manager" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                            <div>
                                <label for="dispatch_method" class="block text-sm font-medium text-gray-700">æ´¾è»Šæ–¹å¼</label>
                                <input type="text" id="dispatch_method" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                             <div>
                                <label for="driver_name" class="block text-sm font-medium text-gray-700">å¸æ©Ÿå§“å</label>
                                <input type="text" id="driver_name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                             <div>
                                <label for="driver_phone" class="block text-sm font-medium text-gray-700">å¸æ©Ÿé›»è©±</label>
                                <input type="text" id="driver_phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                            <div class="md:col-span-2">
                                <label for="admin_remarks" class="block text-sm font-medium text-gray-700">æ‰¿è¾¦å‚™è¨»</label>
                                <textarea id="admin_remarks" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="pt-6 text-center flex items-center justify-center space-x-4">
                        <button type="submit" id="submit-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-12 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">æäº¤æ–°ç”³è«‹</button>
                        <button type="button" id="clear-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-8 border border-gray-300 shadow-sm text-base font-medium rounded-full text-gray-700 bg-white hover:bg-gray-50">æ¸…ç©ºè¡¨å–®</button>
                    </div>
                </form>
            </div>

            <div id="tab-content-search" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-6">æŸ¥è©¢ç”³è«‹ç‹€æ…‹</h2>
                <div class="flex items-center space-x-2 mb-6">
                    <input type="text" id="search-input" placeholder="è«‹è¼¸å…¥ç”³è«‹äººå§“åæˆ–ç”³è«‹å–®è™Ÿé€²è¡ŒæŸ¥è©¢..." class="flex-grow block w-full px-4 py-2 bg-white border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <button id="search-btn" class="py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">æŸ¥è©¢</button>
                </div>
                <div id="search-results" class="space-y-4">
                    <p class="text-center text-gray-500">è«‹è¼¸å…¥å§“åæˆ–å–®è™Ÿä»¥æŸ¥è©¢æ‚¨çš„ç”³è«‹è¨˜éŒ„ã€‚</p>
                </div>
            </div>

            <div id="tab-content-admin" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <div id="admin-view">
                     <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4 gap-4">
                        <div class="flex items-center gap-2">
                            <h2 class="text-xl font-bold text-gray-800">æ‰€æœ‰æ´¾è»Šç”³è«‹</h2>
                            <button id="refresh-admin-list-btn" title="é‡æ–°æ•´ç†" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="w-5 h-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.691V5.25a8.25 8.25 0 00-11.664 0v4.992m11.664 0l-3.181-3.183" />
                                </svg>
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                             <input type="text" id="admin-search-input" placeholder="ä¾ç”³è«‹å–®è™ŸæŸ¥è©¢..." class="w-full sm:w-auto px-4 py-2 bg-white border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button id="logout-btn" class="hidden py-2 px-4 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">ç™»å‡º</button>
                     </div>
                     <div id="requests-list" class="space-y-4">
                          </div>
                </div>
                 <div id="admin-login-prompt" class="text-center py-10">
                    <p class="text-gray-600">æ­¤ç‚ºç®¡ç†å“¡å°ˆå€ï¼Œè«‹å…ˆç™»å…¥ã€‚</p>
                    <button id="admin-login-prompt-btn" class="mt-4 py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">ç«‹å³ç™»å…¥</button>
                </div>
            </div>

            <div id="tab-content-stats" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                 <div id="stats-view" class="hidden">
                     <div class="flex justify-between items-center mb-6 border-b pb-4">
                           <h2 class="text-xl font-bold text-gray-800">æ•¸æ“šçµ±è¨ˆåˆ†æ</h2>
                           <button id="export-excel-btn" class="py-2 px-4 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">åŒ¯å‡º Excel</button>
                     </div>

                     <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 p-4 bg-gray-50 rounded-lg">
                           <div class="flex items-center gap-2">
                                <label for="stats-month-filter" class="text-sm font-medium text-gray-700">ç¯©é¸æœˆä»½:</label>
                                <input type="month" id="stats-month-filter" class="border-gray-300 rounded-md shadow-sm p-2">
                           </div>
                           <div class="flex gap-4 text-center">
                                <div class="p-2">
                                    <p class="text-2xl font-bold text-blue-600" id="stats-total-requests">0</p>
                                    <p class="text-sm font-medium text-gray-500">ç¸½ç”³è«‹ç­†æ•¸</p>
                                </div>
                           </div>
                     </div>

                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                           <div class="p-4 border rounded-lg lg:col-span-2">
                                <h3 class="text-center font-semibold mb-4 text-gray-700">å„å¸æ©Ÿè¶Ÿæ¬¡çµ±è¨ˆ</h3>
                                <canvas id="driver-chart"></canvas>
                           </div>
                             <div class="p-4 border rounded-lg"><h3 class="text-center font-semibold mb-4 text-gray-700">ç”³è«‹ç‹€æ…‹åˆ†ä½ˆ</h3><canvas id="status-chart"></canvas></div>
                             <div class="p-4 border rounded-lg"><h3 class="text-center font-semibold mb-4 text-gray-700">å„é™¢å€ç”³è«‹é‡</h3><canvas id="branch-chart"></canvas></div>
                     </div>
                 </div>
                 <div id="stats-login-prompt" class="text-center py-10">
                      <p class="text-gray-600">æ­¤ç‚ºç®¡ç†å“¡å°ˆå€ï¼Œè«‹å…ˆç™»å…¥æŸ¥çœ‹çµ±è¨ˆæ•¸æ“šã€‚</p>
                      <button id="stats-login-prompt-btn" class="mt-4 py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">ç«‹å³ç™»å…¥</button>
                </div>
            </div>
        </main>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all">
            <h3 id="modal-title" class="text-lg font-medium text-gray-900">é€šçŸ¥</h3>
            <div id="modal-content" class="mt-2 text-sm text-gray-600"></div>
            <div id="modal-buttons" class="mt-5 sm:mt-6 flex justify-end space-x-3"></div>
        </div>
    </div>

    <script type="module">
        // --- FIREBASE CONFIGURATION (å·²ç½®æ›) ---
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "YOUR_NEW_API_KEY", // <--- ğŸ”‘ è«‹åœ¨é€™è£¡å¡«å…¥æ‚¨çš„æ–°é‡‘é‘°ï¼
          authDomain: "cch2500-5bbb6.firebaseapp.com",
          projectId: "cch2500-5bbb6",
          storageBucket: "cch2500-5bbb6.firebasestorage.app",
          messagingSenderId: "223711217941",
          appId: "1:223711217941:web:f14461ad89c0f9ca01c11c",
          measurementId: "G-59DEQT7HT0"
        };
        // --- END FIREBASE CONFIGURATION ---


        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, setLogLevel, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase
        let firebaseApp, auth, db;
        try {
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getFirestore(firebaseApp);
        } catch (e) {
             // æ•ç²åˆå§‹åŒ–éŒ¯èª¤ä¸¦é¡¯ç¤ºè¼‰å…¥éŒ¯èª¤è¨Šæ¯
            console.error("Firebase Initialization Failed:", e);
            window.addEventListener('load', () => {
                 showAlert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚', 'è¼‰å…¥éŒ¯èª¤');
            });
            // ææ—©é€€å‡ºï¼Œé˜²æ­¢å¾ŒçºŒä»£ç¢¼ä½¿ç”¨æœªå®šç¾©çš„ db/auth
            throw new Error("Firebase initialization failed. Check your config and network.");
        }


        window.addEventListener('load', () => {
            const state = {
                isLoggedIn: false,
                requests: [],
                editingRequestId: null,
                activeTab: 'apply',
                db: db, // Firestore instance
                auth: auth, // Auth instance
                deepLinkedRequestId: null,
            };
            
            let statusChartInstance, branchChartInstance, driverChartInstance;

            // --- CACHE ELEMENTS ---
            const form = document.getElementById('dispatchForm');
            const logoutBtn = document.getElementById('logout-btn');
            const submitBtn = document.getElementById('submit-btn');
            const clearBtn = document.getElementById('clear-btn');
            const requestIdInput = document.getElementById('request-id');
            const adminSection = document.getElementById('admin-section');
            const adminFields = ['dispatch_status', 'dispatch_method', 'driver_name', 'driver_phone', 'admin_remarks'].map(id => document.getElementById(id));
            
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            const adminView = document.getElementById('admin-view');
            const adminLoginPrompt = document.getElementById('admin-login-prompt');
            const adminLoginPromptBtn = document.getElementById('admin-login-prompt-btn');
            const requestsList = document.getElementById('requests-list');
            const pendingCountBadge = document.getElementById('pending-count');
            
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const searchResults = document.getElementById('search-results');
            const adminSearchInput = document.getElementById('admin-search-input');
            const refreshAdminListBtn = document.getElementById('refresh-admin-list-btn');

            const statsTabBtn = document.querySelector('button[data-tab="stats"]');
            const statsView = document.getElementById('stats-view');
            const statsLoginPrompt = document.getElementById('stats-login-prompt');
            const statsLoginPromptBtn = document.getElementById('stats-login-prompt-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const statsMonthFilter = document.getElementById('stats-month-filter');
            const statsTotalRequests = document.getElementById('stats-total-requests');

            // --- MODAL ELEMENTS & FUNCTIONS ---
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalButtons = document.getElementById('modal-buttons');

            function hideModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }
            function showAlert(message, title = 'é€šçŸ¥') { 
                modalTitle.textContent = title;
                modalContent.innerHTML = `<p>${message}</p>`;
                modalButtons.innerHTML = `<button id="modal-ok-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">ç¢ºå®š</button>`;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                const okBtn = document.getElementById('modal-ok-btn');
                okBtn.onclick = hideModal;
                okBtn.focus();
            }
           function showSuccessWithLink(message, link) {
                modalTitle.textContent = 'ç”³è«‹æˆåŠŸ';
                modalContent.innerHTML = `
                    <p>${message}</p>
                    <div class="mt-4">
                        <label for="approval-link" class="block text-sm font-medium text-gray-700 text-left">å°ˆå±¬ç°½æ ¸é€£çµ</label>
                        <input type="text" id="approval-link" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" value="${link}">
                    </div>
                `;
                modalButtons.innerHTML = `
                    <button id="modal-copy-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">è¤‡è£½é€£çµ</button>
                    <button id="modal-close-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">é—œé–‰</button>
                `;
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                const copyBtn = document.getElementById('modal-copy-btn');
                const closeBtn = document.getElementById('modal-close-btn');
                const linkInput = document.getElementById('approval-link');

                copyBtn.onclick = () => {
                    linkInput.select();
                    document.execCommand('copy');
                    copyBtn.textContent = 'å·²è¤‡è£½ï¼';
                    setTimeout(() => { copyBtn.textContent = 'è¤‡è£½é€£çµ'; }, 2000);
                };
                closeBtn.onclick = hideModal;
            }

            function showConfirm(message, callback, title = 'ç¢ºèªæ“ä½œ') {
                modalTitle.textContent = title;
                modalContent.innerHTML = `<p>${message}</p>`;
                modalButtons.innerHTML = `
                    <button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">å–æ¶ˆ</button>
                    <button id="modal-confirm-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none">ç¢ºå®š</button>
                `;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                const confirmBtn = document.getElementById('modal-confirm-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');
                confirmBtn.onclick = () => { hideModal(); if (callback) callback(true); };
                cancelBtn.onclick = () => { hideModal(); if (callback) callback(false); };
                confirmBtn.focus();
            }
            function promptLogin() {
                modalTitle.textContent = 'ç®¡ç†å“¡ç™»å…¥';
                modalContent.innerHTML = `<div class="space-y-4"><div><label for="modal-username" class="block text-sm font-medium text-gray-700 text-left">å¸³è™Ÿ</label><input type="text" id="modal-username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="modal-password" class="block text-sm font-medium text-gray-700 text-left">å¯†ç¢¼</label><input type="password" id="modal-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><p id="modal-error" class="text-sm text-red-600 h-4"></p></div>`;
                modalButtons.innerHTML = `<button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">å–æ¶ˆ</button><button id="modal-login-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">ç™»å…¥</button>`;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                const loginBtn = document.getElementById('modal-login-btn'), cancelBtn = document.getElementById('modal-cancel-btn'), usernameInput = document.getElementById('modal-username'), passwordInput = document.getElementById('modal-password'), errorEl = document.getElementById('modal-error');
                usernameInput.focus();
                const handleLogin = () => {
                    if (usernameInput.value === 'admin' && passwordInput.value === 'cch2500') {
                        hideModal(); state.isLoggedIn = true; showAlert('ç™»å…¥æˆåŠŸï¼'); updateUI(); setActiveTab('admin');
                    } else {
                        errorEl.textContent = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼'; const modalBox = modal.querySelector('div'); modalBox.classList.add('animate-shake'); setTimeout(() => { modalBox.classList.remove('animate-shake'); }, 500);
                    }
                };
                loginBtn.onclick = handleLogin;
                passwordInput.onkeydown = (e) => { if (e.key === 'Enter') handleLogin(); };
                usernameInput.onkeydown = (e) => { if (e.key === 'Enter') passwordInput.focus(); };
                cancelBtn.onclick = hideModal;
            }

            function promptManagerAction(callback) {
                modalTitle.textContent = 'ä¸»ç®¡ç°½æ ¸';
                modalContent.innerHTML = `
                    <p class="mb-4">è«‹è¼¸å…¥æ‚¨çš„å§“åä¸¦æä¾›å‚™è¨» (éå¿…å¡«)ã€‚</p>
                    <div class="space-y-4">
                        <div>
                            <label for="modal-manager-name" class="block text-sm font-medium text-gray-700 text-left">ä¸»ç®¡å§“å</label>
                            <input type="text" id="modal-manager-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="modal-manager-remarks" class="block text-sm font-medium text-gray-700 text-left">å‚™è¨»</label>
                            <textarea id="modal-manager-remarks" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="è‹¥é€€å›ç”³è«‹ï¼Œè«‹èªªæ˜åŸå› ..."></textarea>
                        </div>
                        <p id="modal-error" class="text-sm text-red-600 h-4 mt-1"></p>
                    </div>`;
                modalButtons.innerHTML = `
                    <button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">å–æ¶ˆ</button>
                    <button id="modal-reject-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-yellow-600 text-base font-medium text-white hover:bg-yellow-700 focus:outline-none">é€€å›ç”³è«‹</button>
                    <button id="modal-approve-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none">æ ¸å‡†é€šé</button>
                `;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                const nameInput = document.getElementById('modal-manager-name');
                const remarksInput = document.getElementById('modal-manager-remarks');
                const errorEl = document.getElementById('modal-error');

                const handleAction = (isApproved) => {
                    if (!nameInput.value.trim()) {
                         errorEl.textContent = 'è«‹è¼¸å…¥æ‚¨çš„å§“åä»¥é€²è¡Œç°½æ ¸ï¼';
                         const modalBox = modal.querySelector('div'); 
                         modalBox.classList.add('animate-shake'); 
                         setTimeout(() => { modalBox.classList.remove('animate-shake'); }, 500);
                         return;
                    }
                    if (!isApproved && !remarksInput.value.trim()) {
                         errorEl.textContent = 'é€€å›ç”³è«‹è«‹å‹™å¿…å¡«å¯«å‚™è¨»èªªæ˜åŸå› ï¼';
                         const modalBox = modal.querySelector('div'); 
                         modalBox.classList.add('animate-shake'); 
                         setTimeout(() => { modalBox.classList.remove('animate-shake'); }, 500);
                         return;
                    }
                    hideModal(); 
                    callback(isApproved, nameInput.value.trim(), remarksInput.value.trim());
                };
                
                document.getElementById('modal-approve-btn').onclick = () => handleAction(true);
                document.getElementById('modal-reject-btn').onclick = () => handleAction(false);
                document.getElementById('modal-cancel-btn').onclick = hideModal;
                nameInput.focus();
            }

            // --- DATE/TIME UTILITIES ---
            function formatDate(timestamp) {
                if (!timestamp || typeof timestamp.toDate !== 'function') return 'N/A';
                const date = timestamp.toDate();
                return date.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
            }

            // --- UI UPDATE FUNCTIONS ---
            function setActiveTab(tabName) {
                state.activeTab = tabName;
                tabButtons.forEach(btn => {
                    const contentName = btn.getAttribute('data-tab');
                    const content = document.getElementById(`tab-content-${contentName}`);
                    
                    if (contentName === tabName) {
                        btn.classList.add('active');
                        content.classList.remove('hidden');
                        if (tabName === 'admin') {
                            updateAdminView();
                        } else if (tabName === 'stats') {
                            updateStatsView();
                        }
                    } else {
                        btn.classList.remove('active');
                        content.classList.add('hidden');
                    }
                });
            }

            function updateAdminView() {
                if (state.isLoggedIn) {
                    adminLoginPrompt.classList.add('hidden');
                    adminView.classList.remove('hidden');
                    logoutBtn.classList.remove('hidden');
                    statsTabBtn.classList.remove('hidden');
                } else {
                    adminLoginPrompt.classList.remove('hidden');
                    adminView.classList.add('hidden');
                    logoutBtn.classList.add('hidden');
                    statsTabBtn.classList.add('hidden');
                }
            }

            function updateStatsView() {
                if (state.isLoggedIn) {
                    statsLoginPrompt.classList.add('hidden');
                    statsView.classList.remove('hidden');
                    renderCharts(state.requests, statsMonthFilter.value);
                } else {
                    statsLoginPrompt.classList.remove('hidden');
                    statsView.classList.add('hidden');
                }
            }

            function updateUI() {
                updateAdminView();
                updateStatsView();
            }

            // --- FORM HANDLING ---
            function clearForm(resetAdmin = true) {
                form.reset();
                requestIdInput.value = '';
                submitBtn.textContent = 'æäº¤æ–°ç”³è«‹';
                submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-red-600', 'hover:bg-red-700');
                submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                
                if (resetAdmin) {
                     adminSection.classList.add('hidden');
                     adminFields.forEach(el => {
                        el.value = '';
                        el.classList.add('disabled-input');
                        el.disabled = true;
                     });
                     document.getElementById('display_request_id').value = '';
                }
                state.editingRequestId = null;
            }

            function validateForm(data) {
                const requiredFields = {
                    branch: 'è«‹é¸æ“‡è‡³å°‘ä¸€å€‹é™¢å€',
                    reason: 'è«‹å¡«å¯«ç”¨è»Šäº‹ç”±',
                    vehicle_type: 'è«‹é¸æ“‡è»Šè¼›ç¨®é¡',
                    destination: 'è«‹å¡«å¯«é§›é”åœ°é»',
                    passengers: 'è«‹å¡«å¯«æ­ä¹˜äººæ•¸',
                    start_time: 'è«‹å¡«å¯«é å®šæ´¾è»Šæ™‚é–“ (èµ·)',
                    end_time: 'è«‹å¡«å¯«é å®šæ´¾è»Šæ™‚é–“ (è¿„)',
                    applicant_unit: 'è«‹å¡«å¯«ç”³è«‹å–®ä½',
                    cost_code: 'è«‹å¡«å¯«è²»ç”¨éƒ¨é–€ä»£è™Ÿ',
                    extension: 'è«‹å¡«å¯«è¯çµ¡åˆ†æ©Ÿ',
                    applicant_name: 'è«‹å¡«å¯«ç”³è«‹äººå§“å'
                };

                for (const key in requiredFields) {
                    if (!data[key] || (Array.isArray(data[key]) && data[key].length === 0) || (typeof data[key] === 'string' && data[key].trim() === '')) {
                        showAlert(requiredFields[key], 'æ¬„ä½éŒ¯èª¤');
                        return false;
                    }
                }
                
                // æª¢æŸ¥æ™‚é–“ç¯„åœ
                const start = new Date(data.start_time);
                const end = new Date(data.end_time);
                if (start >= end) {
                    showAlert('ã€Œé å®šæ´¾è»Šæ™‚é–“ (è¿„)ã€å¿…é ˆæ™šæ–¼ã€Œé å®šæ´¾è»Šæ™‚é–“ (èµ·)ã€', 'æ™‚é–“éŒ¯èª¤');
                    return false;
                }
                if (start < new Date()) {
                    showAlert('ç”³è«‹çš„èµ·å§‹æ™‚é–“ä¸èƒ½æ˜¯éå»çš„æ™‚é–“ï¼', 'æ™‚é–“éŒ¯èª¤');
                    return false;
                }

                return true;
            }

            async function handleSubmit(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const data = {
                    id: requestIdInput.value || null,
                    branch: Array.from(document.querySelectorAll('input[name="branch"]:checked')).map(el => el.value),
                    reason: formData.get('reason'),
                    vehicle_type: formData.get('vehicle_type'),
                    destination: formData.get('destination'),
                    passengers: parseInt(formData.get('passengers')),
                    start_time: formData.get('start_time'),
                    end_time: formData.get('end_time'),
                    applicant_unit: formData.get('applicant_unit'),
                    cost_code: formData.get('cost_code'),
                    extension: formData.get('extension'),
                    contact_group: formData.get('contact_group') || '',
                    applicant_name: formData.get('applicant_name'),
                    remarks: formData.get('remarks') || '',
                    
                    // Admin fields (only for updating)
                    dispatch_status: formData.get('dispatch_status'),
                    dispatch_method: formData.get('dispatch_method') || '',
                    driver_name: formData.get('driver_name') || '',
                    driver_phone: formData.get('driver_phone') || '',
                    admin_remarks: formData.get('admin_remarks') || '',
                };

                if (!validateForm(data)) return;
                
                // Prepare final data for submission
                const submitData = {
                    ...data,
                    // Convert time strings to Firebase Timestamps
                    start_time: new Date(data.start_time),
                    end_time: new Date(data.end_time),
                };
                delete submitData.id;

                try {
                    if (data.id) {
                         // --- Update Existing Request (Admin Use) ---
                        const currentRequest = state.requests.find(r => r.id === data.id);
                        if (!currentRequest) throw new Error("ç”³è«‹å–®ä¸å­˜åœ¨ã€‚");

                        // åªæ›´æ–°æœ‰ä¿®æ”¹çš„æ¬„ä½ (Admin only updates)
                        const updatePayload = {
                             updated_at: serverTimestamp(),
                             dispatch_status: data.dispatch_status,
                             dispatch_method: data.dispatch_method,
                             driver_name: data.driver_name,
                             driver_phone: data.driver_phone,
                             admin_remarks: data.admin_remarks,
                        };

                        await updateDoc(doc(state.db, "requests", data.id), updatePayload);
                        showAlert('ç”³è«‹å–®æ›´æ–°æˆåŠŸï¼', 'æ›´æ–°æˆåŠŸ');
                        setActiveTab('admin');
                        clearForm();
                    } else {
                         // --- Submit New Request ---
                         submitData.status = 'å¾…ç”³è«‹å–®ä½ä¸»ç®¡ç°½æ ¸';
                         submitData.created_at = serverTimestamp();
                         submitData.approving_manager = '';

                        const docRef = await addDoc(collection(state.db, "requests"), submitData);
                        
                        // ç”Ÿæˆç°½æ ¸é€£çµ
                        const approvalLink = `${window.location.origin}${window.location.pathname}?rid=${docRef.id}&action=approve`;

                        showSuccessWithLink(`æ‚¨çš„ç”³è«‹å·²æäº¤ï¼Œå–®è™Ÿç‚ºï¼š${docRef.id}ã€‚è«‹å°‡ä»¥ä¸‹é€£çµæä¾›çµ¦æ‚¨çš„ç›´å±¬ä¸»ç®¡é€²è¡Œç°½æ ¸ã€‚`, approvalLink);
                        clearForm();
                        
                        // å°èˆªåˆ°æŸ¥è©¢é é¢
                        setActiveTab('search');
                        searchInput.value = data.applicant_name;
                        performSearch();
                    }
                } catch (error) {
                    console.error("Error submitting request: ", error);
                    showAlert(`æäº¤å¤±æ•—ï¼š${error.message}`, 'éŒ¯èª¤');
                }
            }
            
            // --- FIREBASE LISTENERS (Admin List) ---
            function setupAdminListener() {
                if (!state.db) return;
                
                // è¨‚é–± 'requests' collection çš„å³æ™‚æ›´æ–°
                const q = query(collection(state.db, "requests"));
                
                onSnapshot(q, (snapshot) => {
                    state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰ Deep Link è«‹æ±‚
                    if (state.deepLinkedRequestId) {
                        handleDeepLink();
                        state.deepLinkedRequestId = null; // è™•ç†å®Œç•¢å¾Œæ¸…é™¤
                    }

                    renderAdminList();
                    updatePendingCount();
                    if (state.isLoggedIn && state.activeTab === 'stats') {
                        renderCharts(state.requests, statsMonthFilter.value);
                    }
                }, (error) => {
                    console.error("Error listening to Firestore:", error);
                    if (error.code === 'permission-denied') {
                         showAlert('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•è®€å–ç”³è«‹åˆ—è¡¨ã€‚', 'æ¬Šé™éŒ¯èª¤');
                    } else if (error.code === 'failed-precondition') {
                         // åœ¨æŸäº›ç’°å¢ƒä¸­ï¼Œæœªç™»å…¥ä¹Ÿå¯èƒ½è§¸ç™¼é€™å€‹éŒ¯èª¤
                         // ä½†æˆ‘å€‘å·²ç¶“æœ‰ç™»å…¥æ©Ÿåˆ¶ï¼Œæ­¤è™•ä¸»è¦è™•ç†å…¶ä»–é¡å‹éŒ¯èª¤
                    } else {
                         showAlert('ç„¡æ³•è¼‰å…¥ç”³è«‹åˆ—è¡¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚', 'é€£ç·šéŒ¯èª¤');
                    }
                });
            }
            
            // --- ADMIN UI RENDERING ---
            function renderAdminList(filterId = null) {
                let requestsToRender = state.requests.slice().sort((a, b) => {
                     // è®“ "å¾…ç”³è«‹å–®ä½ä¸»ç®¡ç°½æ ¸" å„ªå…ˆé¡¯ç¤º
                     const statusOrder = {
                         'å¾…ç”³è«‹å–®ä½ä¸»ç®¡ç°½æ ¸': 1,
                         'ä¸»ç®¡é€€å›': 2,
                         'å¾…ç®¡ç†å–®ä½è™•ç†': 3,
                         'å·²æ´¾è»Š': 4,
                         'ç„¡æ³•æ´¾è»Š': 5,
                         'æ¡ˆä»¶å–æ¶ˆ': 6,
                     };
                     return statusOrder[a.status] - statusOrder[b.status];
                });
                
                if (filterId) {
                    requestsToRender = requestsToRender.filter(r => r.id.toLowerCase().includes(filterId.toLowerCase()));
                }

                if (requestsToRender.length === 0) {
                    requestsList.innerHTML = `<p class="text-center text-gray-500 py-6">${filterId ? 'æ‰¾ä¸åˆ°ç›¸ç¬¦çš„ç”³è«‹å–®è™Ÿã€‚' : 'ç›®å‰æ²’æœ‰ä»»ä½•ç”³è«‹è¨˜éŒ„ã€‚'}</p>`;
                    return;
                }

                requestsList.innerHTML = requestsToRender.map(request => {
                    const statusClass = {
                        'å¾…ç”³è«‹å–®ä½ä¸»ç®¡ç°½æ ¸': 'status-pending animate-pulse-badge',
                        'ä¸»ç®¡é€€å›': 'status-manager-rejected',
                        'å¾…ç®¡ç†å–®ä½è™•ç†': 'status-manager-approval',
                        'å·²æ´¾è»Š': 'status-dispatched',
                        'ç„¡æ³•æ´¾è»Š': 'status-rejected',
                        'æ¡ˆä»¶å–æ¶ˆ': 'status-cancelled',
                    }[request.status] || 'status-rejected';
                    
                    // ç¢ºå®šé¡¯ç¤ºçš„å–®è™Ÿ
                    const displayId = request.id.substring(0, 8); // åƒ…é¡¯ç¤ºå‰ 8 ç¢¼

                    return `
                        <div data-id="${request.id}" class="request-card bg-white border border-gray-200 p-4 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="mb-2 sm:mb-0">
                                <p class="text-xs text-gray-400">å–®è™Ÿ: ${displayId}</p>
                                <p class="text-lg font-semibold text-gray-800">${request.applicant_name} <span class="text-sm font-normal text-gray-500 ml-1">(${request.applicant_unit})</span></p>
                                <p class="text-sm text-gray-600">${request.reason} | ${request.destination}</p>
                            </div>
                            <div class="flex flex-col items-start sm:items-end space-y-2">
                                <span class="status-badge ${statusClass}">${request.status}</span>
                                <div class="flex space-x-2">
                                    <button data-action="edit" data-id="${request.id}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">ç·¨è¼¯</button>
                                    <button data-action="delete" data-id="${request.id}" class="text-red-600 hover:text-red-800 text-sm font-medium">åˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                requestsList.querySelectorAll('button[data-action="edit"]').forEach(btn => btn.onclick = handleEditRequest);
                requestsList.querySelectorAll('button[data-action="delete"]').forEach(btn => btn.onclick = handleDeleteRequest);
            }
            
            function updatePendingCount() {
                const pendingCount = state.requests.filter(r => r.status === 'å¾…ç®¡ç†å–®ä½è™•ç†').length;
                if (pendingCount > 0) {
                    pendingCountBadge.textContent = pendingCount;
                    pendingCountBadge.classList.remove('hidden');
                } else {
                    pendingCountBadge.classList.add('hidden');
                }
            }

            function handleEditRequest(e) {
                const id = e.currentTarget.getAttribute('data-id');
                const request = state.requests.find(r => r.id === id);
                if (!request) return showAlert('æ‰¾ä¸åˆ°è©²ç”³è«‹å–®ï¼');

                clearForm(false); // ä¸æ¸…é™¤ admin æ¬„ä½ï¼Œå› ç‚ºè¦è¼‰å…¥è³‡æ–™

                // å°èˆªå›å¡«å¯«é 
                setActiveTab('apply');

                // è¼‰å…¥è¡¨å–®è³‡æ–™ (ç”³è«‹äººéƒ¨åˆ†)
                requestIdInput.value = request.id;
                document.getElementById('reason').value = request.reason;
                document.getElementById('destination').value = request.destination;
                document.getElementById('passengers').value = request.passengers;
                document.getElementById('applicant_unit').value = request.applicant_unit;
                document.getElementById('cost_code').value = request.cost_code;
                document.getElementById('extension').value = request.extension;
                document.getElementById('contact_group').value = request.contact_group;
                document.getElementById('applicant_name').value = request.applicant_name;
                document.getElementById('remarks').value = request.remarks;

                // è™•ç†æ™‚é–“ (éœ€è¦è½‰æ›æ ¼å¼)
                document.getElementById('start_time').value = new Date(request.start_time.seconds * 1000).toISOString().slice(0, 16);
                document.getElementById('end_time').value = new Date(request.end_time.seconds * 1000).toISOString().slice(0, 16);

                // è™•ç†å¤šé¸/å–®é¸
                document.querySelectorAll('input[name="branch"]').forEach(el => {
                    el.checked = request.branch.includes(el.value);
                });
                document.querySelectorAll('input[name="vehicle_type"]').forEach(el => {
                    el.checked = el.value === request.vehicle_type;
                });
                
                // è¼‰å…¥ Admin æ¬„ä½ (ä¸¦å•Ÿç”¨)
                adminSection.classList.remove('hidden');
                document.getElementById('display_request_id').value = request.id;
                
                adminFields.forEach(el => {
                    const key = el.id;
                    const value = request[key] || '';
                    el.value = value;
                    el.classList.remove('disabled-input');
                    el.disabled = false;
                });
                
                // è™•ç†ç°½æ ¸ä¸»ç®¡æ¬„ä½ (åªé¡¯ç¤ºï¼Œä¸å…è¨±ç®¡ç†å“¡ç·¨è¼¯)
                document.getElementById('approving_manager').value = request.approving_manager || 'æœªç°½æ ¸';
                document.getElementById('approving_manager').classList.add('disabled-input');
                document.getElementById('approving_manager').disabled = true;

                // æ›´æ–°æŒ‰éˆ•æ–‡å­—å’Œé¡è‰²
                submitBtn.textContent = 'æ›´æ–°æ´¾è»Šç‹€æ…‹';
                submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                state.editingRequestId = id;
            }

            function handleDeleteRequest(e) {
                const id = e.currentTarget.getAttribute('data-id');
                showConfirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ç”³è«‹å–®è™Ÿ ${id.substring(0, 8)} å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            await deleteDoc(doc(state.db, "requests", id));
                            showAlert('ç”³è«‹å–®å·²æˆåŠŸåˆªé™¤ï¼', 'åˆªé™¤æˆåŠŸ');
                        } catch (error) {
                            console.error("Error deleting document: ", error);
                            showAlert(`åˆªé™¤å¤±æ•—ï¼š${error.message}`, 'éŒ¯èª¤');
                        }
                    }
                }, 'åˆªé™¤ç¢ºèª');
            }

            // --- SEARCH FUNCTIONALITY ---
            function renderSearchResults(results) {
                if (results.length === 0) {
                    searchResults.innerHTML = `<p class="text-center text-gray-500 py-6">æ‰¾ä¸åˆ°ç›¸ç¬¦çš„ç”³è«‹è¨˜éŒ„ã€‚</p>`;
                    return;
                }

                searchResults.innerHTML = results.map(request => {
                    const statusClass = {
                        'å¾…ç”³è«‹å–®ä½ä¸»ç®¡ç°½æ ¸': 'status-pending',
                        'ä¸»ç®¡é€€å›': 'status-manager-rejected',
                        'å¾…ç®¡ç†å–®ä½è™•ç†': 'status-manager-approval',
                        'å·²æ´¾è»Š': 'status-dispatched',
                        'ç„¡æ³•æ´¾è»Š': 'status-rejected',
                        'æ¡ˆä»¶å–æ¶ˆ': 'status-cancelled',
                    }[request.status] || 'status-rejected';

                    return `
                        <div class="request-card bg-white border border-gray-200 p-4 rounded-lg shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-xs text-gray-400">å–®è™Ÿ: ${request.id.substring(0, 8)}</p>
                                <span class="status-badge ${statusClass}">${request.status}</span>
                            </div>
                            <p class="text-lg font-semibold text-gray-800">${request.reason}</p>
                            <p class="text-sm text-gray-600"><strong>ç”³è«‹äºº:</strong> ${request.applicant_name} (${request.applicant_unit})</p>
                            <p class="text-sm text-gray-600"><strong>æ™‚é–“:</strong> ${formatDate(request.start_time)} è‡³ ${formatDate(request.end_time)}</p>
                            <p class="text-sm text-gray-600"><strong>åœ°é»:</strong> ${request.destination}</p>
                            ${request.approving_manager ? `<p class="text-xs text-gray-500 mt-2">ä¸»ç®¡ç°½æ ¸: ${request.approving_manager}</p>` : ''}
                            ${request.admin_remarks ? `<p class="text-xs text-gray-500">æ‰¿è¾¦å‚™è¨»: ${request.admin_remarks}</p>` : ''}
                            ${(request.status === 'å¾…ç”³è«‹å–®ä½ä¸»ç®¡ç°½æ ¸' || request.status === 'ä¸»ç®¡é€€å›') ? `
                                <div class="mt-4">
                                     <button data-id="${request.id}" class="manager-link-btn text-blue-600 hover:text-blue-800 text-sm font-medium">å–å¾—ä¸»ç®¡ç°½æ ¸é€£çµ</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
                searchResults.querySelectorAll('.manager-link-btn').forEach(btn => {
                     btn.onclick = (e) => {
                         const id = e.currentTarget.getAttribute('data-id');
                         const link = `${window.location.origin}${window.location.pathname}?rid=${id}&action=approve`;
                         showSuccessWithLink('è«‹å°‡ä»¥ä¸‹é€£çµæä¾›çµ¦æ‚¨çš„ç›´å±¬ä¸»ç®¡é€²è¡Œç°½æ ¸ï¼š', link);
                     };
                });
            }

            function performSearch() {
                const query = searchInput.value.trim().toLowerCase();
                if (!query) {
                    searchResults.innerHTML = `<p class="text-center text-gray-500">è«‹è¼¸å…¥å§“åæˆ–å–®è™Ÿä»¥æŸ¥è©¢æ‚¨çš„ç”³è«‹è¨˜éŒ„ã€‚</p>`;
                    return;
                }

                const results = state.requests.filter(request => {
                    const matchesName = request.applicant_name.toLowerCase().includes(query);
                    const matchesId = request.id.toLowerCase().includes(query);
                    return matchesName || matchesId;
                }).sort((a, b) => b.created_at.seconds - a.created_at.seconds); // æœ€æ–°æäº¤çš„åœ¨æœ€å‰é¢

                renderSearchResults(results);
            }
            
            // --- DEEP LINK / MANAGER APPROVAL ---
            function handleDeepLink() {
                const urlParams = new URLSearchParams(window.location.search);
                const requestId = urlParams.get('rid');
                const action = urlParams.get('action');

                if (requestId && action === 'approve') {
                    // æª¢æŸ¥å–®æ“šæ˜¯å¦å­˜åœ¨
                    const request = state.requests.find(r => r.id === requestId);
                    if (!request) {
                        showAlert('æ‰¾ä¸åˆ°å°æ‡‰çš„ç”³è«‹å–®ï¼Œå–®è™Ÿå¯èƒ½éŒ¯èª¤æˆ–å·²è¢«åˆªé™¤ã€‚', 'éŒ¯èª¤');
                        return;
                    }
                    
                    // æª¢æŸ¥ç‹€æ…‹
                    if (request.status !== 'å¾…ç”³è«‹å–®ä½ä¸»ç®¡ç°½æ ¸' && request.status !== 'ä¸»ç®¡é€€å›') {
                        showAlert(`æ­¤ç”³è«‹å–®å·²ç”± **${request.approving_manager || 'æ‰¿è¾¦å–®ä½'}** è™•ç†ï¼Œç‹€æ…‹ç‚º **${request.status}**ï¼Œç„¡æ³•é‡è¤‡ç°½æ ¸ã€‚`, 'ç‹€æ…‹éŒ¯èª¤');
                        return;
                    }

                    // å°èˆªåˆ°å¡«å¯«é 
                    setActiveTab('apply');
                    
                    // è¼‰å…¥è³‡æ–™ä½†é–å®šæ¬„ä½ï¼Œåªé¡¯ç¤ºç°½æ ¸åŠŸèƒ½
                    loadForManagerApproval(request);
                }
            }

            function loadForManagerApproval(request) {
                clearForm(false);
                
                // é–å®šæ‰€æœ‰ç”³è«‹æ¬„ä½
                const allApplyFields = form.querySelectorAll('input, select, textarea');
                allApplyFields.forEach(el => {
                     if (el.id !== 'applicant_name' && el.id !== 'applicant_unit' && el.name !== 'branch' && el.name !== 'vehicle_type' && el.id !== 'admin_remarks' && el.id !== 'dispatch_status') {
                         el.disabled = true;
                         el.classList.add('disabled-input');
                     }
                });
                
                 // è¼‰å…¥è¡¨å–®è³‡æ–™ (èˆ‡ Admin Edit ç›¸ä¼¼ï¼Œä½†æ¬„ä½é–å®š)
                requestIdInput.value = request.id;
                document.getElementById('reason').value = request.reason;
                document.getElementById('destination').value = request.destination;
                document.getElementById('passengers').value = request.passengers;
                document.getElementById('applicant_unit').value = request.applicant_unit;
                document.getElementById('cost_code').value = request.cost_code;
                document.getElementById('extension').value = request.extension;
                document.getElementById('contact_group').value = request.contact_group;
                document.getElementById('applicant_name').value = request.applicant_name;
                document.getElementById('remarks').value = request.remarks;

                document.getElementById('start_time').value = new Date(request.start_time.seconds * 1000).toISOString().slice(0, 16);
                document.getElementById('end_time').value = new Date(request.end_time.seconds * 1000).toISOString().slice(0, 16);

                document.querySelectorAll('input[name="branch"]').forEach(el => {
                    el.checked = request.branch.includes(el.value);
                    el.disabled = true; // é–å®š
                });
                document.querySelectorAll('input[name="vehicle_type"]').forEach(el => {
                    el.checked = el.value === request.vehicle_type;
                    el.disabled = true; // é–å®š
                });

                // ç§»é™¤æäº¤æŒ‰éˆ•ï¼Œæ›¿æ›ç‚ºç°½æ ¸æŒ‰éˆ•
                submitBtn.classList.add('hidden');
                clearBtn.classList.add('hidden');
                
                // é¡¯ç¤ºç°½æ ¸/é€€å›æŒ‰éˆ•
                const buttonContainer = document.querySelector('.pt-6.text-center');
                buttonContainer.innerHTML = `
                    <button type="button" id="manager-approve-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-12 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">æ ¸å‡†é€šé</button>
                    <button type="button" id="manager-reject-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-8 border border-gray-300 shadow-sm text-base font-medium rounded-full text-gray-700 bg-yellow-400 hover:bg-yellow-500">é€€å›ç”³è«‹</button>
                `;
                
                document.getElementById('manager-approve-btn').onclick = () => handleManagerAction(request.id, true);
                document.getElementById('manager-reject-btn').onclick = () => handleManagerAction(request.id, false);
            }

            function handleManagerAction(id, isApproved) {
                 promptManagerAction(async (confirmed, managerName, remarks) => {
                     if (confirmed) {
                         // confirmed is always true here, we check action inside promptManagerAction
                     } else {
                         // Should not happen based on promptManagerAction's logic, but safe fail
                         return;
                     }

                     try {
                         const newStatus = isApproved ? 'å¾…ç®¡ç†å–®ä½è™•ç†' : 'ä¸»ç®¡é€€å›';
                         const updatePayload = {
                             status: newStatus,
                             approving_manager: managerName,
                             admin_remarks: remarks,
                             manager_action_at: serverTimestamp()
                         };
                         
                         await updateDoc(doc(state.db, "requests", id), updatePayload);
                         
                         if (isApproved) {
                             showAlert(`ç”³è«‹å–® **${id.substring(0, 8)}** å·²æˆåŠŸæ ¸å‡†é€šéï¼`, 'æ ¸å‡†æˆåŠŸ');
                         } else {
                             showAlert(`ç”³è«‹å–® **${id.substring(0, 8)}** å·²é€€å›ï¼ŒåŸå› ï¼š${remarks}`, 'é€€å›æˆåŠŸ');
                         }
                         
                         // é‡æ–°è¼‰å…¥é é¢ä»¥æ¸…é™¤ URL åƒæ•¸å’Œç°½æ ¸æŒ‰éˆ•
                         window.location.href = window.location.pathname;
                         
                     } catch (error) {
                         console.error("Error updating manager status: ", error);
                         showAlert(`è™•ç†å¤±æ•—ï¼š${error.message}`, 'éŒ¯èª¤');
                     }
                 });
            }


            // --- STATS / CHARTING ---
            function initializeCharts() {
                const defaultOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                };

                statusChartInstance = new Chart(document.getElementById('status-chart'), { type: 'pie', data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false } });
                branchChartInstance = new Chart(document.getElementById('branch-chart'), { type: 'doughnut', data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false } });
                driverChartInstance = new Chart(document.getElementById('driver-chart'), { type: 'bar', data: { labels: [], datasets: [] }, options: defaultOptions });
            }
            
            function renderCharts(requests, monthFilterValue) {
                if (!statsView.classList.contains('hidden')) {
                    const filteredRequests = filterRequestsByMonth(requests, monthFilterValue);
                    statsTotalRequests.textContent = filteredRequests.length;
                    
                    renderStatusChart(filteredRequests);
                    renderBranchChart(filteredRequests);
                    renderDriverChart(filteredRequests);
                }
            }
            
            function filterRequestsByMonth(requests, monthValue) {
                if (!monthValue) return requests;
                
                const [filterYear, filterMonth] = monthValue.split('-').map(Number); // filterMonth is 1-based (1-12)
                
                return requests.filter(request => {
                    if (!request.created_at || !request.created_at.toDate) return false;
                    const date = request.created_at.toDate();
                    return date.getFullYear() === filterYear && (date.getMonth() + 1) === filterMonth;
                });
            }

            function renderStatusChart(requests) {
                const statusCounts = requests.reduce((acc, r) => {
                    acc[r.status] = (acc[r.status] || 0) + 1;
                    return acc;
                }, {});

                const labels = Object.keys(statusCounts);
                const data = Object.values(statusCounts);
                const colors = labels.map(label => {
                    if (label === 'å·²æ´¾è»Š') return '#065f46';
                    if (label === 'å¾…ç®¡ç†å–®ä½è™•ç†') return '#3730a3';
                    if (label === 'å¾…ç”³è«‹å–®ä½ä¸»ç®¡ç°½æ ¸') return '#92400e';
                    if (label === 'ä¸»ç®¡é€€å›') return '#713F12';
                    if (label === 'æ¡ˆä»¶å–æ¶ˆ') return '#991b1b';
                    return '#4b5563';
                });

                statusChartInstance.data = {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 4
                    }]
                };
                statusChartInstance.update();
            }

            function renderBranchChart(requests) {
                const branchCounts = requests.reduce((acc, r) => {
                    r.branch.forEach(b => {
                        acc[b] = (acc[b] || 0) + 1;
                    });
                    return acc;
                }, {});

                const labels = Object.keys(branchCounts);
                const data = Object.values(branchCounts);
                const colors = ['#3b82f6', '#10b981', '#f59e0b'];

                branchChartInstance.data = {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 4
                    }]
                };
                branchChartInstance.update();
            }

             function renderDriverChart(requests) {
                // éæ¿¾æ‰æœªæ´¾è»Šã€å·²å–æ¶ˆçš„
                const dispatchedRequests = requests.filter(r => r.driver_name && r.status === 'å·²æ´¾è»Š');

                const driverCounts = dispatchedRequests.reduce((acc, r) => {
                    const name = r.driver_name || 'æœªæŒ‡æ´¾';
                    acc[name] = (acc[name] || 0) + 1;
                    return acc;
                }, {});

                const labels = Object.keys(driverCounts);
                const data = Object.values(driverCounts);
                
                // æ’åºï¼Œè¶Ÿæ¬¡å¤šçš„æ’å‰é¢
                const sorted = labels.map((label, index) => ({label, data: data[index]}))
                                     .sort((a, b) => b.data - a.data);
                                     
                const sortedLabels = sorted.map(item => item.label);
                const sortedData = sorted.map(item => item.data);
                
                // çµ±ä¸€é¡è‰²
                const colors = sortedLabels.map(() => '#4f46e5'); // Indigo color

                driverChartInstance.data = {
                    labels: sortedLabels,
                    datasets: [{
                        label: 'æ´¾è»Šè¶Ÿæ¬¡',
                        data: sortedData,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('e5', 'cc')), // Slightly darker border
                        borderWidth: 1
                    }]
                };
                driverChartInstance.update();
            }

            // --- EXCEL EXPORT ---
            function exportToExcel() {
                const monthValue = statsMonthFilter.value;
                const filteredRequests = filterRequestsByMonth(state.requests, monthValue);
                
                if (filteredRequests.length === 0) {
                     return showAlert('æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚', 'åŒ¯å‡ºå¤±æ•—');
                }

                const dataForExport = filteredRequests.map(r => ({
                    'å–®è™Ÿ': r.id,
                    'ç”³è«‹äºº': r.applicant_name,
                    'ç”³è«‹å–®ä½': r.applicant_unit,
                    'è¯çµ¡åˆ†æ©Ÿ': r.extension,
                    'é™¢å€': r.branch.join(','),
                    'ç”¨è»Šäº‹ç”±': r.reason,
                    'é§›é”åœ°é»': r.destination,
                    'æ­ä¹˜äººæ•¸': r.passengers,
                    'è»Šè¼›ç¨®é¡': r.vehicle_type,
                    'é å®šæ™‚é–“ (èµ·)': formatDate(r.start_time),
                    'é å®šæ™‚é–“ (è¿„)': formatDate(r.end_time),
                    'ç”³è«‹ç‹€æ…‹': r.status,
                    'ç°½æ ¸ä¸»ç®¡': r.approving_manager || 'N/A',
                    'æ´¾è»Šæ–¹å¼': r.dispatch_method || 'N/A',
                    'å¸æ©Ÿå§“å': r.driver_name || 'N/A',
                    'å¸æ©Ÿé›»è©±': r.driver_phone || 'N/A',
                    'è²»ç”¨ä»£è™Ÿ': r.cost_code,
                    'å‚™è¨»': r.remarks,
                    'æ‰¿è¾¦å‚™è¨»': r.admin_remarks || 'N/A',
                    'ç”³è«‹æ™‚é–“': formatDate(r.created_at)
                }));

                const worksheet = XLSX.utils.json_to_sheet(dataForExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "æ´¾è»Šç”³è«‹æ•¸æ“š");
                
                const monthString = monthValue ? monthValue.replace('-', '') : 'All';
                XLSX.writeFile(workbook, `æ´¾è»Šç”³è«‹_${monthString}.xlsx`);
            }

            // --- EVENT LISTENERS ---
            form.addEventListener('submit', handleSubmit);
            clearBtn.addEventListener('click', () => clearForm(true));

            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    setActiveTab(btn.getAttribute('data-tab'));
                });
            });

            adminLoginPromptBtn.addEventListener('click', promptLogin);
            statsLoginPromptBtn.addEventListener('click', promptLogin);
            logoutBtn.addEventListener('click', () => {
                state.isLoggedIn = false;
                showAlert('å·²ç™»å‡ºã€‚', 'é€šçŸ¥');
                updateUI();
                setActiveTab('apply');
            });
            
            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keydown', (e) => {
                 if (e.key === 'Enter') performSearch();
            });
            
            adminSearchInput.addEventListener('input', (e) => {
                 renderAdminList(e.target.value.trim());
            });
            
            refreshAdminListBtn.addEventListener('click', () => {
                 renderAdminList(); // é‡æ–°æ¸²æŸ“æ•´å€‹åˆ—è¡¨
                 showAlert('åˆ—è¡¨å·²é‡æ–°è¼‰å…¥ã€‚', 'é‡æ–°æ•´ç†');
            });
            
            exportExcelBtn.addEventListener('click', exportToExcel);
            
            statsMonthFilter.addEventListener('change', (e) => {
                 renderCharts(state.requests, e.target.value);
            });


            // --- INITIALIZATION ---
            function init() {
                // æª¢æŸ¥ URL ä¸­çš„ Deep Link åƒæ•¸
                const urlParams = new URLSearchParams(window.location.search);
                const requestId = urlParams.get('rid');
                const action = urlParams.get('action');
                
                if (requestId && action === 'approve') {
                     // å¦‚æœæ˜¯ Deep Link è«‹æ±‚ï¼Œå…ˆè¨˜éŒ„ä¸‹ä¾†ï¼Œç­‰æ•¸æ“šè¼‰å…¥å¾Œå†è™•ç†
                     state.deepLinkedRequestId = requestId;
                     setActiveTab('apply'); // åˆ‡æ›åˆ°ç”³è«‹é é¢æº–å‚™è¼‰å…¥è¡¨å–®
                } else {
                     // é»˜èªè¨­å®š tab
                     setActiveTab('apply');
                }
                
                // åˆå§‹åŒ–åœ–è¡¨
                initializeCharts();

                // å•Ÿå‹• Firebase å³æ™‚ç›£è½
                setupAdminListener();
                
                // è¨­ç½®æœˆä»½ç¯©é¸å™¨é»˜èªç‚ºç•¶å‰æœˆä»½
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                statsMonthFilter.value = `${year}-${month}`;
            }

            init();
        });
    </script>
</body>
</html>

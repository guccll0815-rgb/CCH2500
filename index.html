<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>佳里奇美醫院派車申請系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .disabled-input {
            background-color: #f1f5f9;
            color: #64748b;
            cursor: not-allowed;
        }
        .request-card {
            transition: all 0.2s ease-in-out;
        }
        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
            text-transform: uppercase;
        }
        .status-manager-approval { background-color: #e0e7ff; color: #3730a3; } /* 待申請單位主管簽核 */
        .status-manager-rejected { background-color: #FEF9C3; color: #713F12; } /* 主管退回 */
        .status-pending { background-color: #fef3c7; color: #92400e; } /* 待管理單位處理 */
        .status-dispatched { background-color: #d1fae5; color: #065f46; } /* 已派車 */
        .status-cancelled { background-color: #fee2e2; color: #991b1b; } /* 案件取消 */
        .status-rejected { background-color: #e5e7eb; color: #4b5563; } /* 無法派車 */
        
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .animate-shake {
          animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes pulse-badge {
          50% { opacity: .6; }
        }
        .animate-pulse-badge {
          animation: pulse-badge 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .tab-btn {
            padding: 0.75rem 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }
        .tab-btn:hover {
            background-color: #f3f4f6;
        }
        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="w-full max-w-5xl mx-auto p-4 sm:p-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/>
                </svg>
                <h1 class="text-xl sm:text-3xl font-bold text-gray-800">派車申請系統</h1>
            </div>
            <p id="auth-status" class="text-xs text-gray-500">訪客模式</p>
        </header>
        <!-- Tab Navigation -->
        <nav class="flex flex-wrap border-b border-gray-200 bg-white rounded-t-lg">
            <button data-tab="apply" class="tab-btn active text-sm sm:text-base font-medium">填寫申請</button>
            <button data-tab="search" class="tab-btn text-sm sm:text-base font-medium">查詢狀態</button>
            <button data-tab="admin" class="tab-btn flex items-center text-sm sm:text-base font-medium">
                管理後台
                <span id="pending-count" class="ml-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden animate-pulse-badge"></span>
            </button>
            <button data-tab="stats" class="tab-btn hidden text-sm sm:text-base font-medium">統計分析</button>
        </nav>
        <main>
            <!-- Apply Tab -->
            <div id="tab-content-apply" class="tab-content bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <form id="dispatchForm" class="space-y-6">
                    <input type="hidden" id="request-id">
                    <!-- Form Fields Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-6 border-t border-b border-gray-200 py-6">
                        <div class="lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700">院區 (可複選)</label>
                            <div id="branch-options" class="mt-2 flex flex-wrap items-center gap-4 sm:gap-6 text-sm sm:text-base text-gray-700">
                                  <label class="flex items-center space-x-2"><input type="checkbox" name="branch" value="總院" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span>總院</span></label>
                                  <label class="flex items-center space-x-2"><input type="checkbox" name="branch" value="柳營院區" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span>柳營院區</span></label>
                                  <label class="flex items-center space-x-2"><input type="checkbox" name="branch" value="佳里院區" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span>佳里院區</span></label>
                            </div>
                        </div>
                        <div><label for="reason" class="block text-sm font-medium text-gray-700">用車事由 <span class="text-red-500">*</span></label><input type="text" id="reason" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                        <div><label class="block text-sm font-medium text-gray-700">車輛種類 <span class="text-red-500">*</span></label><div class="mt-2 flex items-center space-x-6 text-sm sm:text-base"><label class="flex items-center space-x-2"><input type="radio" name="vehicle_type" value="中巴" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" required><span>中巴</span></label><label class="flex items-center space-x-2"><input type="radio" name="vehicle_type" value="小客" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><span>小客</span></label><label class="flex items-center space-x-2"><input type="radio" name="vehicle_type" value="其他" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><span>其他</span></label></div></div>
                        <div><label for="destination" class="block text-sm font-medium text-gray-700">駛達地點 <span class="text-red-500">*</span></label><input type="text" id="destination" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                        <div><label for="passengers" class="block text-sm font-medium text-gray-700">搭乘人數 <span class="text-red-500">*</span></label><input type="number" id="passengers" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" min="1" required></div>
                        <div><label for="start_time" class="block text-sm font-medium text-gray-700">預定派車時間 (起) <span class="text-red-500">*</span></label><input type="datetime-local" id="start_time" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                        <div><label for="end_time" class="block text-sm font-medium text-gray-700">預定派車時間 (迄) <span class="text-red-500">*</span></label><input type="datetime-local" id="end_time" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                        <div><label for="applicant_unit" class="block text-sm font-medium text-gray-700">申請單位 <span class="text-red-500">*</span></label><input type="text" id="applicant_unit" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                        <div><label for="cost_code" class="block text-sm font-medium text-gray-700">費用部門代號</label><input type="text" id="cost_code" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                        <div><label for="extension" class="block text-sm font-medium text-gray-700">聯絡分機 <span class="text-red-500">*</span></label><input type="text" id="extension" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div>
                        <div><label for="contact_group" class="block text-sm font-medium text-gray-700">聯絡群組</label><input type="text" id="contact_group" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                        <div class="md:col-span-2"><label for="applicant_name" class="block text-sm font-medium text-gray-700">申請人姓名 <span class="text-red-500">*</span></label><input type="text" id="applicant_name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="請輸入姓名" required></div>
                        <div class="lg:col-span-3">
                            <label for="remarks" class="block text-sm font-medium text-gray-700">備註</label>
                            <textarea id="remarks" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="若有特殊需求請在此說明..."></textarea>
                        </div>
                    </div>
                    
                    <div id="admin-section" class="hidden border-t border-gray-200 pt-6 mt-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">承辦單位處理狀況</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div>
                                <label for="display_request_id" class="block text-sm font-medium text-gray-700">申請單號</label>
                                <input type="text" id="display_request_id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input" readonly>
                            </div>
                            <div>
                                <label for="dispatch_status" class="block text-sm font-medium text-gray-700">處理狀況</label>
                                <select id="dispatch_status" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled-input" disabled>
                                    <option value="待申請單位主管簽核">待申請單位主管簽核</option>
                                    <option value="主管退回">主管退回</option>
                                    <option value="待管理單位處理">待管理單位處理</option>
                                    <option value="已派車">已派車</option>
                                    <option value="案件取消">案件取消</option>
                                    <option value="無法派車">無法派車</option>
                                </select>
                            </div>
                            <div>
                                <label for="approving_manager" class="block text-sm font-medium text-gray-700">簽核主管</label>
                                <input type="text" id="approving_manager" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input" readonly>
                            </div>
                            <div>
                                <label for="dispatch_method" class="block text-sm font-medium text-gray-700">派車方式</label>
                                <input type="text" id="dispatch_method" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                             <div>
                                <label for="driver_name" class="block text-sm font-medium text-gray-700">司機姓名</label>
                                <input type="text" id="driver_name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                             <div>
                                <label for="driver_phone" class="block text-sm font-medium text-gray-700">司機電話</label>
                                <input type="text" id="driver_phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                            <div class="md:col-span-2">
                                <label for="admin_remarks" class="block text-sm font-medium text-gray-700">承辦備註</label>
                                <textarea id="admin_remarks" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input"></textarea>
                            </div>
                        </div>
                         <div id="admin-actions" class="pt-6 text-center flex items-center justify-center space-x-4">
                            <button type="button" id="admin-update-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-12 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50" disabled>更新派車狀況</button>
                            <button type="button" id="admin-close-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-8 border border-gray-300 shadow-sm text-base font-medium rounded-full text-gray-700 bg-white hover:bg-gray-50">返回列表</button>
                        </div>
                    </div>
                    <div id="applicant-actions" class="pt-6 text-center flex items-center justify-center space-x-4">
                        <button type="submit" id="submit-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-12 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">提交新申請</button>
                        <button type="button" id="clear-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-8 border border-gray-300 shadow-sm text-base font-medium rounded-full text-gray-700 bg-white hover:bg-gray-50">清空表單</button>
                        <button type="button" id="cancel-request-btn" class="hidden w-full sm:w-auto inline-flex justify-center py-3 px-8 border border-red-300 shadow-sm text-base font-medium rounded-full text-red-700 bg-red-50 hover:bg-red-100">取消此申請</button>
                    </div>
                </form>
            </div>
            <!-- Search Tab -->
            <div id="tab-content-search" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-6">查詢申請狀態</h2>
                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-2 mb-6">
                    <input type="text" id="search-input" placeholder="請輸入申請人姓名或單號進行查詢..." class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <button id="search-btn" class="w-full sm:w-auto py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">查詢</button>
                </div>
                <div id="search-results" class="space-y-4">
                    <p class="text-center text-gray-500">請輸入姓名或單號以查詢您的申請記錄。</p>
                </div>
            </div>
            <!-- Admin Tab -->
            <div id="tab-content-admin" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <div id="admin-view" class="hidden">
                     <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4 gap-4">
                        <div class="flex items-center gap-2">
                            <h2 class="text-xl font-bold text-gray-800">所有派車申請</h2>
                            <button id="refresh-admin-list-btn" title="重新整理" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="w-5 h-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.691V5.25a8.25 8.25 0 00-11.664 0v4.992m11.664 0l-3.181-3.183" />
                                </svg>
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                             <input type="text" id="admin-search-input" placeholder="依申請單號查詢..." class="w-full sm:w-auto px-4 py-2 bg-white border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button id="logout-btn" class="py-2 px-4 bg-red-600 text-white rounded-full text-sm font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">登出管理員</button>
                     </div>
                     <div id="requests-list" class="space-y-4">
                         <p class="text-center text-gray-500">載入中...</p>
                     </div>
                </div>
                 <div id="admin-login-prompt" class="text-center py-10">
                    <p class="text-gray-600">此為管理員專區，請先登入。</p>
                    <button id="admin-login-prompt-btn" class="mt-4 py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">立即登入</button>
                </div>
            </div>
            <!-- Stats Tab -->
            <div id="tab-content-stats" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                 <div id="stats-view" class="hidden">
                     <div class="flex justify-between items-center mb-6 border-b pb-4">
                         <h2 class="text-xl font-bold text-gray-800">數據統計分析</h2>
                         <button id="export-excel-btn" class="py-2 px-4 bg-green-600 text-white rounded-full text-sm font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">匯出 Excel</button>
                     </div>
                     <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 p-4 bg-gray-50 rounded-lg">
                         <div class="flex items-center gap-2">
                             <label for="stats-month-filter" class="text-sm font-medium text-gray-700">篩選月份:</label>
                             <input type="month" id="stats-month-filter" class="border-gray-300 rounded-md shadow-sm p-2">
                         </div>
                         <div class="flex gap-4 text-center">
                             <div class="p-2">
                                 <p class="text-2xl font-bold text-blue-600" id="stats-total-requests">0</p>
                                 <p class="text-sm font-medium text-gray-500">總申請筆數</p>
                             </div>
                         </div>
                     </div>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                         <div class="p-4 border rounded-lg lg:col-span-2">
                             <h3 class="text-center font-semibold mb-4 text-gray-700">各司機趟次統計 (已派車)</h3>
                             <canvas id="driver-chart"></canvas>
                         </div>
                          <div class="p-4 border rounded-lg"><h3 class="text-center font-semibold mb-4 text-gray-700">申請狀態分佈 (總數)</h3><canvas id="status-chart"></canvas></div>
                          <div class="p-4 border rounded-lg"><h3 class="text-center font-semibold mb-4 text-gray-700">各院區申請量 (總數)</h3><canvas id="branch-chart"></canvas></div>
                     </div>
                 </div>
                 <div id="stats-login-prompt" class="text-center py-10">
                     <p class="text-gray-600">此為管理員專區，請先登入查看統計數據。</p>
                     <button id="stats-login-prompt-btn" class="mt-4 py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">立即登入</button>
                 </div>
            </div>
        </main>
    </div>
    <!-- Custom Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all">
            <h3 id="modal-title" class="text-lg font-medium text-gray-900">通知</h3>
            <div id="modal-content" class="mt-2 text-sm text-gray-600"></div>
            <div id="modal-buttons" class="mt-5 sm:mt-6 flex justify-end space-x-3"></div>
        </div>
    </div>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, setLogLevel, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.addEventListener('load', () => {
            const state = {
                isLoggedIn: false, // For local admin login
                requests: [], // All requests from Firestore
                editingRequestId: null,
                activeTab: 'apply',
                db: null,
                auth: null,
                userId: 'anonymous',
                isFirebaseReady: false,
                deepLinkedRequestId: null,
                adminSearchTerm: '',
            };
            
            // Log level for debugging Firestore issues
            // setLogLevel('Debug');
            
            let statusChartInstance, branchChartInstance, driverChartInstance;
            
            // --- CACHE ELEMENTS ---
            const form = document.getElementById('dispatchForm');
            const logoutBtn = document.getElementById('logout-btn');
            const submitBtn = document.getElementById('submit-btn');
            const clearBtn = document.getElementById('clear-btn');
            const cancelRequestBtn = document.getElementById('cancel-request-btn');
            const requestIdInput = document.getElementById('request-id');
            const adminSection = document.getElementById('admin-section');
            const adminActions = document.getElementById('admin-actions');
            const applicantActions = document.getElementById('applicant-actions');
            const adminUpdateBtn = document.getElementById('admin-update-btn');
            const adminCloseBtn = document.getElementById('admin-close-btn');

            const adminFields = {
                dispatch_status: document.getElementById('dispatch_status'),
                dispatch_method: document.getElementById('dispatch_method'),
                driver_name: document.getElementById('driver_name'),
                driver_phone: document.getElementById('driver_phone'),
                admin_remarks: document.getElementById('admin_remarks'),
                display_request_id: document.getElementById('display_request_id'),
                approving_manager: document.getElementById('approving_manager')
            };
            
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            const adminView = document.getElementById('admin-view');
            const adminLoginPrompt = document.getElementById('admin-login-prompt');
            const adminLoginPromptBtn = document.getElementById('admin-login-prompt-btn');
            const requestsList = document.getElementById('requests-list');
            const pendingCountBadge = document.getElementById('pending-count');
            
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const searchResults = document.getElementById('search-results');
            const adminSearchInput = document.getElementById('admin-search-input');
            const refreshAdminListBtn = document.getElementById('refresh-admin-list-btn');
            const statsTabBtn = document.querySelector('button[data-tab="stats"]');
            const statsView = document.getElementById('stats-view');
            const statsLoginPrompt = document.getElementById('stats-login-prompt');
            const statsLoginPromptBtn = document.getElementById('stats-login-prompt-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const statsMonthFilter = document.getElementById('stats-month-filter');
            const statsTotalRequests = document.getElementById('stats-total-requests');
            const authStatusEl = document.getElementById('auth-status');

            // --- CONSTANTS ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const FIREBASE_COLLECTION_PATH = `artifacts/${appId}/public/data/car_requests`;
            const STATUS_CODES = {
                MANAGER_APPROVAL: '待申請單位主管簽核',
                MANAGER_REJECTED: '主管退回',
                PENDING_DISPATCH: '待管理單位處理',
                DISPATCHED: '已派車',
                CANCELLED: '案件取消',
                REJECTED: '無法派車'
            };
            
            // --- MODAL ELEMENTS & FUNCTIONS ---
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalButtons = document.getElementById('modal-buttons');
            
            function hideModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }
            
            function showAlert(message, title = '通知', type = 'info') { 
                const bg = type === 'error' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700';
                modalTitle.textContent = title;
                modalContent.innerHTML = `<p>${message}</p>`;
                modalButtons.innerHTML = `<button id="modal-ok-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 ${bg} text-base font-medium text-white focus:outline-none">確定</button>`;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                const okBtn = document.getElementById('modal-ok-btn');
                okBtn.onclick = hideModal;
                okBtn.focus();
            }

           function showSuccessWithLink(message, link) {
                modalTitle.textContent = '申請成功';
                modalContent.innerHTML = `
                    <p>${message}</p>
                    <div class="mt-4">
                        <label for="approval-link" class="block text-sm font-medium text-gray-700 text-left">專屬簽核連結</label>
                        <input type="text" id="approval-link" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" value="${link}">
                    </div>
                `;
                modalButtons.innerHTML = `
                    <button id="modal-copy-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">複製連結</button>
                    <button id="modal-close-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">關閉</button>
                `;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                const copyBtn = document.getElementById('modal-copy-btn');
                const closeBtn = document.getElementById('modal-close-btn');
                const linkInput = document.getElementById('approval-link');
                
                linkInput.onfocus = () => linkInput.select();

                copyBtn.onclick = () => {
                    linkInput.select();
                    try {
                         document.execCommand('copy');
                         copyBtn.textContent = '已複製！';
                         setTimeout(() => { copyBtn.textContent = '複製連結'; }, 2000);
                    } catch (err) {
                        console.error('Copy failed:', err);
                        showAlert('複製失敗，請手動複製連結。', '錯誤', 'error');
                    }
                };
                closeBtn.onclick = hideModal;
            }

            function showConfirm(message, callback, title = '確認操作') {
                modalTitle.textContent = title;
                modalContent.innerHTML = `<p>${message}</p>`;
                modalButtons.innerHTML = `
                    <button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">取消</button>
                    <button id="modal-confirm-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none">確定</button>
                `;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                const confirmBtn = document.getElementById('modal-confirm-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');
                confirmBtn.onclick = () => { hideModal(); if (callback) callback(true); };
                cancelBtn.onclick = () => { hideModal(); if (callback) callback(false); };
                confirmBtn.focus();
            }

            function promptLogin() {
                modalTitle.textContent = '管理員登入';
                modalContent.innerHTML = `<div class="space-y-4"><div><label for="modal-username" class="block text-sm font-medium text-gray-700 text-left">帳號</label><input type="text" id="modal-username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="modal-password" class="block text-sm font-medium text-gray-700 text-left">密碼</label><input type="password" id="modal-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><p id="modal-error" class="text-sm text-red-600 h-4"></p></div>`;
                modalButtons.innerHTML = `<button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">取消</button><button id="modal-login-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">登入</button>`;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                const loginBtn = document.getElementById('modal-login-btn'), cancelBtn = document.getElementById('modal-cancel-btn'), usernameInput = document.getElementById('modal-username'), passwordInput = document.getElementById('modal-password'), errorEl = document.getElementById('modal-error');
                usernameInput.value = 'admin'; // Pre-fill admin for testing ease
                usernameInput.focus();
                
                const handleLogin = () => {
                    // Simple hardcoded credential check for the "admin" role
                    if (usernameInput.value === 'admin' && passwordInput.value === 'cch2500') {
                        hideModal(); 
                        state.isLoggedIn = true; 
                        showAlert('管理員登入成功！', '登入成功'); 
                        updateUI(); 
                        setActiveTab('admin');
                    } else {
                        errorEl.textContent = '帳號或密碼錯誤！'; 
                        const modalBox = modal.querySelector('div'); 
                        modalBox.classList.add('animate-shake'); 
                        setTimeout(() => { modalBox.classList.remove('animate-shake'); }, 500);
                    }
                };
                loginBtn.onclick = handleLogin;
                passwordInput.onkeydown = (e) => { if (e.key === 'Enter') handleLogin(); };
                usernameInput.onkeydown = (e) => { if (e.key === 'Enter') passwordInput.focus(); };
                cancelBtn.onclick = hideModal;
            }

            function promptManagerAction(requestId, currentStatus, callback) {
                modalTitle.textContent = '主管簽核';
                modalContent.innerHTML = `
                    <p class="mb-4 text-left">您正在對申請單號 <strong class="text-blue-600">${requestId}</strong> 進行簽核。請輸入您的姓名並提供備註 (非必填)。</p>
                    <div class="space-y-4">
                        <div>
                            <label for="modal-manager-name" class="block text-sm font-medium text-gray-700 text-left">主管姓名 <span class="text-red-500">*</span></label>
                            <input type="text" id="modal-manager-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="modal-manager-remarks" class="block text-sm font-medium text-gray-700 text-left">備註</label>
                            <textarea id="modal-manager-remarks" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="若退回申請，請說明原因..."></textarea>
                        </div>
                        <p id="modal-error" class="text-sm text-red-600 h-4 mt-1"></p>
                    </div>`;
                modalButtons.innerHTML = `
                    <button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">取消</button>
                    <button id="modal-reject-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-yellow-600 text-base font-medium text-white hover:bg-yellow-700 focus:outline-none">退回申請</button>
                    <button id="modal-confirm-approve-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">核准通過</button>
                `;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                const managerNameInput = document.getElementById('modal-manager-name');
                const remarksInput = document.getElementById('modal-manager-remarks');
                const errorEl = document.getElementById('modal-error');
                
                managerNameInput.focus();

                const approveBtn = document.getElementById('modal-confirm-approve-btn');
                const rejectBtn = document.getElementById('modal-reject-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');

                const validateAndCallback = (actionType) => {
                    const managerName = managerNameInput.value.trim();
                    const remarks = remarksInput.value.trim();
                    if (!managerName) {
                        errorEl.textContent = '請輸入主管姓名！';
                        managerNameInput.focus();
                        return;
                    }
                    if (actionType === 'reject' && !remarks) {
                        errorEl.textContent = '退回申請需填寫備註說明退回原因！';
                        remarksInput.focus();
                        return;
                    }

                    hideModal();
                    callback(actionType, managerName, remarks);
                };

                approveBtn.onclick = () => validateAndCallback('approve');
                rejectBtn.onclick = () => validateAndCallback('reject');
                cancelBtn.onclick = hideModal;
            }

            function promptAdminAction(requestId, currentData, callback) {
                modalTitle.textContent = '管理員派車處理';
                modalContent.innerHTML = `
                    <p class="mb-4 text-left">您正在處理申請單號 <strong class="text-blue-600">${requestId}</strong>。請更新處理狀態及派車資訊。</p>
                    <div class="space-y-4">
                        <div>
                            <label for="modal-admin-status" class="block text-sm font-medium text-gray-700 text-left">處理狀態 <span class="text-red-500">*</span></label>
                            <select id="modal-admin-status" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="${STATUS_CODES.PENDING_DISPATCH}">待管理單位處理</option>
                                <option value="${STATUS_CODES.DISPATCHED}">已派車</option>
                                <option value="${STATUS_CODES.REJECTED}">無法派車</option>
                            </select>
                        </div>
                         <div>
                            <label for="modal-dispatch-method" class="block text-sm font-medium text-gray-700 text-left">派車方式</label>
                            <input type="text" id="modal-dispatch-method" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="例如：自駕、委外計程車">
                        </div>
                        <div>
                            <label for="modal-driver-name" class="block text-sm font-medium text-gray-700 text-left">司機姓名</label>
                            <input type="text" id="modal-driver-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="modal-driver-phone" class="block text-sm font-medium text-gray-700 text-left">司機電話</label>
                            <input type="text" id="modal-driver-phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="modal-admin-remarks" class="block text-sm font-medium text-gray-700 text-left">承辦備註</label>
                            <textarea id="modal-admin-remarks" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="請填寫派車細節或無法派車原因..."></textarea>
                        </div>
                        <p id="modal-error" class="text-sm text-red-600 h-4 mt-1"></p>
                    </div>`;
                modalButtons.innerHTML = `
                    <button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">取消</button>
                    <button id="modal-admin-confirm-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none">更新狀態</button>
                `;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // Pre-fill fields
                const statusSelect = document.getElementById('modal-admin-status');
                const methodInput = document.getElementById('modal-dispatch-method');
                const driverNameInput = document.getElementById('modal-driver-name');
                const driverPhoneInput = document.getElementById('modal-driver-phone');
                const remarksInput = document.getElementById('modal-admin-remarks');
                
                statusSelect.value = currentData.dispatch_status || STATUS_CODES.PENDING_DISPATCH;
                methodInput.value = currentData.dispatch_method || '';
                driverNameInput.value = currentData.driver_name || '';
                driverPhoneInput.value = currentData.driver_phone || '';
                remarksInput.value = currentData.admin_remarks || '';
                
                statusSelect.focus();

                const confirmBtn = document.getElementById('modal-admin-confirm-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');
                const errorEl = document.getElementById('modal-error');
                
                confirmBtn.onclick = () => {
                    const newStatus = statusSelect.value;
                    const method = methodInput.value.trim();
                    const driverName = driverNameInput.value.trim();
                    const driverPhone = driverPhoneInput.value.trim();
                    const remarks = remarksInput.value.trim();

                    if (newStatus === STATUS_CODES.REJECTED && !remarks) {
                         errorEl.textContent = '若無法派車，請在備註中說明原因。';
                         remarksInput.focus();
                         return;
                    }
                    if (newStatus === STATUS_CODES.DISPATCHED && (!method || !driverName)) {
                         errorEl.textContent = '已派車狀態下，派車方式和司機姓名為必填。';
                         if (!method) methodInput.focus(); else driverNameInput.focus();
                         return;
                    }
                    
                    hideModal();
                    callback({
                        dispatch_status: newStatus,
                        dispatch_method: method,
                        driver_name: driverName,
                        driver_phone: driverPhone,
                        admin_remarks: remarks,
                        admin_update_time: serverTimestamp(),
                    });
                };
                cancelBtn.onclick = hideModal;
            }


            // --- UTILITY FUNCTIONS ---
            function getFormData() {
                const checkedBranches = Array.from(document.querySelectorAll('input[name="branch"]:checked')).map(el => el.value);
                const vehicleTypeEl = document.querySelector('input[name="vehicle_type"]:checked');

                return {
                    id: requestIdInput.value || null,
                    branches: checkedBranches,
                    reason: document.getElementById('reason').value.trim(),
                    vehicle_type: vehicleTypeEl ? vehicleTypeEl.value : '',
                    destination: document.getElementById('destination').value.trim(),
                    passengers: parseInt(document.getElementById('passengers').value, 10) || 0,
                    start_time: document.getElementById('start_time').value,
                    end_time: document.getElementById('end_time').value,
                    applicant_unit: document.getElementById('applicant_unit').value.trim(),
                    cost_code: document.getElementById('cost_code').value.trim(),
                    extension: document.getElementById('extension').value.trim(),
                    contact_group: document.getElementById('contact_group').value.trim(),
                    applicant_name: document.getElementById('applicant_name').value.trim(),
                    remarks: document.getElementById('remarks').value.trim(),
                };
            }
            
            function clearForm() {
                form.reset();
                requestIdInput.value = '';
                adminSection.classList.add('hidden');
                cancelRequestBtn.classList.add('hidden');
                submitBtn.textContent = '提交新申請';
                
                // Re-enable all applicant fields
                Array.from(form.elements).forEach(el => {
                    if (el.id !== 'request-id' && !el.id.startsWith('admin_')) {
                         el.disabled = false;
                    }
                });
                
                // Clear admin fields display
                Object.values(adminFields).forEach(el => {
                    if (el.id === 'dispatch_status') {
                        el.value = STATUS_CODES.MANAGER_APPROVAL;
                    } else {
                        el.value = '';
                    }
                    el.classList.add('disabled-input');
                    el.disabled = true;
                });
                
                // Ensure applicant actions are visible
                applicantActions.classList.remove('hidden');
                adminActions.classList.add('hidden');
                state.editingRequestId = null;
                window.history.pushState({}, '', window.location.pathname); // Clear URL query
            }

            function fillForm(data, isDeepLink = false) {
                clearForm(); 
                
                requestIdInput.value = data.id || '';
                document.getElementById('display_request_id').value = data.id || '';

                // Fill Applicant fields
                data.branches.forEach(branch => {
                    const checkbox = document.querySelector(`input[name="branch"][value="${branch}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                const vehicleTypeEl = document.querySelector(`input[name="vehicle_type"][value="${data.vehicle_type}"]`);
                if (vehicleTypeEl) vehicleTypeEl.checked = true;
                
                document.getElementById('reason').value = data.reason || '';
                document.getElementById('destination').value = data.destination || '';
                document.getElementById('passengers').value = data.passengers || '';
                document.getElementById('start_time').value = data.start_time || '';
                document.getElementById('end_time').value = data.end_time || '';
                document.getElementById('applicant_unit').value = data.applicant_unit || '';
                document.getElementById('cost_code').value = data.cost_code || '';
                document.getElementById('extension').value = data.extension || '';
                document.getElementById('contact_group').value = data.contact_group || '';
                document.getElementById('applicant_name').value = data.applicant_name || '';
                document.getElementById('remarks').value = data.remarks || '';
                
                // Fill Admin fields
                adminFields.dispatch_status.value = data.dispatch_status || STATUS_CODES.MANAGER_APPROVAL;
                adminFields.approving_manager.value = data.approving_manager || 'N/A';
                adminFields.dispatch_method.value = data.dispatch_method || '';
                adminFields.driver_name.value = data.driver_name || '';
                adminFields.driver_phone.value = data.driver_phone || '';
                adminFields.admin_remarks.value = data.admin_remarks || '';
                
                adminSection.classList.remove('hidden');
                
                // Handle form button visibility and field enabling based on status and role
                submitBtn.textContent = '更新申請內容';
                state.editingRequestId = data.id;
                
                // If it's a deep link (manager sign-off), disable all applicant fields
                if (isDeepLink) {
                    Array.from(form.elements).forEach(el => {
                        if (el.id !== 'request-id' && !el.id.startsWith('admin_') && el.type !== 'submit' && el.type !== 'button') {
                            el.disabled = true;
                            el.classList.add('disabled-input');
                        }
                    });
                    applicantActions.classList.remove('hidden');
                    adminActions.classList.add('hidden');
                    submitBtn.classList.add('hidden');
                    clearBtn.classList.add('hidden');
                    cancelRequestBtn.classList.add('hidden');
                    
                    // Show Sign-off buttons only for deep link on the right status
                    if (data.dispatch_status === STATUS_CODES.MANAGER_APPROVAL) {
                        modalButtons.innerHTML = `<button id="sign-off-approve-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">立即核准</button>`;
                        modalButtons.innerHTML += `<button id="sign-off-reject-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-yellow-600 text-base font-medium text-white hover:bg-yellow-700 focus:outline-none ml-3">退回</button>`;
                        
                        document.getElementById('sign-off-approve-btn').onclick = () => promptManagerAction(data.id, data.dispatch_status, (actionType, managerName, remarks) => handleManagerSignOff(data.id, actionType, managerName, remarks, true));
                        document.getElementById('sign-off-reject-btn').onclick = () => promptManagerAction(data.id, data.dispatch_status, (actionType, managerName, remarks) => handleManagerSignOff(data.id, actionType, managerName, remarks, true));
                    }
                    
                    showAlert(`申請單號：${data.id}<br>狀態：${data.dispatch_status}<br><br>請主管進行核准操作。`, '主管簽核通知', 'info');
                    
                } else if (state.isLoggedIn) {
                    // Admin view
                    submitBtn.classList.add('hidden');
                    clearBtn.classList.add('hidden');
                    cancelRequestBtn.classList.add('hidden');
                    applicantActions.classList.add('hidden');
                    adminActions.classList.remove('hidden');
                    
                    // Allow admin to edit all admin-specific fields
                    Object.values(adminFields).forEach(el => {
                         el.classList.remove('disabled-input');
                         el.disabled = false;
                    });
                    adminFields.display_request_id.classList.add('disabled-input'); // Keep ID readonly
                    adminFields.display_request_id.disabled = true; 
                    adminFields.approving_manager.classList.add('disabled-input'); // Keep manager name readonly
                    adminFields.approving_manager.disabled = true;
                    
                    // Enable update button only if status allows
                    const status = data.dispatch_status;
                    const canEditAdmin = (status !== STATUS_CODES.CANCELLED) && (status !== STATUS_CODES.MANAGER_REJECTED);
                    adminUpdateBtn.disabled = !canEditAdmin;

                    // Disable all applicant fields for admin view
                    Array.from(form.elements).forEach(el => {
                        if (el.id !== 'request-id' && !el.id.startsWith('admin_') && el.type !== 'submit' && el.type !== 'button') {
                            el.disabled = true;
                            el.classList.add('disabled-input');
                        }
                    });

                } else {
                    // Applicant update view
                    submitBtn.classList.remove('hidden');
                    clearBtn.classList.remove('hidden');
                    
                    const status = data.dispatch_status;
                    const canCancel = (status === STATUS_CODES.MANAGER_APPROVAL || status === STATUS_CODES.MANAGER_REJECTED || status === STATUS_CODES.PENDING_DISPATCH);
                    const canEdit = (status === STATUS_CODES.MANAGER_REJECTED);
                    
                    cancelRequestBtn.classList.toggle('hidden', !canCancel);
                    submitBtn.disabled = !canEdit;

                    Array.from(form.elements).forEach(el => {
                        if (el.id !== 'request-id' && !el.id.startsWith('admin_') && el.type !== 'submit' && el.type !== 'button') {
                             el.disabled = !canEdit;
                             el.classList.toggle('disabled-input', !canEdit);
                        }
                    });
                }
                
                setActiveTab('apply');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function generateRequestID() {
                const now = new Date();
                const year = now.getFullYear().toString().slice(2);
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const time = now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0');
                const random = Math.floor(Math.random() * 900) + 100; // 3 digit random
                return `QC${year}${month}${day}${time}${random}`;
            }

            function getStatusClass(status) {
                switch (status) {
                    case STATUS_CODES.MANAGER_APPROVAL: return 'status-manager-approval';
                    case STATUS_CODES.MANAGER_REJECTED: return 'status-manager-rejected';
                    case STATUS_CODES.PENDING_DISPATCH: return 'status-pending';
                    case STATUS_CODES.DISPATCHED: return 'status-dispatched';
                    case STATUS_CODES.CANCELLED: return 'status-cancelled';
                    case STATUS_CODES.REJECTED: return 'status-rejected';
                    default: return 'bg-gray-200 text-gray-800';
                }
            }

            function formatTime(timestamp) {
                if (!timestamp) return 'N/A';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleString('zh-TW', {
                    year: 'numeric', month: 'numeric', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', hour12: false
                });
            }
            
            function renderRequestCard(request) {
                const statusClass = getStatusClass(request.dispatch_status);
                const isPendingManager = request.dispatch_status === STATUS_CODES.MANAGER_APPROVAL;
                
                const cardHtml = `
                    <div class="request-card bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div class="flex-grow min-w-0 mb-3 sm:mb-0">
                            <div class="flex items-center space-x-3 mb-1">
                                <span class="text-sm font-semibold text-gray-500">單號:</span>
                                <span class="text-base font-bold text-blue-700 truncate">${request.id}</span>
                                ${isPendingManager && state.isLoggedIn ? `<button data-id="${request.id}" class="manager-sign-off-btn ml-2 text-xs text-red-600 hover:text-red-800 font-bold">立即主管簽核</button>` : ''}
                            </div>
                            <p class="text-sm text-gray-600 truncate">
                                <strong>申請人:</strong> ${request.applicant_name} | 
                                <strong>單位:</strong> ${request.applicant_unit} | 
                                <strong>事由:</strong> ${request.reason} 
                            </p>
                            <p class="text-xs text-gray-500">
                                <strong>時間:</strong> ${formatTime(request.start_time)} ~ ${formatTime(request.end_time)}
                            </p>
                        </div>
                        <div class="flex flex-col items-start sm:items-end space-y-2 min-w-[120px]">
                            <span class="status-badge ${statusClass}">${request.dispatch_status}</span>
                            <button data-id="${request.id}" class="view-request-btn text-xs font-medium text-blue-600 hover:text-blue-800">
                                ${state.isLoggedIn ? '處理/詳情' : '查看詳情'}
                            </button>
                        </div>
                    </div>
                `;
                const div = document.createElement('div');
                div.innerHTML = cardHtml.trim();
                return div.firstChild;
            }

            function renderRequestsList(container, requests, searchTerm = '') {
                container.innerHTML = '';
                const filteredRequests = requests.filter(req => {
                    const statusOK = req.dispatch_status !== STATUS_CODES.CANCELLED;
                    if (!searchTerm) return statusOK;
                    const lowerSearch = searchTerm.toLowerCase();
                    return statusOK && (
                        req.id.toLowerCase().includes(lowerSearch) ||
                        req.applicant_name.toLowerCase().includes(lowerSearch) ||
                        req.applicant_unit.toLowerCase().includes(lowerSearch)
                    );
                }).sort((a, b) => {
                    // Sort pending manager approvals first
                    if (a.dispatch_status === STATUS_CODES.MANAGER_APPROVAL && b.dispatch_status !== STATUS_CODES.MANAGER_APPROVAL) return -1;
                    if (a.dispatch_status !== STATUS_CODES.MANAGER_APPROVAL && b.dispatch_status === STATUS_CODES.MANAGER_APPROVAL) return 1;
                    return (b.created_at?.toMillis() || 0) - (a.created_at?.toMillis() || 0); // Sort by newest first
                });

                if (filteredRequests.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 py-4">沒有找到符合條件的申請記錄。</p>`;
                    pendingCountBadge.classList.add('hidden');
                    return;
                }

                const pendingCount = filteredRequests.filter(req => req.dispatch_status === STATUS_CODES.MANAGER_APPROVAL || req.dispatch_status === STATUS_CODES.PENDING_DISPATCH).length;
                if (state.activeTab === 'admin') {
                    if (pendingCount > 0) {
                        pendingCountBadge.textContent = pendingCount;
                        pendingCountBadge.classList.remove('hidden');
                    } else {
                        pendingCountBadge.classList.add('hidden');
                    }
                }

                filteredRequests.forEach(req => {
                    container.appendChild(renderRequestCard(req));
                });
            }

            function updateUI() {
                // Toggle Admin/Stats view based on local login state
                adminView.classList.toggle('hidden', !state.isLoggedIn);
                adminLoginPrompt.classList.toggle('hidden', state.isLoggedIn);
                statsView.classList.toggle('hidden', !state.isLoggedIn);
                statsLoginPrompt.classList.toggle('hidden', state.isLoggedIn);
                logoutBtn.classList.toggle('hidden', !state.isLoggedIn);
                
                // Show Stats tab only for admin
                statsTabBtn.classList.toggle('hidden', !state.isLoggedIn);
                
                if (state.isLoggedIn) {
                    authStatusEl.textContent = '管理員模式';
                    authStatusEl.classList.add('text-green-600');
                } else {
                    authStatusEl.textContent = '訪客模式';
                    authStatusEl.classList.remove('text-green-600');
                }
                
                // Re-render lists based on current tab and data
                if (state.activeTab === 'admin' && state.isLoggedIn) {
                    renderRequestsList(requestsList, state.requests, state.adminSearchTerm);
                    updateCharts(state.requests, statsMonthFilter.value);
                } else if (state.activeTab === 'stats' && state.isLoggedIn) {
                    updateCharts(state.requests, statsMonthFilter.value);
                } else if (state.activeTab === 'search') {
                    // Search tab list updates via searchBtn event listener
                }
            }
            
            function setActiveTab(tabName) {
                state.activeTab = tabName;
                tabButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });
                tabContents.forEach(content => {
                    content.classList.toggle('hidden', content.id !== `tab-content-${tabName}`);
                });
                if (tabName === 'admin' || tabName === 'stats') {
                    updateUI(); // Re-render admin lists and charts if active
                }
            }


            // --- FIRESTORE OPERATIONS ---
            async function initializeFirebase() {
                try {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    state.db = getFirestore(app);
                    state.auth = getAuth(app);

                    // Sign in with custom token or anonymously
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialAuthToken) {
                        await signInWithCustomToken(state.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(state.auth);
                    }

                    // Set up auth state change listener
                    onAuthStateChanged(state.auth, (user) => {
                        if (user) {
                            state.userId = user.uid;
                            console.log("Firebase Auth Ready. User ID:", state.userId);
                            state.isFirebaseReady = true;
                            startDataListener();
                            handleDeepLink();
                        } else {
                            state.userId = 'anonymous';
                            state.isFirebaseReady = true;
                            startDataListener(); // Still listen to public data even as anonymous
                            handleDeepLink();
                        }
                    });
                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    showAlert('系統初始化失敗，請檢查連線。', '錯誤', 'error');
                }
            }
            
            let unsubscribeRequests = null;
            function startDataListener() {
                if (unsubscribeRequests) {
                    unsubscribeRequests();
                }
                
                const q = collection(state.db, FIREBASE_COLLECTION_PATH);
                
                unsubscribeRequests = onSnapshot(q, (snapshot) => {
                    state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`Fetched ${state.requests.length} requests in real-time.`);
                    updateUI();
                }, (error) => {
                    console.error("Firestore listener failed:", error);
                    showAlert('無法連接至資料庫，請檢查網路。', '錯誤', 'error');
                });
            }

            async function saveRequest(data) {
                if (!state.isFirebaseReady) {
                    showAlert('系統未準備好，請稍後再試。', '錯誤', 'error');
                    return;
                }

                try {
                    const collectionRef = collection(state.db, FIREBASE_COLLECTION_PATH);
                    
                    if (data.id) {
                        // Update existing request
                        const docRef = doc(state.db, FIREBASE_COLLECTION_PATH, data.id);
                        
                        const updateData = {
                            ...data,
                            updated_at: serverTimestamp(),
                            // Only applicant can update fields up to a certain point
                        };
                        
                        // Prevent users from updating status unless they are admin
                        const existingRequest = state.requests.find(r => r.id === data.id);
                        if (existingRequest && existingRequest.dispatch_status !== STATUS_CODES.MANAGER_REJECTED) {
                            showAlert('只有被主管退回的申請單才能修改內容。', '錯誤', 'error');
                            return;
                        }
                        
                        await updateDoc(docRef, updateData);
                        showAlert(`申請單號 ${data.id} 已成功更新並重新提交審核！`, '更新成功');
                        
                    } else {
                        // New request
                        const newId = generateRequestID();
                        const newData = {
                            ...data,
                            id: newId,
                            created_at: serverTimestamp(),
                            applicant_uid: state.userId,
                            dispatch_status: STATUS_CODES.MANAGER_APPROVAL,
                            approving_manager: null,
                            manager_remarks: null,
                            dispatch_method: null,
                            driver_name: null,
                            driver_phone: null,
                            admin_remarks: null,
                        };
                        
                        // Use setDoc with generated ID
                        await setDoc(doc(state.db, FIREBASE_COLLECTION_PATH, newId), newData);

                        // Generate deep link for manager
                        const managerLink = `${window.location.origin}${window.location.pathname}?id=${newId}`;
                        showSuccessWithLink(`您的派車申請已送出，單號為 ${newId}。<br><br>請將以下連結提供給您的單位主管進行簽核：`, managerLink);
                    }
                    clearForm();
                    
                } catch (e) {
                    console.error("Error saving request:", e);
                    showAlert('儲存申請失敗，請稍後再試。', '錯誤', 'error');
                }
            }

            async function updateRequestStatus(id, newStatus, managerName, remarks, adminData = {}) {
                if (!state.isFirebaseReady) return showAlert('系統未準備好，請稍後再試。', '錯誤', 'error');
                
                try {
                    const docRef = doc(state.db, FIREBASE_COLLECTION_PATH, id);
                    const updateObj = {
                        dispatch_status: newStatus,
                        updated_at: serverTimestamp(),
                        ...adminData
                    };

                    if (managerName !== undefined) updateObj.approving_manager = managerName;
                    if (remarks !== undefined) updateObj.manager_remarks = remarks;
                    
                    await updateDoc(docRef, updateObj);
                    showAlert(`申請單號 ${id} 狀態已更新為：${newStatus}`, '狀態更新成功');
                    clearForm();

                } catch (e) {
                    console.error("Error updating status:", e);
                    showAlert('更新狀態失敗，請稍後再試。', '錯誤', 'error');
                }
            }

            // --- HANDLERS ---
            
            // 1. Manager Sign Off (Triggered by deep link or admin list)
            const handleManagerSignOff = (id, actionType, managerName, remarks, isDeepLink = false) => {
                const request = state.requests.find(r => r.id === id);
                if (!request) return showAlert('找不到該申請單。', '錯誤', 'error');
                
                const newStatus = actionType === 'approve' ? STATUS_CODES.PENDING_DISPATCH : STATUS_CODES.MANAGER_REJECTED;

                updateRequestStatus(id, newStatus, managerName, remarks).then(() => {
                    if (isDeepLink) {
                        // After manager signs off via deep link, clear the query param and show message
                        window.history.pushState({}, '', window.location.pathname);
                        state.deepLinkedRequestId = null;
                    }
                });
            };

            // 2. Admin Update Dispatch (Triggered by admin form)
            const handleAdminUpdate = async () => {
                 if (!state.editingRequestId) return showAlert('請先選取欲更新的申請單。', '錯誤', 'error');

                 promptAdminAction(state.editingRequestId, getFormData(), (adminUpdateData) => {
                      // Check if status is manually set to CANCELLED by admin. This shouldn't happen via this modal, but safety first.
                      if (adminUpdateData.dispatch_status === STATUS_CODES.CANCELLED) {
                          return showAlert('請使用「案件取消」按鈕取消，或使用「無法派車」更新狀態。', '錯誤', 'error');
                      }
                      
                      updateRequestStatus(state.editingRequestId, adminUpdateData.dispatch_status, undefined, undefined, adminUpdateData);
                 });
            };

            // 3. Applicant Cancel Request
            const handleCancelRequest = () => {
                if (!state.editingRequestId) return;
                
                showConfirm(`確定要取消申請單號 ${state.editingRequestId} 嗎？此操作不可逆。`, (confirmed) => {
                    if (confirmed) {
                        updateRequestStatus(state.editingRequestId, STATUS_CODES.CANCELLED);
                    }
                }, '取消申請確認');
            };

            // 4. Form Submission (New or Applicant Update)
            form.onsubmit = (e) => {
                e.preventDefault();
                const data = getFormData();
                if (data.id && !document.getElementById('reason').disabled) {
                    // This is an applicant re-submission after manager rejection.
                    showConfirm('確定要使用新內容重新提交此申請嗎？', (confirmed) => {
                        if (confirmed) saveRequest(data);
                    });
                } else if (!data.id) {
                    // This is a new submission
                    saveRequest(data);
                } else {
                    showAlert('您無法修改已在審核或已派車的申請單。', '操作受限');
                }
            };
            
            // 5. Search Button
            searchBtn.onclick = () => {
                const term = searchInput.value.trim().toLowerCase();
                if (!term) {
                    searchResults.innerHTML = `<p class="text-center text-gray-500">請輸入姓名或單號以查詢您的申請記錄。</p>`;
                    return;
                }
                
                const foundRequests = state.requests.filter(req => 
                    req.id.toLowerCase().includes(term) || 
                    req.applicant_name.toLowerCase().includes(term)
                );
                
                if (foundRequests.length === 0) {
                    searchResults.innerHTML = `<p class="text-center text-red-500 py-4">找不到符合「${searchInput.value}」的申請記錄。</p>`;
                } else {
                    renderRequestsList(searchResults, foundRequests);
                }
            };

            // 6. Admin Search Input
            adminSearchInput.oninput = () => {
                state.adminSearchTerm = adminSearchInput.value.trim();
                renderRequestsList(requestsList, state.requests, state.adminSearchTerm);
            };

            // 7. Clear Form Button
            clearBtn.onclick = clearForm;

            // 8. View Request Details/Edit Button (Used by search results and admin list)
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-request-btn')) {
                    const id = e.target.dataset.id;
                    const request = state.requests.find(r => r.id === id);
                    if (request) {
                        fillForm(request);
                    }
                }
                
                if (e.target.classList.contains('manager-sign-off-btn')) {
                    const id = e.target.dataset.id;
                    const request = state.requests.find(r => r.id === id);
                    if (request) {
                        promptManagerAction(id, request.dispatch_status, (actionType, managerName, remarks) => handleManagerSignOff(id, actionType, managerName, remarks));
                    }
                }
            });

            // 9. Admin Login & Logout
            adminLoginPromptBtn.onclick = promptLogin;
            statsLoginPromptBtn.onclick = promptLogin;
            logoutBtn.onclick = () => {
                state.isLoggedIn = false;
                showAlert('已登出管理員身分。', '登出成功');
                updateUI();
                setActiveTab('apply');
                clearForm();
            };
            
            // 10. Admin Actions
            adminUpdateBtn.onclick = handleAdminUpdate;
            adminCloseBtn.onclick = () => { setActiveTab('admin'); clearForm(); };
            cancelRequestBtn.onclick = handleCancelRequest;

            // 11. Tab Switching
            tabButtons.forEach(btn => {
                btn.onclick = () => {
                    setActiveTab(btn.dataset.tab);
                    clearForm(); // Clear the form on tab switch
                };
            });
            
            // 12. Refresh button
            refreshAdminListBtn.onclick = () => {
                 // The onSnapshot listener handles real-time refresh, but we can clear search terms
                 adminSearchInput.value = '';
                 state.adminSearchTerm = '';
                 renderRequestsList(requestsList, state.requests);
            };

            // --- CHARTS & STATS ---

            const STATS_BACKGROUNDS = [
                'rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)', 
                'rgba(239, 68, 68, 0.8)', 'rgba(139, 92, 246, 0.8)', 'rgba(100, 116, 139, 0.8)'
            ];
            
            function updateCharts(requests, monthFilter) {
                if (!state.isLoggedIn) return;

                const filteredRequests = requests.filter(req => {
                    if (!req.created_at) return false;
                    const timestamp = req.created_at.toDate();
                    if (!monthFilter) return true; 
                    
                    const filterYearMonth = monthFilter.slice(0, 7);
                    const requestYearMonth = timestamp.toISOString().slice(0, 7);
                    
                    return requestYearMonth === filterYearMonth;
                });
                
                statsTotalRequests.textContent = filteredRequests.length;

                // 1. Status Chart
                const statusCounts = filteredRequests.reduce((acc, req) => {
                    acc[req.dispatch_status] = (acc[req.dispatch_status] || 0) + 1;
                    return acc;
                }, {});
                
                if (statusChartInstance) statusChartInstance.destroy();
                statusChartInstance = new Chart(document.getElementById('status-chart'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{
                            data: Object.values(statusCounts),
                            backgroundColor: STATS_BACKGROUNDS.slice(0, Object.keys(statusCounts).length),
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                });

                // 2. Branch Chart
                const branchCounts = filteredRequests.reduce((acc, req) => {
                    req.branches.forEach(branch => {
                         acc[branch] = (acc[branch] || 0) + 1;
                    });
                    return acc;
                }, {});

                if (branchChartInstance) branchChartInstance.destroy();
                branchChartInstance = new Chart(document.getElementById('branch-chart'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(branchCounts),
                        datasets: [{
                            label: '申請筆數',
                            data: Object.values(branchCounts),
                            backgroundColor: STATS_BACKGROUNDS[0],
                        }]
                    },
                    options: { 
                        responsive: true, 
                        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                        plugins: { legend: { display: false } }
                    }
                });
                
                // 3. Driver Chart (Only count DISPATCHED status)
                const driverCounts = filteredRequests
                    .filter(req => req.dispatch_status === STATUS_CODES.DISPATCHED && req.driver_name)
                    .reduce((acc, req) => {
                        const driver = req.driver_name;
                        acc[driver] = (acc[driver] || 0) + 1;
                        return acc;
                    }, {});
                
                if (driverChartInstance) driverChartInstance.destroy();
                driverChartInstance = new Chart(document.getElementById('driver-chart'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(driverCounts),
                        datasets: [{
                            label: '派車趟次',
                            data: Object.values(driverCounts),
                            backgroundColor: STATS_BACKGROUNDS[1],
                        }]
                    },
                    options: { 
                        responsive: true, 
                        indexAxis: 'y', // Horizontal bars for names
                        scales: { x: { beginAtZero: true, ticks: { precision: 0 } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            statsMonthFilter.onchange = (e) => updateCharts(state.requests, e.target.value);
            
            // Set default month filter to current month
            const today = new Date();
            const yearMonth = today.toISOString().slice(0, 7);
            statsMonthFilter.value = yearMonth;

            // --- EXCEL EXPORT ---
            exportExcelBtn.onclick = () => {
                const dataToExport = state.requests.map(req => {
                    // Prepare data for Excel
                    return {
                        '申請單號': req.id,
                        '申請人': req.applicant_name,
                        '申請單位': req.applicant_unit,
                        '用車事由': req.reason,
                        '院區': req.branches.join(', '),
                        '車輛種類': req.vehicle_type,
                        '駛達地點': req.destination,
                        '搭乘人數': req.passengers,
                        '預定開始時間': formatTime(req.start_time),
                        '預定結束時間': formatTime(req.end_time),
                        '費用部門代號': req.cost_code,
                        '聯絡分機': req.extension,
                        '聯絡群組': req.contact_group,
                        '申請人備註': req.remarks,
                        '申請狀態': req.dispatch_status,
                        '簽核主管': req.approving_manager || 'N/A',
                        '主管備註': req.manager_remarks || '',
                        '派車方式': req.dispatch_method || '',
                        '司機姓名': req.driver_name || '',
                        '司機電話': req.driver_phone || '',
                        '承辦備註': req.admin_remarks || '',
                        '申請建立時間': formatTime(req.created_at),
                        '最後更新時間': formatTime(req.updated_at),
                    };
                });

                if (dataToExport.length === 0) {
                     return showAlert('沒有資料可以匯出。', '錯誤', 'error');
                }
                
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "派車申請記錄");
                XLSX.writeFile(workbook, `佳里奇美派車申請_${new Date().toISOString().slice(0, 10)}.xlsx`);
                showAlert('資料已成功匯出為 Excel 檔案。', '匯出完成');
            };

            // --- INITIALIZATION ---
            function handleDeepLink() {
                if (state.deepLinkedRequestId) return; // Only process deep link once
                
                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('id');
                
                if (id) {
                    state.deepLinkedRequestId = id;
                    const request = state.requests.find(r => r.id === id);
                    if (request) {
                        fillForm(request, true); // True indicates deep link
                    } else if (state.requests.length > 0) {
                        // If data is loaded but ID not found, alert
                        showAlert(`找不到申請單號：${id}`, '錯誤', '查詢失敗');
                        window.history.pushState({}, '', window.location.pathname); // Clear URL query
                    }
                    // If data is still loading, fillForm will be called when onSnapshot fires.
                }
            }
            
            // Start the application
            initializeFirebase();
        });
    </script>
</body>
</html>

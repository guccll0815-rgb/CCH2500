<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>派車申請系統</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', 'Microsoft JhengHei', sans-serif;
            background-color: #f4f6f9;
        }
        .tab-btn.active {
            border-bottom: 3px solid #1a56db;
            color: #1a56db;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .animate-shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex flex-col items-center p-4 sm:p-8">
        <!-- Header -->
        <header class="w-full max-w-4xl mb-6 bg-white shadow-lg rounded-xl p-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800">派車申請系統</h1>
                <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700 hidden">登出</button>
            </div>
            <div class="mt-4 border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button class="tab-btn active px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150 ease-in-out" data-tab="apply">填寫申請</button>
                    <button class="tab-btn px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150 ease-in-out" data-tab="query">查詢狀態</button>
                    <button class="tab-btn px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150 ease-in-out" data-tab="admin">管理後台</button>
                    <!-- <button class="tab-btn px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150 ease-in-out" data-tab="stats">統計報表</button> -->
                </nav>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="w-full max-w-4xl bg-white shadow-xl rounded-xl p-6 mb-8">
            
            <!-- 1. 填寫申請 Tab -->
            <div id="apply-tab" class="tab-content active" data-tab="apply">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">新派車申請</h2>
                <form id="dispatchForm" class="space-y-6">
                    <!-- Hidden input for Request ID (used for editing) -->
                    <input type="hidden" id="request-id" value="">
                    
                    <!-- 院區選擇 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <label class="block text-sm font-medium text-gray-700 col-span-full">服務院區 (多選)</label>
                        <div class="flex items-center">
                            <input id="branch-yongkang" name="branch" type="checkbox" value="總院" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="branch-yongkang" class="ml-2 block text-sm text-gray-900">總院</label>
                        </div>
                        <div class="flex items-center">
                            <input id="branch-liuying" name="branch" type="checkbox" value="柳營院區" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="branch-liuying" class="ml-2 block text-sm text-gray-900">柳營院區</label>
                        </div>
                        <div class="flex items-center">
                            <input id="branch-tainan" name="branch" type="checkbox" value="佳里院區" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="branch-tainan" class="ml-2 block text-sm text-gray-900">佳里院區</label>
                        </div>
                    </div>

                    <!-- 用車事由 & 目的地 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="reason" class="block text-sm font-medium text-gray-700">用車事由 <span class="text-red-500">*</span></label>
                            <input type="text" id="reason" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div>
                            <label for="destination" class="block text-sm font-medium text-gray-700">目的地 <span class="text-red-500">*</span></label>
                            <input type="text" id="destination" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                    </div>

                    <!-- 車型 & 乘客人數 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">預定車型 <span class="text-red-500">*</span></label>
                            <div class="flex space-x-4">
                                <div class="flex items-center">
                                    <input id="type-zhongba" name="vehicle_type" type="radio" value="中巴" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                    <label for="type-zhongba" class="ml-2 block text-sm text-gray-900">中巴</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="type-xiaoke" name="vehicle_type" type="radio" value="小客" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                    <label for="type-xiaoke" class="ml-2 block text-sm text-gray-900">小客</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="type-other" name="vehicle_type" type="radio" value="其他" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                    <label for="type-other" class="ml-2 block text-sm text-gray-900">其他</label>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="passengers" class="block text-sm font-medium text-gray-700">搭乘人數 <span class="text-red-500">*</span></label>
                            <input type="number" id="passengers" value="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                    </div>

                    <!-- 預定時間 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="start_time" class="block text-sm font-medium text-gray-700">預定派車時間 (起) <span class="text-red-500">*</span></label>
                            <input type="datetime-local" id="start_time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div>
                            <label for="end_time" class="block text-sm font-medium text-gray-700">預定派車時間 (迄) <span class="text-red-500">*</span></label>
                            <input type="datetime-local" id="end_time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                    </div>

                    <!-- 申請人資訊 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="applicant_unit" class="block text-sm font-medium text-gray-700">申請單位 <span class="text-red-500">*</span></label>
                            <input type="text" id="applicant_unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="總務室">
                        </div>
                        <div>
                            <label for="cost_code" class="block text-sm font-medium text-gray-700">費用部門代號 <span class="text-red-500">*</span></label>
                            <input type="text" id="cost_code" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="2500">
                        </div>
                        <div>
                            <label for="extension" class="block text-sm font-medium text-gray-700">聯絡分機 <span class="text-red-500">*</span></label>
                            <input type="text" id="extension" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="32031">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="contact_group" class="block text-sm font-medium text-gray-700">聯絡群組/組別</label>
                            <input type="text" id="contact_group" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="6088">
                        </div>
                        <div>
                            <label for="applicant_name" class="block text-sm font-medium text-gray-700">申請人姓名 <span class="text-red-500">*</span></label>
                            <input type="text" id="applicant_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="請輸入姓名">
                        </div>
                    </div>
                    
                    <!-- 備註 -->
                    <div>
                        <label for="remarks" class="block text-sm font-medium text-gray-700">備註</label>
                        <textarea id="remarks" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="若有特殊需求請在此說明..."></textarea>
                    </div>

                    <!-- 提交按鈕 -->
                    <div class="flex justify-end space-x-4 pt-4 border-t">
                        <button type="button" id="clear-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:bg-gray-200 transition duration-150">
                            清空表單
                        </button>
                        <button type="submit" id="submit-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 transition duration-150">
                            提交新申請
                        </button>
                    </div>
                </form>
            </div>

            <!-- 2. 查詢狀態 Tab -->
            <div id="query-tab" class="tab-content" data-tab="query">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">我的申請查詢</h2>
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="search-input" placeholder="輸入您的申請人姓名或ID..." class="flex-grow rounded-md border-gray-300 shadow-sm p-2 border">
                    <button id="search-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-500 rounded-lg shadow-sm hover:bg-indigo-600 transition duration-150">
                        查詢
                    </button>
                </div>
                <div id="search-results" class="space-y-4">
                    <!-- Search results will be rendered here -->
                    <p class="text-gray-500">請輸入申請人姓名或申請編號後查詢您的申請狀態。</p>
                </div>
            </div>

            <!-- 3. 管理後台 Tab -->
            <div id="admin-tab" class="tab-content" data-tab="admin">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">派車管理與核准</h2>
                <div id="admin-login-prompt" class="p-6 bg-yellow-50 rounded-lg shadow-inner text-center">
                    <p class="mb-4 text-yellow-800">此為管理員專區，請先登入。</p>
                    <button id="admin-login-prompt-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">管理員登入</button>
                </div>
                
                <div id="admin-view" class="hidden">
                    <div class="flex space-x-2 mb-4">
                        <input type="text" id="admin-search-input" placeholder="篩選：申請人/目的地/ID..." class="flex-grow rounded-md border-gray-300 shadow-sm p-2 border">
                        <button id="refresh-admin-list-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg shadow-sm hover:bg-gray-200 transition duration-150">
                            刷新列表
                        </button>
                    </div>
                    <div id="requests-list" class="space-y-3">
                        <!-- Admin requests list will be rendered here -->
                        <p class="text-gray-500">載入中...</p>
                    </div>
                </div>
            </div>

        </main>

        <!-- Custom Modal (for alerts, confirmations, and successful submission) -->
        <div id="custom-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
            <div class="bg-white rounded-xl shadow-2xl overflow-hidden max-w-lg w-full p-6 mx-4">
                <div class="text-center">
                    <h3 id="modal-title" class="text-xl leading-6 font-bold text-gray-900 mb-4">通知</h3>
                    <div id="modal-content" class="text-sm text-gray-500 text-left">
                        <!-- Message content here -->
                    </div>
                </div>
                <div id="modal-buttons" class="mt-5 sm:mt-6 sm:flex sm:flex-row-reverse sm:space-x-3 sm:space-x-reverse space-y-3 sm:space-y-0">
                    <!-- Buttons here -->
                </div>
            </div>
        </div>

    </div>

    <!-- The corrected JavaScript Module -->
    <script type="module">
        // --- 1. FIREBASE IMPORTS (CDN) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, serverTimestamp, setLogLevel, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 2. CONFIGURATION & CANVAS GLOBALS ---
        
        // 使用者提供的配置 (作為 fallback)
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyAs3v-BU5Hfh7HZitHdL5yI2FKZrI_Q4zI",
            authDomain: "cch2500-5bbb6.firebaseapp.com",
            projectId: "cch2500-5bbb6",
            storageBucket: "cch2500-5bbb6.firebasestorage.app",
            messagingSenderId: "223711217941",
            appId: "1:223711217941:web:f14461ad89c0f9ca01c11c",
            measurementId: "G-59DEQT7HT0"
        };
        
        // 優先使用 Canvas 環境提供的配置
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : defaultFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-cch-app-id'; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        const REQUESTS_COLLECTION = `artifacts/${appId}/public/data/dispatch_requests`;

        // --- 3. STATE & CACHE ELEMENTS ---
        const state = {
            isLoggedIn: false,
            requests: [],
            editingRequestId: null,
            activeTab: 'apply',
            db: null,
            auth: null,
            userId: null,
            deepLinkedRequestId: null,
        };
        
        const form = document.getElementById('dispatchForm');
        const submitBtn = document.getElementById('submit-btn');
        const clearBtn = document.getElementById('clear-btn');
        const requestIdInput = document.getElementById('request-id');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const adminView = document.getElementById('admin-view');
        const adminLoginPrompt = document.getElementById('admin-login-prompt');
        const adminLoginPromptBtn = document.getElementById('admin-login-prompt-btn');
        const requestsList = document.getElementById('requests-list');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchResults = document.getElementById('search-results');
        const adminSearchInput = document.getElementById('admin-search-input');
        const refreshAdminListBtn = document.getElementById('refresh-admin-list-btn');

        // --- 4. MODAL FUNCTIONS (Simplified for brevity, similar to previous) ---
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalButtons = document.getElementById('modal-buttons');

        function hideModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }
        function showAlert(message, title = '通知') { 
            modalTitle.textContent = title;
            modalContent.innerHTML = `<p>${message}</p>`;
            modalButtons.innerHTML = `<button id="modal-ok-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">確定</button>`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            const okBtn = document.getElementById('modal-ok-btn');
            okBtn.onclick = hideModal;
            okBtn.focus();
        }
        
        function showSuccessWithLink(message, link) {
            modalTitle.textContent = '申請成功';
            modalContent.innerHTML = `
                <p>${message}</p>
                <div class="mt-4">
                    <label for="approval-link" class="block text-sm font-medium text-gray-700 text-left">專屬簽核連結</label>
                    <input type="text" id="approval-link" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" value="${link}">
                </div>
            `;
            modalButtons.innerHTML = `
                <button id="modal-copy-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">複製連結</button>
                <button id="modal-close-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">關閉</button>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            const copyBtn = document.getElementById('modal-copy-btn');
            const linkInput = document.getElementById('approval-link');

            copyBtn.onclick = () => {
                linkInput.select();
                document.execCommand('copy');
                copyBtn.textContent = '已複製！';
                setTimeout(() => { copyBtn.textContent = '複製連結'; }, 2000);
            };
            document.getElementById('modal-close-btn').onclick = hideModal;
        }

        function promptLogin() {
            modalTitle.textContent = '管理員登入';
            modalContent.innerHTML = `<div class="space-y-4"><div><label for="modal-username" class="block text-sm font-medium text-gray-700 text-left">帳號</label><input type="text" id="modal-username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="modal-password" class="block text-sm font-medium text-gray-700 text-left">密碼</label><input type="password" id="modal-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><p id="modal-error" class="text-sm text-red-600 h-4"></p></div>`;
            modalButtons.innerHTML = `<button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">取消</button><button id="modal-login-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">登入</button>`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            const loginBtn = document.getElementById('modal-login-btn'), usernameInput = document.getElementById('modal-username'), passwordInput = document.getElementById('modal-password'), errorEl = document.getElementById('modal-error');
            const handleLogin = () => {
                // 使用簡單的硬編碼帳密作為範例 (應在實際環境中使用 Firebase Auth)
                if (usernameInput.value === 'admin' && passwordInput.value === 'cch2500') {
                    hideModal(); state.isLoggedIn = true; showAlert('登入成功！'); updateUI(); setActiveTab('admin');
                } else {
                    errorEl.textContent = '帳號或密碼錯誤！'; 
                }
            };
            loginBtn.onclick = handleLogin;
            passwordInput.onkeydown = (e) => { if (e.key === 'Enter') handleLogin(); };
            document.getElementById('modal-cancel-btn').onclick = hideModal;
        }
        
        // --- 5. FIREBASE INITIALIZATION & AUTH (FIX 1) ---
        async function initFirebase() {
            try {
                // setLogLevel('debug'); // For development debugging
                
                const app = initializeApp(firebaseConfig);
                state.auth = getAuth(app);
                state.db = getFirestore(app);

                // 認證邏輯：優先使用 Custom Token，否則匿名登入
                if (initialAuthToken) {
                    await signInWithCustomToken(state.auth, initialAuthToken);
                } else {
                    await signInAnonymously(state.auth);
                }
                
                state.userId = state.auth.currentUser?.uid || crypto.randomUUID();
                
                setupRealtimeListener(); // 開始監聽資料庫
                console.log("Firebase initialized successfully. User ID:", state.userId);

            } catch (error) {
                console.error("Firebase Initialization Error (FIX 1): ", error);
                // 顯示初始化錯誤訊息，對應第一個截圖的錯誤
                showAlert('系統初始化失敗，請檢查 Firebase 配置或重新整理頁面。', '載入錯誤');
            }
        }

        // --- 6. CRUD FUNCTIONS ---
        async function createNewRequest(data) {
             if (!state.db) { showAlert('資料庫未連線，請重新整理。', '錯誤'); return null; }
            try {
                const docRef = await addDoc(collection(state.db, REQUESTS_COLLECTION), {
                    ...data,
                    // 確保申請編號為唯一且可查詢
                    requestId: Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 5).toUpperCase(),
                    status: '待申請單位主管簽核',
                    createdAt: serverTimestamp(),
                    managerApproval: { status: 'Pending', name: '', time: null, remarks: '' },
                    adminDispatch: { status: 'Pending', method: '', driver: '', phone: '', remarks: '' }
                });
                return docRef.id;
            } catch (e) {
                console.error("Error adding document: ", e);
                showAlert(`提交申請失敗: ${e.message}`, '錯誤');
                return null;
            }
        }
        
        async function updateRequest(id, data) {
            if (!state.db) { showAlert('資料庫未連線。', '錯誤'); return; }
            try {
                const docRef = doc(state.db, REQUESTS_COLLECTION, id);
                await updateDoc(docRef, data);
            } catch (e) {
                console.error("Error updating document: ", e);
                showAlert(`更新申請失敗: ${e.message}`, '錯誤');
            }
        }
        
        // --- 7. REALTIME LISTENER ---
        function setupRealtimeListener() {
            if (!state.db) return;
            const q = collection(state.db, REQUESTS_COLLECTION);
            
            // 監聽所有請求的變化
            onSnapshot(q, (snapshot) => {
                state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminList();
                renderMyRequests(state.requests.filter(req => req.applicant_name === searchInput.value.trim()));
                // If the user is on the admin tab, refresh the list
                if(state.activeTab === 'admin' && state.isLoggedIn) {
                    filterAndRenderAdminList(adminSearchInput.value.trim());
                }
            }, (error) => {
                console.error("Error setting up snapshot listener: ", error);
                showAlert('無法即時載入資料，請檢查網路連線。', '資料錯誤');
            });
        }
        
        // --- 8. UI & RENDER FUNCTIONS ---
        function setActiveTab(tabName) {
            state.activeTab = tabName;
            tabButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            tabContents.forEach(content => {
                content.classList.toggle('active', content.dataset.tab === tabName);
                content.classList.toggle('hidden', content.dataset.tab !== tabName);
            });
            // Handle admin view access
            if (tabName === 'admin') {
                if (state.isLoggedIn) {
                    adminLoginPrompt.classList.add('hidden');
                    adminView.classList.remove('hidden');
                    filterAndRenderAdminList(adminSearchInput.value.trim());
                } else {
                    adminLoginPrompt.classList.remove('hidden');
                    adminView.classList.add('hidden');
                }
            }
        }

        function renderRequestCard(req, isAdmin = false) {
            const statusClass = {
                '待申請單位主管簽核': 'bg-yellow-100 text-yellow-800',
                '已核准 (待派車)': 'bg-blue-100 text-blue-800',
                '已退回': 'bg-red-100 text-red-800',
                '已派車': 'bg-green-100 text-green-800',
                '已完成': 'bg-gray-100 text-gray-800'
            };

            const formatTime = (time) => time ? new Date(time.seconds * 1000).toLocaleString() : 'N/A';
            const reqLink = `${window.location.origin}${window.location.pathname}?id=${req.id}`;
            const managerStatus = req.managerApproval?.status === 'Approved' ? `通過 (${req.managerApproval.name})` : req.managerApproval?.status === 'Rejected' ? `退回 (${req.managerApproval.name})` : '待簽核';

            let adminActions = '';
            if (isAdmin && req.managerApproval?.status === 'Approved' && req.adminDispatch?.status === 'Pending') {
                adminActions = `
                    <div class="mt-3 flex space-x-2">
                        <button data-id="${req.id}" data-action="dispatch" class="dispatch-btn px-3 py-1 text-xs font-medium text-white bg-green-600 rounded-md hover:bg-green-700">派車</button>
                    </div>
                `;
            } else if (isAdmin && req.adminDispatch?.status !== 'Pending' && req.status !== '已完成') {
                 adminActions = `
                    <div class="mt-3 flex space-x-2">
                        <button data-id="${req.id}" data-action="complete" class="complete-btn px-3 py-1 text-xs font-medium text-white bg-gray-600 rounded-md hover:bg-gray-700">完成</button>
                    </div>
                `;
            }

            let managerActions = '';
            if (!isAdmin && req.status === '待申請單位主管簽核' && state.userId === req.createdBy) { // Only the creator can see the manager link
                 managerActions = `
                    <div class="mt-3">
                        <p class="text-xs text-gray-500 mb-1">主管簽核連結 (請轉發給您的主管):</p>
                        <input type="text" readonly class="text-xs w-full p-1 bg-gray-100 border rounded-md" value="${reqLink}">
                    </div>
                `;
            }
            
            return `
                <div id="card-${req.id}" class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition duration-150">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-sm font-semibold text-indigo-600">ID: ${req.requestId}</span>
                        <span class="px-3 py-1 text-xs font-medium rounded-full ${statusClass[req.status] || 'bg-gray-100 text-gray-800'}">
                            ${req.status}
                        </span>
                    </div>
                    
                    <p class="text-lg font-bold text-gray-900">${req.destination}</p>
                    <p class="text-sm text-gray-600 mt-1">事由: ${req.reason}</p>
                    <p class="text-xs text-gray-500 mt-2">申請人: ${req.applicant_name} (${req.applicant_unit}) | 院區: ${req.branches.join(', ')}</p>
                    <p class="text-xs text-gray-500">時間: ${formatTime(req.startTime)} ~ ${formatTime(req.endTime)}</p>
                    <p class="text-xs text-gray-500">主管簽核: ${managerStatus}</p>

                    ${isAdmin ? `
                        <p class="text-xs text-gray-500">派車: ${req.adminDispatch?.method || 'N/A'} (司機: ${req.adminDispatch?.driver || 'N/A'})</p>
                        <p class="text-xs text-gray-500">備註: ${req.remarks}</p>
                    ` : managerActions}
                    
                    ${adminActions}
                </div>
            `;
        }
        
        function renderAdminList() {
            if (!state.isLoggedIn) {
                requestsList.innerHTML = '<p class="text-gray-500">請先登入管理後台。</p>';
                return;
            }
            filterAndRenderAdminList(adminSearchInput.value.trim());
        }

        function filterAndRenderAdminList(searchText) {
            const filteredRequests = state.requests
                .slice()
                .sort((a, b) => b.createdAt?.seconds - a.createdAt?.seconds) // 依照建立時間倒序
                .filter(req => {
                    if (!searchText) return true;
                    const query = searchText.toLowerCase();
                    return req.applicant_name.toLowerCase().includes(query) ||
                           req.destination.toLowerCase().includes(query) ||
                           req.requestId.toLowerCase().includes(query);
                });
            
            if (filteredRequests.length === 0 && searchText) {
                requestsList.innerHTML = `<p class="p-4 text-center text-gray-500">找不到符合「${searchText}」的申請。</p>`;
            } else if (filteredRequests.length === 0) {
                 requestsList.innerHTML = `<p class="p-4 text-center text-gray-500">目前沒有任何派車申請。</p>`;
            } else {
                requestsList.innerHTML = filteredRequests.map(req => renderRequestCard(req, true)).join('');
            }
            attachAdminEventListeners();
        }

        function renderMyRequests(filteredRequests) {
            if (filteredRequests.length === 0) {
                searchResults.innerHTML = '<p class="p-4 text-center text-gray-500">找不到您的申請，請確認輸入的姓名或 ID 是否正確。</p>';
                return;
            }
            searchResults.innerHTML = filteredRequests.map(req => renderRequestCard(req, false)).join('');
        }
        
        // --- 9. EVENT LISTENERS & LOGIC ---

        // (FIX 2) 表單提交處理 - 包含完整的必填欄位驗證
        async function handleSubmit(e) {
            e.preventDefault();
            
            // 獲取表單資料
            const selectedBranches = Array.from(document.querySelectorAll('input[name="branch"]:checked')).map(cb => cb.value);
            const reason = document.getElementById('reason').value.trim();
            const vehicleType = document.querySelector('input[name="vehicle_type"]:checked')?.value;
            const destination = document.getElementById('destination').value.trim();
            const passengers = document.getElementById('passengers').value.trim();
            const startTime = document.getElementById('start_time').value;
            const endTime = document.getElementById('end_time').value;
            const applicantUnit = document.getElementById('applicant_unit').value.trim();
            const costCode = document.getElementById('cost_code').value.trim();
            const extension = document.getElementById('extension').value.trim();
            const contactGroup = document.getElementById('contact_group').value.trim();
            const applicantName = document.getElementById('applicant_name').value.trim();
            const remarks = document.getElementById('remarks').value.trim();

            // --- 必填欄位驗證 (FIX 2: 解決第二個截圖的問題) ---
            if (selectedBranches.length === 0) {
                showAlert('請選擇至少一個服務院區', '欄位錯誤');
                return;
            }
            if (!reason) {
                showAlert('請填寫用車事由', '欄位錯誤');
                return;
            }
            if (!destination) {
                showAlert('請填寫目的地', '欄位錯誤');
                return;
            }
             if (!vehicleType) {
                showAlert('請選擇預定車型', '欄位錯誤');
                return;
            }
            if (!passengers || parseInt(passengers) < 1) {
                showAlert('請填寫有效的搭乘人數', '欄位錯誤');
                return;
            }
            if (!startTime || !endTime) {
                showAlert('請選擇完整的預定派車時間', '欄位錯誤');
                return;
            }
            if (new Date(startTime) >= new Date(endTime)) {
                showAlert('結束時間必須晚於開始時間', '欄位錯誤');
                return;
            }
            if (!applicantUnit || !costCode || !extension || !applicantName) {
                showAlert('請填寫完整的申請人資訊 (單位, 代號, 分機, 姓名)', '欄位錯誤');
                return;
            }
            // --- 驗證結束 ---

            submitBtn.disabled = true;
            submitBtn.textContent = '提交中...';

            const requestData = {
                branches: selectedBranches,
                reason,
                vehicle_type: vehicleType,
                destination,
                passengers: parseInt(passengers),
                startTime: new Date(startTime),
                endTime: new Date(endTime),
                applicant_unit: applicantUnit,
                cost_code: costCode,
                extension,
                contact_group: contactGroup,
                applicant_name: applicantName,
                remarks,
                createdBy: state.userId
            };

            const docId = await createNewRequest(requestData);

            submitBtn.disabled = false;
            submitBtn.textContent = '提交新申請';

            if (docId) {
                form.reset();
                const approvalLink = `${window.location.origin}${window.location.pathname}?id=${docId}`;
                showSuccessWithLink('派車申請已成功提交！您的申請編號將在系統中顯示。', approvalLink);
            }
        }
        
        function clearForm() {
            form.reset();
            requestIdInput.value = '';
            submitBtn.textContent = '提交新申請';
            submitBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('branch-yongkang').checked = false; // Clear checkboxes explicitly
            document.getElementById('branch-liuying').checked = false;
            document.getElementById('branch-tainan').checked = false;
            document.getElementById('passengers').value = '1';
        }

        function handleQuery() {
            const queryText = searchInput.value.trim();
            if (queryText.length < 2) {
                showAlert('請輸入至少 2 個字元以供查詢 (姓名或申請 ID)。', '查詢錯誤');
                searchResults.innerHTML = '<p class="text-gray-500">請輸入申請人姓名或申請編號後查詢您的申請狀態。</p>';
                return;
            }
            
            // 篩選出申請人姓名或 requestId 匹配的請求
            const results = state.requests.filter(req => 
                req.applicant_name.includes(queryText) || 
                req.requestId.toLowerCase() === queryText.toLowerCase()
            );
            renderMyRequests(results);
        }
        
        function handleAdminSearch() {
            const queryText = adminSearchInput.value.trim();
            filterAndRenderAdminList(queryText);
        }

        function attachAdminEventListeners() {
            document.querySelectorAll('.dispatch-btn').forEach(btn => {
                btn.onclick = (e) => handleDispatchAction(e.target.dataset.id);
            });
            document.querySelectorAll('.complete-btn').forEach(btn => {
                btn.onclick = (e) => handleCompleteAction(e.target.dataset.id);
            });
        }
        
        function handleDispatchAction(id) {
            const req = state.requests.find(r => r.id === id);
            if (!req) return;

            modalTitle.textContent = '派車作業';
            modalContent.innerHTML = `
                <p class="mb-4">您正在為申請 ID: <span class="font-semibold">${req.requestId}</span> 進行派車作業。</p>
                <div class="space-y-4">
                    <div>
                        <label for="modal-method" class="block text-sm font-medium text-gray-700 text-left">派車方式 <span class="text-red-500">*</span></label>
                        <select id="modal-method" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                            <option value="自有車輛">自有車輛</option>
                            <option value="租賃車輛">租賃車輛</option>
                            <option value="計程車">計程車</option>
                        </select>
                    </div>
                    <div>
                        <label for="modal-driver" class="block text-sm font-medium text-gray-700 text-left">司機姓名 <span class="text-red-500">*</span></label>
                        <input type="text" id="modal-driver" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="modal-phone" class="block text-sm font-medium text-gray-700 text-left">司機電話/車號</label>
                        <input type="text" id="modal-phone" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="modal-remarks" class="block text-sm font-medium text-gray-700 text-left">管理員備註</label>
                        <textarea id="modal-remarks" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></textarea>
                    </div>
                    <p id="modal-error" class="text-sm text-red-600 h-4 mt-1"></p>
                </div>`;
            modalButtons.innerHTML = `<button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50">取消</button><button id="modal-dispatch-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700">確認派車</button>`;
            modal.classList.remove('hidden'); modal.classList.add('flex');
            
            const dispatchBtn = document.getElementById('modal-dispatch-btn');
            const driverInput = document.getElementById('modal-driver');
            const errorEl = document.getElementById('modal-error');
            
            dispatchBtn.onclick = async () => {
                const method = document.getElementById('modal-method').value;
                const driver = driverInput.value.trim();
                const phone = document.getElementById('modal-phone').value.trim();
                const remarks = document.getElementById('modal-remarks').value.trim();

                if (!method || !driver) {
                    errorEl.textContent = '請填寫派車方式和司機姓名！';
                    return;
                }
                
                hideModal();
                await updateRequest(id, {
                    status: '已派車',
                    'adminDispatch.status': 'Dispatched',
                    'adminDispatch.method': method,
                    'adminDispatch.driver': driver,
                    'adminDispatch.phone': phone,
                    'adminDispatch.remarks': remarks
                });
                showAlert('派車資訊已更新！');
            };
            document.getElementById('modal-cancel-btn').onclick = hideModal;
        }

        function handleCompleteAction(id) {
             showConfirm('確定要將此申請標記為「已完成」嗎？', async (confirmed) => {
                if (confirmed) {
                    await updateRequest(id, {
                        status: '已完成',
                        'adminDispatch.status': 'Completed'
                    });
                    showAlert('申請已標記為完成。');
                }
            }, '完成派車');
        }

        function handleManagerApproval(docId) {
            const req = state.requests.find(r => r.id === docId);
            if (!req) {
                 showAlert('找不到此申請單。', '錯誤');
                 return;
            }
             if (req.managerApproval?.status !== 'Pending') {
                 showAlert(`此申請已由 ${req.managerApproval.name} 於 ${new Date(req.managerApproval.time.seconds * 1000).toLocaleString()} ${req.managerApproval.status === 'Approved' ? '核准' : '退回'}。`, '已處理');
                 return;
            }
            
            promptManagerAction(async (action, name, remarks) => {
                const newStatus = action === 'approve' ? '已核准 (待派車)' : '已退回';
                const approvalStatus = action === 'approve' ? 'Approved' : 'Rejected';

                await updateRequest(docId, {
                    status: newStatus,
                    'managerApproval.status': approvalStatus,
                    'managerApproval.name': name,
                    'managerApproval.time': serverTimestamp(),
                    'managerApproval.remarks': remarks
                });
                showAlert(`申請已成功${action === 'approve' ? '核准' : '退回'}！狀態更新為：${newStatus}`);
            });
        }
        
        // --- 10. INITIAL SETUP ---

        window.onload = () => {
            initFirebase();
            setActiveTab('apply');
            
            // 檢查 URL 是否有 ID 參數 (主管簽核連結)
            const urlParams = new URLSearchParams(window.location.search);
            const docId = urlParams.get('id');
            if (docId) {
                state.deepLinkedRequestId = docId;
                handleManagerApproval(docId);
            }

            // EVENT LISTENERS
            form.addEventListener('submit', handleSubmit);
            clearBtn.addEventListener('click', clearForm);
            tabButtons.forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));
            adminLoginPromptBtn.addEventListener('click', promptLogin);
            searchBtn.addEventListener('click', handleQuery);
            searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleQuery(); });
            adminSearchInput.addEventListener('input', handleAdminSearch);
            refreshAdminListBtn.addEventListener('click', () => filterAndRenderAdminList(adminSearchInput.value.trim()));
        };

    </script>
</body>
</html>
